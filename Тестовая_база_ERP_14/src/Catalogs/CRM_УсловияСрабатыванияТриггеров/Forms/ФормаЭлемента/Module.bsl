
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Объект.Ссылка = Справочники.CRM_УсловияСрабатыванияТриггеров.ПоРасписанию Тогда
		Отказ = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru='Редактирование данного условия срабатывания триггера запрещено!';en='Editing this triggering condition is prohibited!'"));
		Возврат;
	КонецЕсли;
	
	Элементы.ГруппаОбработкаПуть.Видимость = Не Объект.ИспользоватьСКД;
	Элементы.РедактироватьСхемуКомпоновкиДанных.Видимость = Объект.ИспользоватьСКД;
	ОбъектЗначение = РеквизитФормыВЗначение("Объект");
	АдресФайла = ПоместитьВоВременноеХранилище(ОбъектЗначение.ОбработкаПроверки.Получить(), УникальныйИдентификатор);
	Если ОбъектЗначение.ХранилищеСхемыКомпоновкиДанных.Получить() = Неопределено Тогда
		СформироватьСКДПоОбъекту();
	Иначе	
		АдресСхемыКомпоновкиДанных = ПоместитьВоВременноеХранилище(ОбъектЗначение.ХранилищеСхемыКомпоновкиДанных.Получить(), УникальныйИдентификатор);
		АдресНастроекКомпоновкиДанных = ПоместитьВоВременноеХранилище(ОбъектЗначение.ХранилищеНастроекКомпоновкиДанных.Получить(), УникальныйИдентификатор);
	КонецЕсли;
	
	УстановитьВидимость();
	СобытиеПриИзмененииНаСервере();
	
	СписокИдентификаторов.Добавить(Справочники.ИдентификаторыОбъектовМетаданных.НайтиПоРеквизиту("Имя", "Документы", Справочники.ИдентификаторыОбъектовМетаданных.ПустаяСсылка()));
	СписокИдентификаторов.Добавить(Справочники.ИдентификаторыОбъектовМетаданных.НайтиПоРеквизиту("Имя", "Справочники", Справочники.ИдентификаторыОбъектовМетаданных.ПустаяСсылка()));
	СписокИдентификаторов.Добавить(Справочники.ИдентификаторыОбъектовМетаданных.НайтиПоРеквизиту("Имя", "Задачи", Справочники.ИдентификаторыОбъектовМетаданных.ПустаяСсылка()));
	СписокИдентификаторов.Добавить(Справочники.ИдентификаторыОбъектовМетаданных.НайтиПоРеквизиту("Имя", "БизнесПроцессы", Справочники.ИдентификаторыОбъектовМетаданных.ПустаяСсылка()));
	
	Если Объект.ОбъектыОбработки.Количество() = 0 Тогда
		Объект.ОбъектыОбработки.Добавить();
	КонецЕсли;
	Элементы.ОбъектыОбработки.Видимость = Объект.ОбъектыОбработки.Количество() > 1;
	Элементы.ГруппаОбъектОбработки.Видимость = Объект.ОбъектыОбработки.Количество() = 1;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	#Если ВебКлиент Тогда
		Элементы.РежимОтладки.Видимость = Ложь;
	#КонецЕсли
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	ТекущийОбъект.ОбработкаПроверки = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(АдресФайла));
	ТекущийОбъект.ХранилищеСхемыКомпоновкиДанных = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(АдресСхемыКомпоновкиДанных));
	ТекущийОбъект.ХранилищеНастроекКомпоновкиДанных = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(АдресНастроекКомпоновкиДанных));
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ПутьКОбработкеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	
	ДиалогВыбораФайла.Фильтр = "Файл обработки (*.epf)|*.epf";
	ДиалогВыбораФайла.Расширение = "html";
	
	ДиалогВыбораФайла.Заголовок = НСтр("ru = 'Выберите внешнюю обработку для отладки'");
	ДиалогВыбораФайла.ПредварительныйПросмотр = Ложь;
	ДиалогВыбораФайла.ИндексФильтра = 0;
	ДиалогВыбораФайла.ПолноеИмяФайла = Объект.ПутьКОбработке;
	ДиалогВыбораФайла.ПроверятьСуществованиеФайла = истина;
	
	Если ДиалогВыбораФайла.Выбрать() Тогда
		
		Объект.ПутьКОбработке		= ДиалогВыбораФайла.ПолноеИмяФайла;
		
		// ЗагрузитьОбработку();
		ЭтаФорма.Модифицированность = Истина;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ИспользоватьСКДПриИзменении(Элемент)
	
	Элементы.ГруппаОбработкаПуть.Видимость = Не Объект.ИспользоватьСКД;
	Элементы.РедактироватьСхемуКомпоновкиДанных.Видимость = Объект.ИспользоватьСКД;
	Элементы.НазваниеОбработки.Видимость = НЕ Объект.ИспользоватьСКД;

	УстановитьВидимость();
	
КонецПроцедуры

&НаКлиенте
Процедура СобытиеПриИзменении(Элемент)
	
	Объект.Наименование = Объект.Событие;
	Для каждого Строка из Объект.ОбъектыОбработки Цикл
		Объект.Наименование = Объект.Наименование + ?(Строка.НомерСтроки = 1, ": ", "; ") + Строка.ОбъектОбработки;
	КонецЦикла;
	
	СобытиеПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура РежимОтладкиПриИзменении(Элемент)
	Если НЕ Объект.РежимОтладки И НЕ Объект.ИспользоватьСКД Тогда
		ОписаниеОповещенияЗавершения = Новый ОписаниеОповещения("ВопросЗагрузитьОбработку", ЭтотОбъект);
		ПоказатьВопрос(ОписаниеОповещенияЗавершения, НСтр("ru = 'Загрузить новую обработку действия?'"), РежимДиалогаВопрос.ДаНет);
		
	// ИначеЕсли НЕ Объект.ИспользоватьСКД Тогда
	//	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	//	
	//	ДиалогВыбораФайла.Фильтр = "Файл обработки (*.epf)|*.epf";
	//	ДиалогВыбораФайла.Расширение = "html";
	//	
	//	ДиалогВыбораФайла.Заголовок = НСтр("ru='Выберите файл';en='Choose file'");
	//	ДиалогВыбораФайла.ПредварительныйПросмотр = Ложь;
	//	ДиалогВыбораФайла.ИндексФильтра = 0;
	//	ДиалогВыбораФайла.ПолноеИмяФайла = Объект.ПутьКОбработке;
	//	ДиалогВыбораФайла.ПроверятьСуществованиеФайла = истина;
	//	
	//	Если ДиалогВыбораФайла.Выбрать() Тогда
	//		
	//		Объект.ПутьКОбработке		= ДиалогВыбораФайла.ПолноеИмяФайла;
	//		
	//		// ЗагрузитьОбработку();
	//		ЭтаФорма.Модифицированность = Истина;
	//	КонецЕсли;
	КонецЕсли;
	УстановитьВидимость();

КонецПроцедуры

&НаКлиенте
Процедура ОбъектыОбработкиОбъектОбработкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	фиксНастройки = Новый НастройкиКомпоновкиДанных;
	 
	эОтбор = фиксНастройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	эОтбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Ссылка");
	эОтбор.ВидСравнения = ВидСравненияКомпоновкиДанных.ВИерархии;
	эОтбор.ПравоеЗначение = СписокИдентификаторов;
	эОтбор.Использование = Истина;
	
	эОтбор.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный;
	
	эОтбор = фиксНастройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	эОтбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ПометкаУдаления");
	эОтбор.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	эОтбор.ПравоеЗначение = Ложь;
	эОтбор.Использование = Истина;
	
	эОтбор.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный;
	 
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ФиксированныеНастройки", фиксНастройки);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	
	ОткрытьФорму("Справочник.ИдентификаторыОбъектовМетаданных.ФормаВыбора", ПараметрыФормы, Элемент,,,,, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбъектыОбработкиПриИзменении(Элемент)
	
	Наименование = Строка(Объект.Событие);
	Для каждого Строка из Объект.ОбъектыОбработки Цикл
		Наименование = Наименование + ?(Строка.НомерСтроки = 1, ": ", "; ") + Строка.ОбъектОбработки;
	КонецЦикла;
	Если СтрНайти(Наименование, Объект.Наименование)>0 Тогда
		Объект.Наименование = Наименование;
	КонецЕсли;
	
	СформироватьСКДПоОбъекту();
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьОбъектОбработки(Команда)
	Если Объект.ОбъектыОбработки.Количество() = 1 И ЗначениеЗаполнено(Объект.ОбъектыОбработки[0].ОбъектОбработки) Тогда
		Объект.ОбъектыОбработки.Добавить();
		Элементы.ГруппаОбъектОбработки.Видимость = Ложь;
		Элементы.ОбъектыОбработки.Видимость = Истина;
	Иначе
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не заполнен текущий объект обработки!'"),, "Объект.ОбъектыОбработки");
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВыгрузитьОбработку(Команда)
	ПодготовитьКВыгрузкеОбработкуНаСервере();

	ОбщегоНазначенияКлиент.ПроверитьРасширениеРаботыСФайламиПодключено(
			Новый ОписаниеОповещения(
				"ВыгрузитьОбработкуПродолжение",
				ЭтотОбъект,
				Новый Структура),
			НСтр("ru='Для продолжения необходимо установить расширение для работы с файлами.';en='Continue, install the file operation extension.'"));
	
КонецПроцедуры

&НаКлиенте
Процедура ВыгрузитьОбработкуПродолжение(ПомещенныеФайлы, ДополнительныеПараметры) Экспорт

    ОписаниеОповещения = Новый ОписаниеОповещения("ОбработатьВыборФайла", ЭтаФорма);
	ИмяФайла = Объект.НазваниеОбработки+".epf";
	Файл = Новый ОписаниеПередаваемогоФайла(ИмяФайла, АдресФайла);
	ПолучаемыеФайлы = Новый Массив;
	ПолучаемыеФайлы.Добавить(Файл);
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
	ДиалогОткрытияФайла.Фильтр = "(*.epf)|*.epf";
	ДиалогОткрытияФайла.МножественныйВыбор = Ложь;
	НачатьПолучениеФайлов(ОписаниеОповещения, ПолучаемыеФайлы, ДиалогОткрытияФайла, Истина);
    
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВыборФайла(ПомещенныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если ПомещенныеФайлы = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого ПереданныйФайл Из ПомещенныеФайлы Цикл
		Объект.ПутьКОбработке		= ПереданныйФайл.Имя;
		ЭтаФорма.Модифицированность = Истина;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура РедактироватьСхемуКомпоновкиДанных(Команда)
	
	// Открыть редактор настроек схемы компоновки данных
	ЗаголовокФормыНастройкиСхемыКомпоновкиДанных = НСтр("ru='Настройка шаблона условий проверки ""%1""';en='Setting the test conditions template "" %1""'");
	ЗаголовокФормыНастройкиСхемыКомпоновкиДанных = СтрЗаменить(ЗаголовокФормыНастройкиСхемыКомпоновкиДанных, "%1", Объект.Наименование);
	ОповещениеЗакрытия = Новый ОписаниеОповещения("ПослеРедактированияСхемы", ЭтотОбъект);
	АдресаНастроек = ОткрытьФорму("ОбщаяФорма.УпрощеннаяНастройкаСхемыКомпоновкиДанных",
		Новый Структура(
						"НеПомещатьНастройкиВСхемуКомпоновкиДанных,
						|НеРедактироватьСхемуКомпоновкиДанных,
						|НеНастраиватьУсловноеОформление,
						|НеНастраиватьВыбор,
						|НеНастраиватьПорядок,
						|УникальныйИдентификатор,
						|АдресСхемыКомпоновкиДанных,
						|АдресНастроекКомпоновкиДанных,
						|Заголовок,
						//|ИсточникШаблонов,
						|ИмяШаблонаСКД,
						|ВозвращатьИмяТекущегоШаблонаСКД",
						Истина,
						Ложь,
						Истина,
						Истина,
						Истина,
						УникальныйИдентификатор,
						АдресСхемыКомпоновкиДанных,
						АдресНастроекКомпоновкиДанных,
						ЗаголовокФормыНастройкиСхемыКомпоновкиДанных,
						// ,
						ЗаголовокФормыНастройкиСхемыКомпоновкиДанных,
						Истина), ЭтотОбъект,,,,ОповещениеЗакрытия);
	
	
	
	// УстановитьДоступностьИВидимостьЭлементовФормы(Объект, Элементы, РазмерностьДоступна());
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеРедактированияСхемы(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	Если ЗначениеЗаполнено(РезультатЗакрытия) Тогда
				
		Если РезультатЗакрытия.Свойство("АдресХранилищаНастройкиКомпоновщика") Тогда
			АдресНастроекКомпоновкиДанных = РезультатЗакрытия.АдресХранилищаНастройкиКомпоновщика;
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры	

&НаКлиенте
Процедура ЗагрузитьОбработкуКлиент(Команда)
	
	ОбщегоНазначенияКлиент.ПроверитьРасширениеРаботыСФайламиПодключено(
			Новый ОписаниеОповещения(
				"ЗагрузитьОбработкуПродолжение",
				ЭтотОбъект,
				Новый Структура),
			НСтр("ru='Для продолжения необходимо установить расширение для работы с файлами.';en='Continue, install the file operation extension.'"));

КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьОбработкуПродолжение(ПомещенныеФайлы, ДополнительныеПараметры) Экспорт

	Если ЗначениеЗаполнено(Объект.НазваниеОбработки) Тогда
		ОписаниеОповещенияЗавершения = Новый ОписаниеОповещения("ВопросЗагрузитьОбработку", ЭтотОбъект);
		ПоказатьВопрос(ОписаниеОповещенияЗавершения, НСтр("ru = 'Загрузить новую обработку с диска?'"), РежимДиалогаВопрос.ДаНет);
	Иначе
		ВопросЗагрузитьОбработку(КодВозвратаДиалога.Да, Неопределено);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВопросЗагрузитьОбработку(Результат, ДополнительныеПараметры) Экспорт
	Если Результат = КодВозвратаДиалога.Да Тогда
		ОписаниеОповещения = Новый ОписаниеОповещения("ЗагрузитьОбработкуЗавершение", ЭтаФорма);
		ИмяФайла = Объект.НазваниеОбработки+".epf";
		ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
		ДиалогОткрытияФайла.Фильтр = "(*.epf)|*.epf";
		ДиалогОткрытияФайла.МножественныйВыбор = Ложь;
		НачатьПомещениеФайлов(ОписаниеОповещения, , ДиалогОткрытияФайла, Истина, УникальныйИдентификатор);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьОбработкуЗавершение(Результат, ДополнительныеПараметры) Экспорт
	Если ТипЗнч(Результат) = Тип("Массив") И Результат.Количество() > 0 Тогда
		АдресФайла = Результат[0].Хранение;
		Объект.ПутьКОбработке = Результат[0].Имя;
		ЗагрузитьОбработку();
		ЭтаФорма.Модифицированность = Истина;
		УстановитьВидимость();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьСтандартнуюОбработку(Команда)
	ОписаниеОповещенияЗавершения = Новый ОписаниеОповещения("ВопроcВосстановитьОбработку", ЭтотОбъект);
	ПоказатьВопрос(ОписаниеОповещенияЗавершения, НСтр("ru = 'Восстановить стандартную обработку ?'"), РежимДиалогаВопрос.ДаНет);
КонецПроцедуры

&НаКлиенте
Процедура ВопроcВосстановитьОбработку(Результат, ДополнительныеПараметры) Экспорт
	Если Результат = КодВозвратаДиалога.Да Тогда
		ЗагрузитьСтандартнуюОбработкуНаСервере();
		ЭтаФорма.Модифицированность = Истина;
		Объект.ИспользуетсяСтандартнаяОбработка = Истина;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьВидимость()
	
	Элементы.ПутьКОбработке.Видимость 				 = Объект.РежимОтладки;
	Элементы.ЗагрузитьОбработку.Видимость 			 = НЕ Объект.РежимОтладки;
	Элементы.ВыгрузитьОбработку.Видимость 			 = НЕ Объект.РежимОтладки;
	Элементы.ВыгрузитьОбработку.Доступность 		 = ЗначениеЗаполнено(Объект.НазваниеОбработки);
	Элементы.ЗагрузитьСтандартнуюОбработку.Видимость = Объект.Предопределенный и НЕ Объект.РежимОтладки;
	Элементы.НазваниеОбработки.Видимость 			 = НЕ Объект.ИспользоватьСКД И НЕ Объект.РежимОтладки;
	Элементы.РежимОтладки.Видимость 				 = НЕ Объект.ИспользоватьСКД;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьСписокОбъектовДляОбработки()
	
	СписокОбъектов = Новый СписокЗначений;
	ТаблицаОбъектов = Новый ТаблицаЗначений;
	ТаблицаОбъектов.Колонки.Добавить("Имя");
	ТаблицаОбъектов.Колонки.Добавить("Синоним");
	Если Объект.ТипОбъекта = "Документ" Тогда
		Для Каждого ЭлементВыборки Из Метаданные.Документы Цикл
			Если ОбщегоНазначения.ОбъектМетаданныхДоступенПоФункциональнымОпциям(ЭлементВыборки) Тогда
				Стр = ТаблицаОбъектов.Добавить();
				Стр.Имя = ЭлементВыборки.Имя;
				Стр.Синоним = ЭлементВыборки.Синоним;
			КонецЕсли;
		КонецЦикла;	
	ИначеЕсли Объект.ТипОбъекта = "Справочник" Тогда
		Для Каждого ЭлементВыборки Из Метаданные.Справочники Цикл
			Если ОбщегоНазначения.ОбъектМетаданныхДоступенПоФункциональнымОпциям(ЭлементВыборки) Тогда
				Стр = ТаблицаОбъектов.Добавить();
				Стр.Имя = ЭлементВыборки.Имя;
				Стр.Синоним = ЭлементВыборки.Синоним;
			КонецЕсли;
		КонецЦикла;	
	ИначеЕсли Объект.ТипОбъекта = "Бизнес-процесс" Тогда
		Для Каждого ЭлементВыборки Из Метаданные.БизнесПроцессы Цикл
			Если ОбщегоНазначения.ОбъектМетаданныхДоступенПоФункциональнымОпциям(ЭлементВыборки) Тогда
				Стр = ТаблицаОбъектов.Добавить();
				Стр.Имя = ЭлементВыборки.Имя;
				Стр.Синоним = ЭлементВыборки.Синоним;
			КонецЕсли;
		КонецЦикла;	
	ИначеЕсли Объект.ТипОбъекта = "Задача" Тогда
		Для Каждого ЭлементВыборки Из Метаданные.Задачи Цикл
			Если ОбщегоНазначения.ОбъектМетаданныхДоступенПоФункциональнымОпциям(ЭлементВыборки) Тогда
				Стр = ТаблицаОбъектов.Добавить();
				Стр.Имя = ЭлементВыборки.Имя;
				Стр.Синоним = ЭлементВыборки.Синоним;
			КонецЕсли;
		КонецЦикла;	
	КонецЕсли;	
	ТаблицаОбъектов.Сортировать("Синоним");
	Для Каждого Строка Из  ТаблицаОбъектов Цикл
		СписокОбъектов.Добавить(Строка.Имя, Строка.Синоним);
	КонецЦикла;	
	Возврат СписокОбъектов;
КонецФункции

&НаСервере
Процедура ЗагрузитьОбработку()
	ПараметрыЗащиты = Новый("ОписаниеЗащитыОтОпасныхДействий"+"");
	ПараметрыЗащиты.ПредупреждатьОбОпасныхДействиях = Ложь;
	
	Объект.ИспользуетсяСтандартнаяОбработка = Ложь;
	Обработка =  ВнешниеОбработки.Создать(ВнешниеОбработки.Подключить(АдресФайла,,Ложь, ПараметрыЗащиты), Ложь);
	Объект.НазваниеОбработки = Обработка.Метаданные().Имя;
	Если Объект.Наименование = "" Тогда	
		Объект.Наименование = Обработка.Метаданные().Синоним;
	КонецЕсли;	
КонецПроцедуры	

&НаСервере
Функция ПолучитьДвоичныеДанныеИзХранилища()
	ОбъектПолучения = РеквизитФормыВЗначение("Объект");
	Возврат(ОбъектПолучения.ОбработкаПроверки.Получить());
КонецФункции

&НаКлиенте
Процедура ПодготовитьКВыгрузкеОбработкуНаСервере()
	// ОбъектЗначение = РеквизитФормыВЗначение("Объект");
	ДанныеФайла = ПолучитьДвоичныеДанныеИзХранилища();
	АдресФайла = ПоместитьВоВременноеХранилище(ДанныеФайла, УникальныйИдентификатор);
КонецПроцедуры

&НаСервере
Процедура СформироватьСКДПоОбъекту()
	СКДПроверка = Новый СхемаКомпоновкиДанных();
	
	ИсточникДанных = СКДПроверка.ИсточникиДанных.Добавить();
	ИсточникДанных.Имя = "ИсточникДанныхПроверка";
	ИсточникДанных.ТипИсточникаДанных = "Local";
	
	НаборДанных = СКДПроверка.НаборыДанных.Добавить(Тип("НаборДанныхЗапросСхемыКомпоновкиДанных"));
	НаборДанных.Имя = "НаборДанныхПроверка";
	НаборДанных.ИсточникДанных = "ИсточникДанныхПроверка";
	
	НаборДанных.Запрос = ПолучитьТекстЗапросаПоОбъекту();
	
	НастройкиСКД = 	СКДПроверка.НастройкиПоУмолчанию;
	
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных();
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СКДПроверка));
	КомпоновщикНастроек.ЗагрузитьНастройки(НастройкиСКД);
		
	АдресНастроекКомпоновкиДанных = ПоместитьВоВременноеХранилище(НастройкиСКД, УникальныйИдентификатор);
	АдресСхемыКомпоновкиДанных = ПоместитьВоВременноеХранилище(СКДПроверка, УникальныйИдентификатор);
	
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных();
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СКДПроверка));
	КомпоновщикНастроек.ЗагрузитьНастройки(НастройкиСКД);
	КомпоновщикНастроек.Восстановить();
КонецПроцедуры	

&НаСервере
Функция ПолучитьТекстЗапросаПоОбъекту()
	Если Объект.ОбъектыОбработки.Количество() = 0 Тогда
		Возврат "ВЫБРАТЬ
		|	ИСТИНА КАК Ссылка";
	ИначеЕсли Объект.ОбъектыОбработки.Количество() = 1 Тогда	
		МетаданныеОбъекта = ОбщегоНазначения.ОбъектМетаданныхПоИдентификатору(Объект.ОбъектыОбработки[0].ОбъектОбработки);
		
		ТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	"+МетаданныеОбъекта.Имя+".Ссылка";
		
		Для Каждого РеквизитОбъекта Из МетаданныеОбъекта.СтандартныеРеквизиты Цикл
			Если РеквизитОбъекта.Имя = "Ссылка" Тогда Продолжить конецЕсли;
			ТекстЗапроса = ТекстЗапроса + ",
			|"+МетаданныеОбъекта.Имя+"."+РеквизитОбъекта.Имя;
		КонецЦикла;
		Для Каждого РеквизитОбъекта Из МетаданныеОбъекта.Реквизиты Цикл
			ТекстЗапроса = ТекстЗапроса + ",
			|"+МетаданныеОбъекта.Имя+"."+РеквизитОбъекта.Имя;
		КонецЦикла;	
			
		ТекстЗапроса = ТекстЗапроса + "
		| ИЗ "+Объект.ОбъектыОбработки[0].ОбъектОбработки.ПолноеИмя+" КАК "+МетаданныеОбъекта.Имя+"
		|ГДЕ
		|	"+МетаданныеОбъекта.Имя+".Ссылка = &Ссылка";
	Иначе	
		НачалоЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ";
		ТекстЗапроса = "";
		Для Каждого Строка из Объект.ОбъектыОбработки Цикл
			
			МетаданныеОбъекта = ОбщегоНазначения.ОбъектМетаданныхПоИдентификатору(Строка.ОбъектОбработки);
			ТекстЗапроса = ТекстЗапроса + НачалоЗапроса + "
			|	"+МетаданныеОбъекта.Имя+".Ссылка
			| ИЗ "+Строка.ОбъектОбработки.ПолноеИмя+" КАК "+МетаданныеОбъекта.Имя+"
			|ГДЕ
			|	"+МетаданныеОбъекта.Имя+".Ссылка = &Ссылка";
			НачалоЗапроса = "
			|Объединить ВСЕ
			|ВЫБРАТЬ
			|";
		КонецЦикла;
	КонецЕсли;
	Возврат ТекстЗапроса;
КонецФункции	

&НаСервере
Процедура СобытиеПриИзмененииНаСервере()
	
	Если Объект.Событие = Перечисления.CRM_СобытияТриггеров.ВыполнитьПереопределяемуюКоманду
	ИЛИ Объект.Событие = Перечисления.CRM_СобытияТриггеров.ОбработкаОповещения
	ИЛИ Объект.Событие = Перечисления.CRM_СобытияТриггеров.ПередЗаписьюНаСервере
	ИЛИ Объект.Событие = Перечисления.CRM_СобытияТриггеров.ПослеЗаписиНаСервере
	ИЛИ Объект.Событие = Перечисления.CRM_СобытияТриггеров.ПриСозданииНаСервере Тогда
		
		Объект.ИспользоватьСКД									= Истина;
		Объект.РежимОтладки										= Ложь;
		Элементы.ИспользоватьСКД.Видимость						= Ложь;
		Элементы.ГруппаОбработкаПуть.Видимость					= Ложь;
		Элементы.НазваниеОбработки.Видимость					= Ложь;
		Элементы.РедактироватьСхемуКомпоновкиДанных.Видимость	= Ложь;
	Иначе
		Элементы.ИспользоватьСКД.Видимость						= Истина;
		Элементы.РедактироватьСхемуКомпоновкиДанных.Видимость	= Объект.ИспользоватьСКД;
		УстановитьВидимость();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьСтандартнуюОбработкуНаСервере()
	
	Если Объект.ИмяПредопределенныхДанных = "ПроверкаСвязиСИнтересом" ИЛИ Объект.ИмяПредопределенныхДанных = "ВходящийТелефонныйЗвонокПоИнтересуКлиента"
		ИЛИ Объект.ИмяПредопределенныхДанных = "ВходящееЭлектронноеПисьмоПоИнтересуКлиента" ИЛИ Объект.ИмяПредопределенныхДанных = "ВходящееСообщениеЧатаПоИнтересуКлиента" Тогда	
		АдресФайла = ПоместитьВоВременноеХранилище(Справочники.CRM_УсловияСрабатыванияТриггеров.ПолучитьМакет("ПроверкаСвязиСИнтересом"), УникальныйИдентификатор);
		Объект.НазваниеОбработки = "ПроверкаСвязиСИнтересом";
	ИначеЕсли Объект.ИмяПредопределенныхДанных = "ПисьмоОтНовогоКлиента" Тогда	
		АдресФайла = ПоместитьВоВременноеХранилище(Справочники.CRM_УсловияСрабатыванияТриггеров.ПолучитьМакет("ПисьмоОтНовогоКлиента"), УникальныйИдентификатор);
		Объект.НазваниеОбработки = "ПисьмоОтНовогоКлиента";	
	ИначеЕсли ЗначениеЗаполнено(Объект.ИмяПредопределенныхДанных) Тогда	
		ИмяМакета = "CRM_Модуль_"+Объект.ИмяПредопределенныхДанных;
		Если Метаданные.Справочники.CRM_УсловияСрабатыванияТриггеров.Макеты.Найти(ИмяМакета) = Неопределено Тогда
			ИмяМакета = Объект.ИмяПредопределенныхДанных;
		КонецЕсли;
		АдресФайла = ПоместитьВоВременноеХранилище(Справочники.CRM_УсловияСрабатыванияТриггеров.ПолучитьМакет(ИмяМакета), УникальныйИдентификатор);
		Объект.НазваниеОбработки = Объект.ИмяПредопределенныхДанных;	
	КонецЕсли;	
	
КонецПроцедуры

#КонецОбласти 




