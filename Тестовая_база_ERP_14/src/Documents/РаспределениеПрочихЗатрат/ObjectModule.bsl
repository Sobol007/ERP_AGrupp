#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(ЭтотОбъект);
	
	Если ЗначениеЗаполнено(НаправлениеДеятельности) Тогда
		Для Каждого Строка Из Списание Цикл
			Строка.НаправлениеДеятельности = НаправлениеДеятельности;
		КонецЦикла;
	КонецЕсли;
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		ВзаиморасчетыСервер.ЗаполнитьИдентификаторыСтрокВТабличнойЧасти(Списание);
	КонецЕсли;
		
	ПроведениеСерверУТ.УстановитьРежимПроведения(ЭтотОбъект, РежимЗаписи, РежимПроведения);

	ВсегоДолейСтоимости = ДоляСтоимостиНаПроизводство + ДоляСтоимостиНаНЗП + ДоляСтоимостиНаСтатьи;
	
	Если Не НаправлениеРаспределения = Перечисления.НаправлениеРаспределенияПоПодразделениям.Указанные
		И Не ПодразделенияУказаныВручную Тогда
		
		ОтборПоПодразделениям.Очистить();
		// Кеширование подразделений.
		ПодразделенияПоНаправлению = Документы.РаспределениеПрочихЗатрат.ПодразделенияПоНаправлению(
			Подразделение, НаправлениеРаспределения);
		Для Каждого ПодразделениеОтбора Из ПодразделенияПоНаправлению Цикл
			
			НоваяПозицияОтбора = ОтборПоПодразделениям.Добавить();
			НоваяПозицияОтбора.Подразделение = ПодразделениеОтбора;
			
		КонецЦикла;
		
	КонецЕсли;
	
	ДополнительныеСвойства.Вставить("ЭтоНовый", ЭтоНовый());
	ДополнительныеСвойства.Вставить("РежимЗаписи", РежимЗаписи);
	
	РаспределениеПрочихЗатратЛокализация.ПередЗаписью(ЭтотОбъект, Отказ, РежимЗаписи, РежимПроведения);

КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Если Не Отказ И Не ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		РегистрыСведений.РеестрДокументов.ИнициализироватьИЗаписатьДанныеДокумента(Ссылка, ДополнительныеСвойства, Отказ);
	КонецЕсли;
	РаспределениеПрочихЗатратЛокализация.ПриЗаписи(ЭтотОбъект, Отказ);

КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("Структура") Тогда
		
		Если ДанныеЗаполнения.Свойство("НастройкаРаспределения")
			И ЗначениеЗаполнено(ДанныеЗаполнения.НастройкаРаспределения) Тогда
			
			Если ТипЗнч(ДанныеЗаполнения.НастройкаРаспределения) = Тип("СправочникСсылка.ПравилаРаспределенияРасходов") Тогда
				
				ТекстЗапроса = 
					"ВЫБРАТЬ
					|	ПравилаРаспределения.РаспределятьПоПартиям КАК РаспределятьПоПартиям,
					|	ПравилаРаспределения.РаспределятьНаСтатьи КАК РаспределятьНаСтатьи,
					|	ПравилаРаспределения.БазаРаспределенияПоПартиям КАК БазаРаспределенияПоПартиям,
					|	ПравилаРаспределения.БазаРаспределенияПоПодразделениям КАК БазаРаспределенияПоПодразделениям,
					|	ПравилаРаспределения.НаправлениеРаспределения КАК НаправлениеРаспределения,
					|	ПравилаРаспределения.УточнятьПартииВДокументе КАК ПартииУказаныВручную,
					|	ПравилаРаспределения.ДоляСтоимостиНаПроизводство КАК ДоляСтоимостиНаПроизводство,
					|	ПравилаРаспределения.ДоляСтоимостиНаСтатьи КАК ДоляСтоимостиНаСтатьи,
					|	ПравилаРаспределения.Показатель КАК Показатель,
					|	ПравилаРаспределения.РаспределятьПоПодразделениям КАК РаспределятьПоПодразделениям,
					|	ПравилаРаспределения.ПодразделенияУказаныВручную КАК ПодразделенияУказаныВручную,
					|	ПравилаРаспределения.ОтборПоПодразделениям.(
					|		Подразделение КАК Подразделение
					|	) КАК ОтборПоПодразделениям,
					|	ПравилаРаспределения.ОтборПоМатериалам.(
					|		Материал КАК Материал
					|	) КАК ОтборПоМатериалам,
					|	ПравилаРаспределения.ОтборПоВидамРабот.(
					|		ВидРабот КАК ВидРабот
					|	) КАК ОтборПоВидамРабот,
					|	ПравилаРаспределения.ОтборПоГруппамПродукции.(
					|		ГруппаПродукции КАК ГруппаПродукции
					|	) КАК ОтборПоГруппамПродукции,
					|	ПравилаРаспределения.ОтборПоПродукции.(
					|		Продукция КАК Продукция
					|	) КАК ОтборПоПродукции,
					|	ПравилаРаспределения.Подразделения.(
					|		Ссылка КАК Ссылка,
					|		НомерСтроки КАК НомерСтроки,
					|		Подразделение КАК Подразделение,
					|		ДоляСтоимости КАК ДоляСтоимости
					|	) КАК ПоБазе,
					|	ПравилаРаспределения.Списание.(
					|		Ссылка КАК Ссылка,
					|		НомерСтроки КАК НомерСтроки,
					|		СтатьяРасходов КАК СтатьяРасходов,
					|		АналитикаРасходов КАК АналитикаРасходов,
					|		ДоляСтоимости КАК ДоляСтоимости,
					|		АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
					|		СчетУчета КАК СчетУчета,
					|		Субконто1 КАК Субконто1,
					|		Субконто2 КАК Субконто2,
					|		Субконто3 КАК Субконто3,
					|		НаправлениеДеятельности КАК НаправлениеДеятельности,
					|		ИдентификаторСтроки КАК ИдентификаторСтроки,
					|		Подразделение КАК Подразделение
					|	) КАК Списание
					|ИЗ
					|	Справочник.ПравилаРаспределенияРасходов КАК ПравилаРаспределения
					|ГДЕ
					|	ПравилаРаспределения.Ссылка = &Ссылка";
				
			Иначе
				
				ТекстЗапроса = 
					"ВЫБРАТЬ
					|	ПравилаРаспределения.РаспределятьПоПартиям КАК РаспределятьПоПартиям,
					|	ПравилаРаспределения.РаспределятьНаСтатьи КАК РаспределятьНаСтатьи,
					|	ПравилаРаспределения.БазаРаспределенияПоПартиям КАК БазаРаспределенияПоПартиям,
					|	ПравилаРаспределения.БазаРаспределенияПоПодразделениям КАК БазаРаспределенияПоПодразделениям,
					|	ПравилаРаспределения.СтатьяКалькуляции КАК СтатьяКалькуляции,
					|	ПравилаРаспределения.НаправлениеРаспределения КАК НаправлениеРаспределения,
					|	ПравилаРаспределения.ПартииУказаныВручную КАК ПартииУказаныВручную,
					|	ПравилаРаспределения.ДоляСтоимостиНаПроизводство КАК ДоляСтоимостиНаПроизводство,
					|	ПравилаРаспределения.ДоляСтоимостиНаСтатьи КАК ДоляСтоимостиНаСтатьи,
					|	ПравилаРаспределения.Показатель КАК Показатель,
					|	ПравилаРаспределения.РаспределятьПоПодразделениям КАК РаспределятьПоПодразделениям,
					|	ПравилаРаспределения.ПодразделенияУказаныВручную КАК ПодразделенияУказаныВручную,
					|	ПравилаРаспределения.ОтборПоПодразделениям.(
					|		Подразделение КАК Подразделение
					|	) КАК ОтборПоПодразделениям,
					|	ПравилаРаспределения.ОтборПоМатериалам.(
					|		Материал КАК Материал
					|	) КАК ОтборПоМатериалам,
					|	ПравилаРаспределения.ОтборПоВидамРабот.(
					|		ВидРабот КАК ВидРабот
					|	) КАК ОтборПоВидамРабот,
					|	ПравилаРаспределения.ОтборПоГруппамПродукции.(
					|		ГруппаПродукции КАК ГруппаПродукции
					|	) КАК ОтборПоГруппамПродукции,
					|	ПравилаРаспределения.ОтборПоПродукции.(
					|		Продукция КАК Продукция
					|	) КАК ОтборПоПродукции,
					|	ПравилаРаспределения.Списание.(
					|		Ссылка КАК Ссылка,
					|		НомерСтроки КАК НомерСтроки,
					|		СтатьяРасходов КАК СтатьяРасходов,
					|		АналитикаРасходов КАК АналитикаРасходов,
					|		ДоляСтоимости КАК ДоляСтоимости,
					|		АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
					|		СчетУчета КАК СчетУчета,
					|		Субконто1 КАК Субконто1,
					|		Субконто2 КАК Субконто2,
					|		Субконто3 КАК Субконто3,
					|		НаправлениеДеятельности КАК НаправлениеДеятельности,
					|		ИдентификаторСтроки КАК ИдентификаторСтроки,
					|		Подразделение КАК Подразделение
					|	) КАК Списание,
					|	ПравилаРаспределения.ПоБазе.(
					|		Ссылка КАК Ссылка,
					|		НомерСтроки КАК НомерСтроки,
					|		Подразделение КАК Подразделение,
					|		СтатьяКалькуляции КАК СтатьяКалькуляции,
					|		ДоляСтоимости КАК ДоляСтоимости
					|	) КАК ПоБазе
					|ИЗ
					|	Документ.РаспределениеПрочихЗатрат КАК ПравилаРаспределения
					|ГДЕ
					|	ПравилаРаспределения.Ссылка = &Ссылка";
				
			КонецЕсли;
			
			Запрос = Новый Запрос;
			Запрос.Текст = ТекстЗапроса;
			
			Запрос.УстановитьПараметр("Ссылка", ДанныеЗаполнения.НастройкаРаспределения);
			
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				
				ЗаполнитьЗначенияСвойств(ЭтотОбъект, Выборка, , 
					"ОтборПоМатериалам, ОтборПоПодразделениям, ОтборПоВидамРабот, ОтборПоГруппамПродукции, ОтборПоПродукции, Списание, ПоБазе");
			
				Если НаправлениеРаспределения = Перечисления.НаправлениеРаспределенияПоПодразделениям.Указанные Тогда
					ОтборПоПодразделениям.Загрузить(Выборка.ОтборПоПодразделениям.Выгрузить());
				Иначе
					ОтборПоПодразделениям.Очистить();
				КонецЕсли;
				
				ОтборПоМатериалам.Загрузить(Выборка.ОтборПоМатериалам.Выгрузить());
				ОтборПоГруппамПродукции.Загрузить(Выборка.ОтборПоГруппамПродукции.Выгрузить());
				ОтборПоПродукции.Загрузить(Выборка.ОтборПоПродукции.Выгрузить());
				ОтборПоВидамРабот.Загрузить(Выборка.ОтборПоВидамРабот.Выгрузить());
				
				Списание.Загрузить(Выборка.Списание.Выгрузить());
				ПоБазе.Загрузить(Выборка.ПоБазе.Выгрузить());
				
			КонецЦикла;
			
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеЗаполнения);
				
	КонецЕсли;
	
	Ответственный = Пользователи.ТекущийПользователь();
	
	РаспределениеПрочихЗатратЛокализация.ОбработкаЗаполнения(ЭтотОбъект, ДанныеЗаполнения, СтандартнаяОбработка);

КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// Инициализация дополнительных свойств для проведения документа
	ПроведениеСерверУТ.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства, РежимПроведения);
	
	// Инициализация данных документа
	Документы.РаспределениеПрочихЗатрат.ИнициализироватьДанныеДокумента(Ссылка, ДополнительныеСвойства);
	
	// Подготовка наборов записей
	ПроведениеСерверУТ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
	
	// Регистрация задания к расчету себестоимости.
	РегистрыСведений.ЗаданияКРасчетуСебестоимости.СоздатьЗаписьРегистра(Дата, Ссылка, Организация);
	
	РегистрыСведений.РеестрДокументов.ЗаписатьДанныеДокумента(Ссылка, ДополнительныеСвойства, Отказ);
	
	//++ НЕ УТКА
	МеждународныйУчетПроведениеСервер.ЗарегистрироватьКОтражению(ЭтотОбъект, ДополнительныеСвойства, Движения, Отказ);
	//-- НЕ УТКА
	
	// Запись наборов записей
	РаспределениеПрочихЗатратЛокализация.ОбработкаПроведения(ЭтотОбъект, Отказ, РежимПроведения);

	ПроведениеСерверУТ.ЗаписатьНаборыЗаписей(ЭтотОбъект);
	ПроведениеСерверУТ.СформироватьЗаписиРегистровЗаданий(ЭтотОбъект);

	ПроведениеСерверУТ.ОчиститьДополнительныеСвойстваДляПроведения(ДополнительныеСвойства);
	
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)

	ПроведениеСерверУТ.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства);

	ПроведениеСерверУТ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);

	РаспределениеПрочихЗатратЛокализация.ОбработкаУдаленияПроведения(ЭтотОбъект, Отказ);

	ПроведениеСерверУТ.ЗаписатьНаборыЗаписей(ЭтотОбъект);
	ПроведениеСерверУТ.СформироватьЗаписиРегистровЗаданий(ЭтотОбъект);

	ПроведениеСерверУТ.ОчиститьДополнительныеСвойстваДляПроведения(ДополнительныеСвойства);

КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	МассивНепроверяемыхРеквизитов = Новый Массив;
	
	Если Не РаспределятьПоПартиям И Не РаспределятьПоПодразделениям
		И Не РаспределятьНаСтатьи И Не ОставитьВНЗП Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				НСтр("ru = 'Не выбрано ни одно направление распределения статьи расходов.';
					|en = 'No direction of expense item allocation is selected.'"),
				,
				"НаправлениеРаспределения",
				,
				Отказ);
	КонецЕсли;
		
	Если РаспределятьНаСтатьи И Списание.Количество() = 0 Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'Не введено ни одной строки в список ""Другие статьи""';
				|en = 'No lines entered in the Other items list'"),
			,
			"Списание",
			,
			Отказ);
	КонецЕсли;
	
	РеквизитТЧСписание = Новый Массив;
	СтруктураТЧСписание = Новый Структура;
	СтруктураТЧСписание.Вставить("Списание", "СтатьяРасходов, АналитикаРасходов");
	РеквизитТЧСписание.Добавить(СтруктураТЧСписание);
	ПланыВидовХарактеристик.СтатьиРасходов.ПроверитьЗаполнениеАналитик(
		ЭтотОбъект, РеквизитТЧСписание, МассивНепроверяемыхРеквизитов, Отказ);
		
	Если НаправлениеРаспределения = Перечисления.НаправлениеРаспределенияПоПодразделениям.Указанные
		И ОтборПоПодразделениям.Количество() = 0 Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				НСтр("ru = 'Не заданы подразделения в отборе.';
					|en = 'Departments are not specified in filter.'"),
				,
				"НаправлениеРаспределения",
				,
				Отказ);
	КонецЕсли;
	
	Если Не РаспределятьПоПартиям 
		Или ПартииУказаныВручную Или ПодразделенияУказаныВручную Тогда
		МассивНепроверяемыхРеквизитов.Добавить("СтатьяКалькуляции");
	КонецЕсли;
	
	Если ПартииУказаныВручную 
		И ПартииПроизводства.Количество() = 0
		И ВыпускиБезРаспоряжения.Количество() = 0
		И Вручную.Количество() = 0 Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'Не указаны партии.';
				|en = 'Batches are not specified.'"),,,,	Отказ);
			
	КонецЕсли;
	
	Если Не (РаспределятьПоПартиям И (РаспределятьНаСтатьи Или ОставитьВНЗП)
		И Не (ПартииУказаныВручную Или ПодразделенияУказаныВручную)) Тогда
		МассивНепроверяемыхРеквизитов.Добавить("ДоляСтоимостиНаПроизводство");
	КонецЕсли;
	
	Если Не РаспределятьПоПодразделениям Или 
		(РаспределятьПоПодразделениям И ПодразделенияУказаныВручную) Тогда
		МассивНепроверяемыхРеквизитов.Добавить("БазаРаспределенияПоПодразделениям");
	КонецЕсли;
	
	Если Не РаспределятьНаСтатьи Тогда
		МассивНепроверяемыхРеквизитов.Добавить("Списание");
	КонецЕсли;
	
	Если Не ПодразделенияУказаныВручную Тогда
		МассивНепроверяемыхРеквизитов.Добавить("ПоБазе");
	КонецЕсли;
	
	Если Не (БазаРаспределенияПоПодразделениям = Перечисления.ТипыБазыРаспределенияРасходов.ВводитсяЕжемесячно
		Или БазаРаспределенияПоПодразделениям = Перечисления.ТипыБазыРаспределенияРасходов.ВводитсяПриИзменении) Тогда
		МассивНепроверяемыхРеквизитов.Добавить("Показатель");
	КонецЕсли;
	
	Если Не РаспределятьПоПартиям Или ПартииУказаныВручную Тогда
		МассивНепроверяемыхРеквизитов.Добавить("БазаРаспределенияПоПартиям");
	КонецЕсли;
	
	Если Не ОставитьВНЗП Тогда
		МассивНепроверяемыхРеквизитов.Добавить("ДоляСтоимостиНаНЗП");
	КонецЕсли;
	
	Если БазаРаспределенияПоПартиям = Перечисления.ТипыБазыРаспределенияРасходов.СуммаМатериальныхИТрудозатрат 
		И Не УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ПартионныйУчетВерсии22(Дата) Тогда		
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'База распределение ""Сумма материальных и трудозатрат"" доступна только для партионного учета 2.2.';
				|en = 'The ""Amount of material and labor costs"" allocation base is available only for batch accounting 2.2.'"),
			ОбщегоНазначенияУТ.КлючДанныхДляСообщенияПользователю(Ссылка),
			"ПравилоРаспределенияПоЭтапам",
			"Объект",
			Отказ);
			
	КонецЕсли;
	
	ОбщегоНазначения.УдалитьНепроверяемыеРеквизитыИзМассива(ПроверяемыеРеквизиты, МассивНепроверяемыхРеквизитов);
	
	РаспределениеПрочихЗатратЛокализация.ОбработкаПроверкиЗаполнения(ЭтотОбъект, Отказ, ПроверяемыеРеквизиты);

КонецПроцедуры

#КонецОбласти

#КонецЕсли
