////////////////////////////////////////////////////////////////////////////////
//
// ЗатратыСервер: Распределение производственных затрат и затрат незавершенного производства.
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Процедура выполняет запись движений производственных затрат.
//
// Параметры:
//	ДополнительныеСвойства - Структура - структура с данными для записи
//	Движения - Движения - Движения регистра "Производственные затраты"
//	Отказ - Булево - Признак отказа от записи движений.
//
Процедура ОтразитьМатериалыИРаботыВПроизводстве(ДополнительныеСвойства, Движения, Отказ) Экспорт
	
	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаМатериалыИРаботыВПроизводстве;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Набор = Движения.МатериалыИРаботыВПроизводстве;
	Набор.Записывать = Истина;
	Набор.Загрузить(Таблица);
	
КонецПроцедуры

// Процедура выполняет запись движений партий производственных затрат.
//
// Параметры:
//	ДополнительныеСвойства - Структура - структура с данными для записи
//	Движения - Движения - Движения регистра "Партии производственных затрат"
//	Отказ - Булево - Признак отказа от записи движений.
//
Процедура ОтразитьПартииПроизводственныхЗатрат(ДополнительныеСвойства, Движения, Отказ) Экспорт

	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПартииПроизводственныхЗатрат;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Набор = Движения.ПартииПроизводственныхЗатрат;
	Набор.Записывать = Истина;
	Набор.Загрузить(Таблица);
	
КонецПроцедуры

// Процедура проверяет дату документа на соответствие дате перехода на партионный учет версии 2.2.
// Проверка выполняется для документов нового производства.
//
// Параметры:
//	Объект - ДокументОбъект.ЭтапПроизводства2_2, ДокументОбъект.ДвижениеПродукцииИМатериалов - проверяемый документ,
//	Дата - Дата - дата, на которую выполняется проверка,
//	Отказ - Булево - устанавливается в ИСТИНА, если дата перехода на новый партионный учет больше переданной даты.
//
Процедура ПроверитьИспользованиеПартионногоУчета22(Объект, Дата, Отказ) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Дата) Тогда
		Возврат;
	КонецЕсли;
	
	ДатаПереходаНаПартионныйУчетВерсии22 = УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ДатаПереходаНаПартионныйУчетВерсии22();
	
	ТекстОшибки = Неопределено;
	
	Если НЕ УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ПартионныйУчетВерсии22() Тогда
		
		ТекстОшибки = НСтр("ru = 'Для операций, доступных с версии 2.2, требуется установить соответствующий режим партионного учета.';
							|en = 'For operations available from version 2.2, set a corresponding batch accounting mode.'");
		
	ИначеЕсли ДатаПереходаНаПартионныйУчетВерсии22 > НачалоМесяца(Дата) Тогда
		
		ТекстОшибки = НСтр("ru = 'Регистрация операций, доступных с версии 2.2, раньше даты перехода на партионный учет версии 2.2 недоступна.
								|Требуется изменить дату операции (%1) или дату перехода на партионный учет 2.2 (%2).';
								|en = 'Cannot register transactions available from version 2.2 earlier than date of transfer to batch accounting of version 2.2.
								|Change transaction date (%1) or date of migration to batch accounting 2.2 (%2).'");
		ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ТекстОшибки,
			Формат(Дата, "ДЛФ=D"),
			Формат(ДатаПереходаНаПартионныйУчетВерсии22, "ДЛФ=D"));
			
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки, Объект,,, Отказ);
	КонецЕсли;
	
КонецПроцедуры

//++ НЕ УТ

// Устанавливает параметры выбора для правила распределения в зависимости от способа учета производственных затрат.
//
// Параметры:
//	Подразделение - СправочникСсылка.СтруктураПредприятия - подразделение, в котором выполняется распределение
//	ВариантРаспределения - ПеречислениеСсылка.СпособыРаспределенияСтатейРасходов - вариант распределения
//	ЭлементПравилоРаспределения - ПолеФормы - Поле для ввода правила распределения
//	Назначение - СправочникСсылка.Назначения - Назначение расхода.
//
Процедура НастроитьПараметрыВыбораПравилРаспределения(Подразделение, ВариантРаспределения, ЭлементПравилоРаспределения, Назначение) Экспорт
	
	МассивПараметров = Новый Массив;
	МассивПараметров.Добавить(Новый ПараметрВыбора("Отбор.НазначениеПравила", Назначение));
	
	Если ЗначениеЗаполнено(Подразделение)
		И (ВариантРаспределения = Перечисления.СпособыРаспределенияСтатейРасходов.ПоЭтапамПоПравилуВДанномПодразделении Или ВариантРаспределения = Неопределено) Тогда
		
		Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Подразделение, "ПроизводствоПоЗаказам, ИспользуетсяСписаниеЗатратНаВыпуск");
		
		Если Не Реквизиты.ПроизводствоПоЗаказам И Не Реквизиты.ИспользуетсяСписаниеЗатратНаВыпуск Тогда
			
			МассивБазРаспределения = Новый Массив;
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.КоличествоПродукции);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.ВесПродукции);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.ОбъемПродукции);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала);
			МассивБазРаспределения.Добавить(Перечисления.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов);
			
			МассивПараметров.Добавить(Новый ПараметрВыбора("Отбор.БазаРаспределения", Новый ФиксированныйМассив(МассивБазРаспределения)));
			
		КонецЕсли;
		
	КонецЕсли;
	
	ЭлементПравилоРаспределения.ПараметрыВыбора = Новый ФиксированныйМассив(МассивПараметров);
	
КонецПроцедуры

// Функция формирует таблицу выполненных этапов производства.
//
// Параметры:
//	Параметры - Структура - Структура передаваемых параметров.
//
// Возвращаемое значение:
//	ТаблицаЗначений - таблица этапов производства.
//
Функция ЭтапыПроизводстваДляРаспределенияЗатрат(Параметры) Экспорт
	
	Запрос = Новый Запрос("
	//++ НЕ УТКА
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Распоряжение КАК Распоряжение,
	|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция
	|ПОМЕСТИТЬ втВыполненныеЗаказы
	|ИЗ
	|	РегистрНакопления.ЭтапыПроизводства.Обороты КАК ДД
	|ГДЕ
	|	ЕСТЬNULL(ДД.ЗапланированоЗаказомОборот, 0) = ЕСТЬNULL(ДД.ВыполненоОборот, 0) + ЕСТЬNULL(ДД.БракОборот, 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Распоряжение КАК Распоряжение,
	|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция
	|ПОМЕСТИТЬ втДатыЗавершения
	|ИЗ
	|	РегистрНакопления.ЭтапыПроизводства КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втВыполненныеЗаказы КАК втВыполненныеЗаказы
	|		ПО ДД.Распоряжение = втВыполненныеЗаказы.Распоряжение
	|		И ДД.КодСтрокиПродукция = втВыполненныеЗаказы.КодСтрокиПродукция
	|ГДЕ
	|	ДД.Регистратор Ссылка Документ.МаршрутныйЛистПроизводства
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция
	|
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(КОНЕЦПЕРИОДА(ДД.ОкончаниеЗавершающегоБуфера, МЕСЯЦ)) < &ПериодНачало
	|
	|;
	//-- НЕ УТКА
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Распоряжение.Распоряжение КАК ЗаказНаПроизводство,
	|	ДД.Распоряжение.КодСтроки КАК КодСтроки
	|ПОМЕСТИТЬ втВыпускиПродукции
	|ИЗ
	|	РегистрНакопления.ВыпускПродукции.Обороты(&ПериодНачало, &ПериодОкончание) КАК ДД
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|;
	|
	|ВЫБРАТЬ
	|	Заказы.ЗаказПоставщику КАК ЗаказПоставщику,
	|	Заказы.Номенклатура КАК Номенклатура,
	|	Заказы.КодСтроки КАК КодСтроки,
	|	Заказы.КОформлениюНачальныйОстаток КАК НачальныйОстаток,
	|	Заказы.КОформлениюПриход КАК Приход
	|ПОМЕСТИТЬ ВТВТЗаказыПереработчикамВрем
	|ИЗ
	|	РегистрНакопления.ЗаказыПоставщикам.ОстаткиИОбороты(&ПериодНачало,
	|									   &ПериодОкончание, , ,
	|									   ЗаказПоставщику ССЫЛКА Документ.ЗаказПереработчику
	|									   И (ЗаказПоставщику = &Заказ ИЛИ &ПоВсемЗаказам)) КАК Заказы
	|ГДЕ
	|	НЕ &ПартионныйУчетВерсии22
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Заказы.ЗаказПоставщику
	|;
	|
	|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Таб.ЗаказПоставщику,
	|	Таб.КодСтроки
	|
	|ПОМЕСТИТЬ ВТЗаказыПереработчикам
	|
	|ИЗ ВТВТЗаказыПереработчикамВрем КАК Таб
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику КАК ДокЗаказ
	|	ПО Таб.ЗаказПоставщику = ДокЗаказ.Ссылка
	|		И ДокЗаказ.Организация = &Организация
	|		И (ДокЗаказ.Подразделение = &Подразделение ИЛИ &ПоВсемПодразделениям)
	|		И (ДокЗаказ.Назначение = &Назначение ИЛИ &ПоВсемНазначениям)
	|		И (ДокЗаказ.Назначение.НаправлениеДеятельности = &НаправлениеДеятельности ИЛИ &ПоВсемНаправлениямДеятельности)
	|		И (&НеТолькоТекущийМесяц ИЛИ Таб.НачальныйОстаток = 0)
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|	ПО Таб.Номенклатура = СпрНоменклатура.Ссылка
	|		И (&ПоВсемГруппамПродукции ИЛИ СпрНоменклатура.ГруппаАналитическогоУчета = &ГруппаПродукции)
	|ГДЕ
	|	НЕ &ПартионныйУчетВерсии22
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Таб.ЗаказПоставщику,
	|	Таб.КодСтроки
	|
	|;
	|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Заказы.ЗаказПоставщику КАК ЗаказНаПроизводство,
	|	Заказы.КодСтроки КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	СУММА(ВЫБОР 
	|				КОГДА Заказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА Заказы.КОформлению
	|				ИНАЧЕ 0
	|			   КОНЕЦ) КАК ЗапланированоЗаказом,
	|	СУММА(ВЫБОР 
	|				КОГДА Заказы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА Заказы.КОформлению
	|				ИНАЧЕ 0
	|			   КОНЕЦ) КАК Выполнено
	|ИЗ
	|	РегистрНакопления.ЗаказыПоставщикам КАК Заказы
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЗаказыПереработчикам КАК ВТЗаказы
	|	ПО Заказы.ЗаказПоставщику = ВТЗаказы.ЗаказПоставщику
	|		И Заказы.КодСтроки = ВТЗаказы.КодСтроки
	|		И (Заказы.Период >= &ПериодНачало)
	|		И (&НеТолькоТекущийМесяц
	|			ИЛИ Заказы.Период МЕЖДУ &ПериодНачало И &ПериодОкончание)
	|		И Заказы.Активность
	|ГДЕ
	|	НЕ &ПартионныйУчетВерсии22
	|
	|СГРУППИРОВАТЬ ПО
	|
	|	Заказы.ЗаказПоставщику,
	|	Заказы.КодСтроки
	|
	//++ НЕ УТКА
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Записи.Распоряжение КАК ЗаказНаПроизводство,
	|	Записи.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	Записи.Этап КАК Этап,
	|	Записи.Этап.Владелец КАК Спецификация,
	|	СУММА(Записи.ЗапланированоЗаказом) КАК ЗапланированоЗаказом,
	|	СУММА(Записи.Выполнено + Записи.Брак) КАК Выполнено
	|
	|ИЗ
	|	РегистрНакопления.ЭтапыПроизводства КАК Записи
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК ЗаказНаПроизводство
	|	ПО Записи.Распоряжение = ЗаказНаПроизводство.Ссылка
	|		И ЗаказНаПроизводство.Организация = &Организация
	|		И (ЗаказНаПроизводство.Ссылка = &Заказ ИЛИ &ПоВсемЗаказам)
	|		И (Записи.Подразделение = &Подразделение ИЛИ &ПоВсемПодразделениям)
	|		И (Записи.ОкончаниеЗавершающегоБуфера >= &ПериодНачало)
	|		И (&НеТолькоТекущийМесяц ИЛИ Записи.ОкончаниеЗавершающегоБуфера МЕЖДУ &ПериодНачало И &ПериодОкончание)
	|		И (&НеТолькоТекущийМесяц ИЛИ Записи.НачалоПредварительногоБуфера МЕЖДУ &ПериодНачало И &ПериодОкончание)
	|		И Записи.Активность
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ТЧПродукция
	|	ПО ЗаказНаПроизводство.Ссылка = ТЧПродукция.Ссылка
	|		И Записи.КодСтрокиПродукция = ТЧПродукция.КодСтроки
	|		И (ТЧПродукция.Назначение = &Назначение ИЛИ &ПоВсемНазначениям)
	|		И (ТЧПродукция.Назначение.НаправлениеДеятельности = &НаправлениеДеятельности ИЛИ &ПоВсемНаправлениямДеятельности)
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|	ПО ТЧПродукция.Номенклатура = СпрНоменклатура.Ссылка
	|		И (&ПоВсемГруппамПродукции ИЛИ СпрНоменклатура.ГруппаАналитическогоУчета = &ГруппаПродукции)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ втВыпускиПродукции КАК ВыпускПродукции
	|	ПО (ТЧПродукция.Ссылка = ВыпускПродукции.ЗаказНаПроизводство
	|		И ТЧПродукция.КодСтроки = ВыпускПродукции.КодСтроки)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ втДатыЗавершения КАК втДатыЗавершения
	|	ПО Записи.Распоряжение = втДатыЗавершения.Распоряжение
	|		И Записи.КодСтрокиПродукция = втДатыЗавершения.КодСтрокиПродукция
	|
	|ГДЕ
	|	(НЕ &ПартионныйУчетВерсии22 ИЛИ НЕ ВыпускПродукции.ЗаказНаПроизводство ЕСТЬ NULL)
	|	И втДатыЗавершения.Распоряжение ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|
	|	Записи.Распоряжение,
	|	Записи.КодСтрокиПродукция,
	|	Записи.Этап,
	|	ТЧПродукция.Номенклатура,
	|	ТЧПродукция.Характеристика,
	|	ТЧПродукция.Спецификация,
	|	ТЧПродукция.Назначение
	//-- НЕ УТКА
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаказНаПроизводство");
	
	Назначение = Неопределено;
	НаправлениеДеятельности = Неопределено;
	Подразделение = Неопределено;
	ГруппаПродукции = Неопределено;
	Заказ = Неопределено;
	Параметры.Свойство("Назначение", Назначение);
	Параметры.Свойство("НаправлениеДеятельности", НаправлениеДеятельности);
	Параметры.Свойство("Подразделение", Подразделение);
	Параметры.Свойство("ГруппаПродукции", ГруппаПродукции);
	Параметры.Свойство("Заказ", Заказ);
	
	Запрос.УстановитьПараметр("ПериодНачало",	 Параметры.ПериодНачало);
	Запрос.УстановитьПараметр("ПериодОкончание", Параметры.ПериодОкончание);
	Запрос.УстановитьПараметр("Организация",     Параметры.Организация);
	Запрос.УстановитьПараметр("Назначение",       Назначение);
	Запрос.УстановитьПараметр("ПоВсемНазначениям", Не ЗначениеЗаполнено(Назначение));
	Запрос.УстановитьПараметр("НаправлениеДеятельности",        НаправлениеДеятельности);
	Запрос.УстановитьПараметр("ПоВсемНаправлениямДеятельности", Не ЗначениеЗаполнено(НаправлениеДеятельности));
	Запрос.УстановитьПараметр("Подразделение", Подразделение);
	Запрос.УстановитьПараметр("ПоВсемПодразделениям", Не ЗначениеЗаполнено(Подразделение));
	Запрос.УстановитьПараметр("Заказ", Заказ);
	Запрос.УстановитьПараметр("ПоВсемЗаказам", Не ЗначениеЗаполнено(Заказ));
	Запрос.УстановитьПараметр("ГруппаПродукции", ГруппаПродукции);
	Запрос.УстановитьПараметр("ПоВсемГруппамПродукции", Не ЗначениеЗаполнено(ГруппаПродукции));
	Запрос.УстановитьПараметр("НеТолькоТекущийМесяц", НЕ Параметры.ТолькоТекущийМесяц);
	Запрос.УстановитьПараметр("ПартионныйУчетВерсии22", Параметры.ПартионныйУчетВерсии22);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Процедура выполняет запись движений в таблицу последовательности производственных затрат.
//
// Параметры:
//	ДополнительныеСвойства - Структура - структура с данными для записи
//	Движения - Движения - Движения регистра "Выпуск продукции"
//	Отказ - Булево - Признак отказа от записи движений.
//
Процедура ОтразитьВыпускПродукции(ДополнительныеСвойства, Движения, Отказ) Экспорт

	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаВыпускПродукции;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	Движения.ВыпускПродукции.Записывать = Истина;
	Движения.ВыпускПродукции.Загрузить(Таблица);
	
КонецПроцедуры

// Процедура выполняет запись движений в таблицу последовательности производственных затрат.
//
// Параметры:
//	ДополнительныеСвойства - Структура - структура с данными для записи
//	Движения - Движения - Движения регистра "РаспоряженияНаСписаниеПоНормативам"
//	Отказ - Булево - Признак отказа от записи движений.
//
Процедура ОтразитьРаспоряженияНаСписаниеПоНормативам(ДополнительныеСвойства, Движения, Отказ) Экспорт

	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаРаспоряженияНаСписаниеПоНормативам;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	Движения.РаспоряженияНаСписаниеПоНормативам.Записывать = Истина;
	Движения.РаспоряженияНаСписаниеПоНормативам.Загрузить(Таблица);
	
КонецПроцедуры

// Процедура выполняет запись движений в таблицу последовательности производственных затрат.
//
// Параметры:
//	ДополнительныеСвойства - Структура - структура с данными для записи
//	Движения - Движения - Движения регистра "ПрочиеРасходыНезавершенногоПроизводства"
//	Отказ - Булево - Признак отказа от записи движений.
//
Процедура ОтразитьПрочиеРасходыНезавершенногоПроизводства(ДополнительныеСвойства, Движения, Отказ) Экспорт
	
	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПрочиеРасходыНезавершенногоПроизводства;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Набор = Движения.ПрочиеРасходыНезавершенногоПроизводства;
	Набор.Записывать = Истина;
	Набор.Загрузить(Таблица);
	
КонецПроцедуры

// Процедура выполняет запись движений в таблицу партий незавершенного производства.
//
// Параметры:
//	ДополнительныеСвойства - Структура - структура с данными для записи
//	Движения - Движения - Движения регистра "ПартииНезавершенногоПроизводства"
//	Отказ - Булево - Признак отказа от записи движений.
//
Процедура ОтразитьПартииНезавершенногоПроизводства(ДополнительныеСвойства, Движения, Отказ) Экспорт
	
	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПартииНезавершенногоПроизводства;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Набор = Движения.ПартииНезавершенногоПроизводства;
	Набор.Записывать = Истина;
	Набор.Загрузить(Таблица);
	
КонецПроцедуры

// Процедура используется для выполнения регламентного задания по формированию документов
// "Списание затрат на выпуск".
Процедура СписатьЗатратыНаВыпуск() Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания(Метаданные.РегламентныеЗадания.СписаниеЗатратНаВыпуск);
	
	Если НЕ ПолучитьФункциональнуюОпцию("ИспользоватьПроизводство") Тогда
		Возврат;
	КонецЕсли;
	
	ПроверитьБлокировкуВходящихДанныхПриОбновленииИБ(НСтр("ru = 'Списание затрат на выпуск без заказов';
															|en = 'Write off release costs without orders'"));
	
	Документы.СписаниеЗатратНаВыпуск.ДокументыПоПараметрам(Новый Структура, , Истина);
	
КонецПроцедуры

// Функция формирует таблицу партий производства.
//
// Параметры:
//	Параметры - Структура - Структура отборов.
//
// Возвращаемое значение:
//	ТаблицаЗначений - таблица партий производства.
//
Функция ПартииПроизводстваДляРаспределенияЗатрат(Отборы) Экспорт
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
//++ НЕ УТКА
	ПараметрыЗапроса = ОписаниеПараметровПолученияАктивныхПартий();
	ПараметрыЗапроса.НачалоПериода = Отборы.НачалоПериода;
	ПараметрыЗапроса.ОкончаниеПериода = Отборы.ОкончаниеПериода;
	ПараметрыЗапроса.Организации = ОбщегоНазначенияУТКлиентСервер.Массив(Отборы.Организация);
	
	ПоместитьАктивныеПартииБезСпецификаций(ПараметрыЗапроса, МенеджерВременныхТаблиц);
//-- НЕ УТКА
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст = 
	"
//++ НЕ УТКА
	|ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	Реквизиты.ПартияПроизводства	КАК ПартияПроизводства,
	|	ИСТИНА							КАК ЕстьВыпускПродукции
	|ПОМЕСТИТЬ ЭтапыСВыпуском
	|ИЗ
	|	Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК Изделия
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|			ПО Изделия.Ссылка = Реквизиты.Ссылка
	|ГДЕ
	|	Реквизиты.Организация = &Организация
	|	И Реквизиты.Статус В (ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Начат),
	|						ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Завершен))
	|	И Реквизиты.Проведен
	|	И Изделия.Произведено
	|	И НЕ Изделия.Отменено
	|	И Изделия.ДатаПроизводства МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	Реквизиты.ПартияПроизводства	КАК ПартияПроизводства,
	|	ИСТИНА							КАК ЕстьВыпускПродукции
	|ИЗ
	|	Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК Изделия
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|			ПО Изделия.Ссылка = Реквизиты.Ссылка
	|ГДЕ
	|	Реквизиты.Организация = &Организация
	|	И Реквизиты.Статус В (ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Начат),
	|						ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Завершен))
	|	И Реквизиты.Проведен
	|	И Изделия.Произведено
	|	И НЕ Изделия.Отменено
	|	И Изделия.ДатаПроизводства МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	РеквизитыЭтапа.ПартияПроизводства	КАК ПартияПроизводства,
	|	ИСТИНА								КАК ЕстьВыпускПродукции
	|ИЗ
	|	Документ.ОтчетПереработчика.Продукция КАК Изделия
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК РеквизитыЭтапа
	|			ПО РеквизитыЭтапа.Ссылка = Изделия.ЭтапПроизводства
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК Реквизиты
	|			ПО Изделия.Ссылка = Реквизиты.Ссылка
	|ГДЕ
	|	Реквизиты.Организация = &Организация
	|	И Реквизиты.Проведен
	|	И Реквизиты.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Реквизиты.ГруппировкаЗатрат = ЗНАЧЕНИЕ(Перечисление.ГруппировкиЗатратВЗаказеПереработчику.ПоЭтапамПроизводства)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства
	|
	|;
	|
	|ВЫБРАТЬ
	|	Реквизиты.Ссылка КАК Этап,
	|	Реквизиты.Подразделение КАК Подразделение,
	|	Реквизиты.ПартияПроизводства КАК ПартияПроизводства,
	|	Реквизиты.ТипПроизводственногоПроцесса
	|ПОМЕСТИТЬ ЭтапыТекущегоПериода
	|ИЗ
	|	Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|ГДЕ
	|	Реквизиты.Организация = &Организация
	|	И Реквизиты.Проведен
	|	И Реквизиты.ФактическоеНачалоЭтапа <= &ОкончаниеПериода
	|	И (Реквизиты.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Начат)
	|		ИЛИ Реквизиты.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Завершен)
	|			И Реквизиты.ФактическоеОкончаниеЭтапа >= &НачалоПериода)
	|;
	|
	//-- НЕ УТКА
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СпрПартииПроизводства.Ссылка							КАК ПартияПроизводства,
	|	ДанныеДокумента.Подразделение							КАК Подразделение,
	|	ДанныеДокумента.Ссылка									КАК Этап,
	|	СпрПартииПроизводства.ОсновноеИзделиеНоменклатура		КАК Номенклатура,
	|	СпрПартииПроизводства.ОсновноеИзделиеХарактеристика	КАК Характеристика,
	|	СпрПартииПроизводства.Спецификация						КАК Спецификация,
	|	СпрПартииПроизводства.Назначение						КАК Назначение,
	|	СпрПартииПроизводства.НаправлениеДеятельности			КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО											КАК ЗаказНаПроизводство,
	|	ВЫБОР
	|		КОГДА ДанныеДокумента.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ													КАК ЭтапТекущегоМесяца,
	|	ИСТИНА													КАК ЕстьВыпускПродукции,
	|	ЛОЖЬ													КАК ПроизводствоНаСтороне
	|ПОМЕСТИТЬ ВтЭтапы
	|ИЗ
	|	Документ.ПроизводствоБезЗаказа.ВыходныеИзделия КАК ТаблицаВыходныеИзделия
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК ДанныеДокумента
	|		ПО ДанныеДокумента.Ссылка = ТаблицаВыходныеИзделия.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Документ = ТаблицаВыходныеИзделия.Ссылка
	|		И СпрПартииПроизводства.Код = ТаблицаВыходныеИзделия.НомерГруппыЗатрат
	|		И НЕ СпрПартииПроизводства.ПометкаУдаления
	|
	|ГДЕ
	|	ДанныеДокумента.Организация = &Организация
	|	И ДанныеДокумента.Проведен
	|	И ДанныеДокумента.Дата МЕЖДУ &НачалоПериода И КОНЕЦПЕРИОДА(ДобавитьКДате(&ОкончаниеПериода, МЕСЯЦ, 1), МЕСЯЦ)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДокумента.Ссылка,
	|	СпрПартииПроизводства.Ссылка,
	|	СпрПартииПроизводства.Номенклатура,
	|	СпрПартииПроизводства.Характеристика,
	|	СпрПартииПроизводства.Спецификация,
	|	СпрПартииПроизводства.Назначение,
	|	СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	АктивныеПартии.ПартияПроизводства 			КАК ПартияПроизводства,
	|	ЕСТЬNULL(Этапы.Подразделение,
	|		ЗаказНаПроизводство.Подразделение) 		КАК Подразделение,
	|	ЕСТЬNULL(Этапы.Этап, 
	|		НЕОПРЕДЕЛЕНО)							КАК Этап,
	|	РеквизитыПП.ОсновноеИзделиеНоменклатура		КАК Номенклатура,
	|	РеквизитыПП.ОсновноеИзделиеХарактеристика	КАК Характеристика,
	|	РеквизитыПП.Спецификация					КАК Спецификация,
	|	РеквизитыПП.Назначение						КАК Назначение,
	|	РеквизитыПП.НаправлениеДеятельности			КАК НаправлениеДеятельности,
	|	ЗаказНаПроизводство.Ссылка 					КАК ЗаказНаПроизводство,
	|	ИСТИНА										КАК ЭтапТекущегоМесяца,
	|	ЛОЖЬ										КАК ЕстьВыпускПродукции,
	|	ЛОЖЬ										КАК ПроизводствоНаСтороне
	|ИЗ
	|	АктивныеПартии КАК АктивныеПартии
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство2_2 КАК ЗаказНаПроизводство
	|		ПО АктивныеПартии.ПартияПроизводства = ЗаказНаПроизводство.ПартияПроизводства
	|
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК РеквизитыПП
	|		ПО РеквизитыПП.Ссылка = АктивныеПартии.ПартияПроизводства
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЭтапыТекущегоПериода КАК Этапы
	|		ПО АктивныеПартии.ПартияПроизводства = Этапы.ПартияПроизводства
	|			И Этапы.ТипПроизводственногоПроцесса = ЗНАЧЕНИЕ(Перечисление.ТипыПроизводственныхПроцессов.БезСпецификаций)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РеквизитыПП.Ссылка							КАК ПартияПроизводства,
	|	Реквизиты.Подразделение						КАК Подразделение,
	|	ВЫБОР
	|		КОГДА &ДетализироватьПоЭтапам
	|			ТОГДА Реквизиты.Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ										КАК Этап,
	|	РеквизитыПП.ОсновноеИзделиеНоменклатура		КАК Номенклатура,
	|	РеквизитыПП.ОсновноеИзделиеХарактеристика	КАК Характеристика,
	|	РеквизитыПП.Спецификация					КАК Спецификация,
	|	РеквизитыПП.Назначение						КАК Назначение,
	|	РеквизитыПП.НаправлениеДеятельности			КАК НаправлениеДеятельности,
	|	Реквизиты.Распоряжение						КАК ЗаказНаПроизводство,
	|	ВЫБОР
	|		КОГДА &НачалоПериода МЕЖДУ Реквизиты.ФактическоеНачалоЭтапа И Реквизиты.ФактическоеОкончаниеЭтапа
	|				ИЛИ &НачалоПериода >= Реквизиты.ФактическоеНачалоЭтапа
	|					И Реквизиты.ФактическоеОкончаниеЭтапа = ДАТАВРЕМЯ(1, 1, 1)
	|				ИЛИ &ОкончаниеПериода МЕЖДУ Реквизиты.ФактическоеНачалоЭтапа И Реквизиты.ФактическоеОкончаниеЭтапа
	|				ИЛИ &ОкончаниеПериода >= Реквизиты.ФактическоеНачалоЭтапа
	|					И Реквизиты.ФактическоеОкончаниеЭтапа = ДАТАВРЕМЯ(1, 1, 1)
	|				ИЛИ &НачалоПериода <= Реквизиты.ФактическоеНачалоЭтапа
	|					И &ОкончаниеПериода >= Реквизиты.ФактическоеОкончаниеЭтапа
	|				ИЛИ Реквизиты.ПроизводствоНаСтороне И ЕСТЬNULL(ЭтапыСВыпуском.ЕстьВыпускПродукции, ИСТИНА)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ												КАК ЭтапТекущегоМесяца,
	|	ЕСТЬNULL(ЭтапыСВыпуском.ЕстьВыпускПродукции, ЛОЖЬ)	КАК ЕстьВыпускПродукции,
	|	Реквизиты.ПроизводствоНаСтороне						КАК ПроизводствоНаСтороне
	|ИЗ
	|	ЭтапыТекущегоПериода КАК ЭтапыТекущегоПериода
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|		ПО ЭтапыТекущегоПериода.Этап = Реквизиты.Ссылка
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК РеквизитыПП
	|		ПО РеквизитыПП.Ссылка = Реквизиты.ПартияПроизводства

	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЭтапыСВыпуском КАК ЭтапыСВыпуском
	|		ПО ЭтапыСВыпуском.ПартияПроизводства = Реквизиты.ПартияПроизводства
	|ГДЕ
	|	НЕ ЭтапыТекущегоПериода.ТипПроизводственногоПроцесса = ЗНАЧЕНИЕ(Перечисление.ТипыПроизводственныхПроцессов.БезСпецификаций)
//-- НЕ УТКА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СпрПартииПроизводства.Ссылка						КАК ПартияПроизводства,
	|	Реквизиты.Подразделение								КАК Подразделение,
	|	Реквизиты.Ссылка									КАК Этап,
	|	СпрПартииПроизводства.ОсновноеИзделиеНоменклатура	КАК Номенклатура,
	|	СпрПартииПроизводства.ОсновноеИзделиеХарактеристика	КАК Характеристика,
	|	СпрПартииПроизводства.Спецификация					КАК Спецификация,
	|	СпрПартииПроизводства.Назначение					КАК Назначение,
	|	СпрПартииПроизводства.НаправлениеДеятельности		КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО										КАК ЗаказНаПроизводство,
	|	ИСТИНА												КАК ЭтапТекущегоМесяца,
	|	ИСТИНА												КАК ЕстьВыпускПродукции,
	|	ИСТИНА												КАК ПроизводствоНаСтороне
	|ИЗ
	|	Документ.ОтчетПереработчика КАК Реквизиты
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК ТаблицаТовары
	|		ПО Реквизиты.Ссылка = ТаблицаТовары.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Документ = ТаблицаТовары.Ссылка
	|		И СпрПартииПроизводства.Код = ТаблицаТовары.НомерГруппыЗатрат
	|		И НЕ СпрПартииПроизводства.ПометкаУдаления
	|ГДЕ
	|	Реквизиты.Организация = &Организация
	|	И Реквизиты.Проведен
	|	И Реквизиты.ГруппировкаЗатрат <> ЗНАЧЕНИЕ(Перечисление.ГруппировкиЗатратВЗаказеПереработчику.ПоЭтапамПроизводства)
	|	И Реквизиты.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|
	|СГРУППИРОВАТЬ ПО
	|	Реквизиты.Ссылка,
	|	СпрПартииПроизводства.Ссылка,
	|	СпрПартииПроизводства.Номенклатура,
	|	СпрПартииПроизводства.Характеристика,
	|	СпрПартииПроизводства.Спецификация,
	|	СпрПартииПроизводства.Назначение,
	|	СпрПартииПроизводства.НаправлениеДеятельности
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ЭтапТекущегоМесяца,
	|	Подразделение,
	|	Назначение,
	|	НаправлениеДеятельности
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтЭтапы.ПартияПроизводства,
	|	ВтЭтапы.Подразделение,
	|	ВтЭтапы.Этап,
	|	ВтЭтапы.Номенклатура,
	|	ВтЭтапы.Характеристика,
	|	ВтЭтапы.Спецификация,
	|	ВтЭтапы.Назначение,
	|	ВтЭтапы.ЗаказНаПроизводство,
	|	ВтЭтапы.ЭтапТекущегоМесяца
	|ИЗ
	|	ВтЭтапы КАК ВтЭтапы
	|ГДЕ
	|	(ВтЭтапы.ЭтапТекущегоМесяца
	|			ИЛИ &ЭтапыЗаВесьПериод)
	|	И (ВтЭтапы.Подразделение = &Подразделение
	|			ИЛИ &ВсеПодразделения)
	|	И (ВтЭтапы.ЗаказНаПроизводство = &ЗаказНаПроизводство
	|			ИЛИ &ВсеЗаказыНаПроизводство)
	|	И (ВтЭтапы.Назначение = &Назначение
	|			ИЛИ &ВсеНазначения)
	|	И (ВтЭтапы.НаправлениеДеятельности = &НаправлениеДеятельности
	|			ИЛИ &ВсеНаправленияДеятельности)
	|	И (ВтЭтапы.ЕстьВыпускПродукции
	|			ИЛИ НЕ &ТолькоЭтапыСВыпуском)
	|	И (НЕ ВтЭтапы.ПроизводствоНаСтороне
	|			ИЛИ НЕ &ИсключатьПроизводствоНаСтороне)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтЭтапы.Характеристика,
	|	ВтЭтапы.ПартияПроизводства,
	|	ВтЭтапы.Этап,
	|	ВтЭтапы.ЭтапТекущегоМесяца,
	|	ВтЭтапы.Спецификация,
	|	ВтЭтапы.Номенклатура,
	|	ВтЭтапы.Назначение,
	|	ВтЭтапы.ЗаказНаПроизводство,
	|	ВтЭтапы.Подразделение";
	
	Подразделение	= Неопределено;
	Назначение		= Неопределено;
	ЗаказНаПроизводство = Неопределено;

	НаправлениеДеятельности = Неопределено;
	ТолькоЭтапыСВыпуском = Отборы.Свойство("ТолькоЭтапыСВыпуском") И Отборы.ТолькоЭтапыСВыпуском;
	ИсключатьПроизводствоНаСтороне = Отборы.Свойство("ИсключатьПроизводствоНаСтороне") И Отборы.ИсключатьПроизводствоНаСтороне;
	
	Отборы.Свойство("Подразделение",           Подразделение);
	Отборы.Свойство("Назначение",              Назначение);

	Отборы.Свойство("ЗаказНаПроизводство",     ЗаказНаПроизводство);
	Отборы.Свойство("НаправлениеДеятельности", НаправлениеДеятельности);
	
	Запрос.УстановитьПараметр("НачалоПериода",                Отборы.НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",             Отборы.ОкончаниеПериода);
	
	Запрос.УстановитьПараметр("Организация",                  Отборы.Организация);
	Запрос.УстановитьПараметр("ДетализироватьПоЭтапам",       Отборы.ДетализироватьПоЭтапам);
	Запрос.УстановитьПараметр("ЭтапыЗаВесьПериод",            НЕ Отборы.ТолькоТекущийМесяц);
	
	Запрос.УстановитьПараметр("Подразделение",                Подразделение);
	Запрос.УстановитьПараметр("ВсеПодразделения",             Не ЗначениеЗаполнено(Подразделение));
	
	Запрос.УстановитьПараметр("Назначение",                   Назначение);
	Запрос.УстановитьПараметр("ВсеНазначения",                Не ЗначениеЗаполнено(Назначение));

	Запрос.УстановитьПараметр("ЗаказНаПроизводство",          ЗаказНаПроизводство);
	Запрос.УстановитьПараметр("ВсеЗаказыНаПроизводство",      Не ЗначениеЗаполнено(ЗаказНаПроизводство));
	
	Запрос.УстановитьПараметр("НаправлениеДеятельности",      НаправлениеДеятельности);
	Запрос.УстановитьПараметр("ВсеНаправленияДеятельности",   Не ЗначениеЗаполнено(НаправлениеДеятельности));
	
	Запрос.УстановитьПараметр("ТолькоЭтапыСВыпуском",           ТолькоЭтапыСВыпуском);
	Запрос.УстановитьПараметр("ИсключатьПроизводствоНаСтороне", ИсключатьПроизводствоНаСтороне);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

//++ НЕ УТКА

// Формирует временную таблицы партий производства с типом производственного процесса "Без спецификаций",
//	по которым выполняется производство в заданном интервале.
//
// Параметры:
//	ПараметрыЗапроса - Структура - см. ЗатратыСервер.ОписаниеПараметровПолученияАктивныхПартий().
//
Процедура ПоместитьАктивныеПартииБезСпецификаций(ПараметрыЗапроса, МенеджерВременныхТаблиц, ОбновитьПартии = Истина) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Если УниверсальныеМеханизмыПартийИСебестоимости.ВременнаяТаблицаСуществует(МенеджерВременныхТаблиц, "АктивныеПартии") Тогда
		
		Если Не ОбновитьПартии Тогда
			Возврат;
		КонецЕсли;
		
		Запрос.Текст =
			"УНИЧТОЖИТЬ АктивныеПартии";
		Запрос.Выполнить();
		
	КонецЕсли;
	
	Для Каждого Параметр Из ПараметрыЗапроса Цикл
		Запрос.УстановитьПараметр(Параметр.Ключ, Параметр.Значение);
	КонецЦикла;
	
	Запрос.УстановитьПараметр("ПоВсемОрганизациями", Не ПараметрыЗапроса.Организации.Количество());
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ЗаказНаПроизводство.ПартияПроизводства КАК ПартияПроизводства
		|ПОМЕСТИТЬ АктивныеПартии
		|ИЗ
		|	Документ.ЗаказНаПроизводство2_2 КАК ЗаказНаПроизводство
		|ГДЕ
		|	ЗаказНаПроизводство.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовНаПроизводство2_2.КПроизводству)
		|	И ЗаказНаПроизводство.ТипПроизводственногоПроцесса = ЗНАЧЕНИЕ(Перечисление.ТипыПроизводственныхПроцессов.БезСпецификаций)
		|	И ЗаказНаПроизводство.Проведен
		|	И ЗаказНаПроизводство.Дата <= &ОкончаниеПериода
		|	И (&ПоВсемОрганизациями ИЛИ ЗаказНаПроизводство.Организация В (&Организации))
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗаказНаПроизводство.ПартияПроизводства
		|ИЗ
		|	Документ.ЗаказНаПроизводство2_2 КАК ЗаказНаПроизводство
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК ЭтапПроизводства
		|		ПО ЗаказНаПроизводство.ПартияПроизводства = ЭтапПроизводства.ПартияПроизводства
		|ГДЕ
		|	(ЗаказНаПроизводство.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаказовНаПроизводство2_2.Закрыт)
		|		И ЗаказНаПроизводство.ТипПроизводственногоПроцесса = ЗНАЧЕНИЕ(Перечисление.ТипыПроизводственныхПроцессов.БезСпецификаций)
		|		И ЗаказНаПроизводство.Проведен
		|		И ЗаказНаПроизводство.Дата <= &ОкончаниеПериода
		|		И (&ПоВсемОрганизациями ИЛИ ЗаказНаПроизводство.Организация В (&Организации)))
		|	И (ЭтапПроизводства.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЭтаповПроизводства2_2.Завершен)
		|		И ЭтапПроизводства.ФактическоеОкончаниеЭтапа >= &НачалоПериода
		|		И ЭтапПроизводства.Проведен)";
	
	Запрос.Выполнить();
	
КонецПроцедуры

// Описание параметров получения активных партий производства
//	с типом производственного процесса "Без спецификаци".
//
// Возвращаемое значение:
//	Структура - параметры запроса ЗатратыСервер.ПоместитьАктивныеПартииБезСпецификаций().
//
Функция ОписаниеПараметровПолученияАктивныхПартий() Экспорт
	
	ОписаниеПараметров = Новый Структура;
	ОписаниеПараметров.Вставить("НачалоПериода", Дата(1, 1, 1));
	ОписаниеПараметров.Вставить("ОкончаниеПериода", Дата(1, 1, 1));
	ОписаниеПараметров.Вставить("Организации", Новый Массив); // тип значения элемента - СправочникСсылка.Организации.
	
	Возврат ОписаниеПараметров;
	
КонецФункции

//-- НЕ УТКА

// Процедура заполняет характеристики основного изделия в коллекции для партии производства.
//
// Параметры:
//	Коллекция - ТаблицаЗначений - Таблица, в которой необходимо заполнить характеристики основного изделия.
//
Процедура ЗаполнитьХарактеристикиИзделийПоПартииПроизводства(Коллекция) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	Коллекция.НомерСтроки,
	|	Коллекция.ПартияПроизводства
	|ПОМЕСТИТЬ Коллекция
	|ИЗ
	|	&Коллекция КАК Коллекция
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Коллекция.НомерСтроки									КАК Индекс,
	|	СпрПартииПроизводства.ОсновноеИзделиеНоменклатура		КАК Номенклатура,
	|	СпрПартииПроизводства.ОсновноеИзделиеХарактеристика		КАК Характеристика,
	|	СпрПартииПроизводства.Спецификация						КАК Спецификация,
	|	СпрПартииПроизводства.Назначение						КАК Назначение
	|ИЗ
	|	Коллекция КАК Коллекция
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = Коллекция.ПартияПроизводства
	|
	|УПОРЯДОЧИТЬ ПО
	|	Индекс");
	
	Запрос.УстановитьПараметр("Коллекция",	Коллекция.Выгрузить(, "НомерСтроки, ПартияПроизводства"));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Для Номер = 0 По Коллекция.Количество() - 1 Цикл
		Выборка.Следующий(); // Количество строк в выборке по запросу всегда равно количеству строк в ТЧ
		ЗаполнитьЗначенияСвойств(Коллекция[Номер], Выборка);
	КонецЦикла;
	
КонецПроцедуры

Функция ТекстЗапросаПроизводственныеЗатратыТМЦ() Экспорт
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Склад КАК Склад,
	|	ДД.Подразделение КАК Подразделение
	|ПОМЕСТИТЬ СкладыПодразделения
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Ссылка КАК Склад,
	|		Т.Подразделение КАК Подразделение
	|	ИЗ
	|		Справочник.Склады КАК Т
	|	ГДЕ
	|		Т.ЦеховаяКладовая
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Ссылка,
	|		Т.Ссылка
	|	ИЗ
	|		Справочник.СтруктураПредприятия КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДД.АналитикаУчетаНоменклатуры.Партнер,
	|		НЕОПРЕДЕЛЕНО
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров.ОстаткиИОбороты(&НачалоПериода, &ОкончаниеПериода, , , АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер)) КАК ДД
	|	ГДЕ
	|		(ДД.КоличествоНачальныйОстаток <> 0
	|			ИЛИ ДД.КоличествоКонечныйОстаток <> 0
	|			ИЛИ ДД.КоличествоПриход <> 0
	|			ИЛИ ДД.КоличествоРасход <> 0)) КАК ДД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	СкладыПодразделения.Подразделение КАК Подразделение
	|ПОМЕСТИТЬ Выпуски
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК СкладыПодразделения
	|		ПО (Аналитика.МестоХранения = СкладыПодразделения.Склад)
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|								ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДД.Таблица                                             КАК Таблица,
	|	ДД.Содержание                                          КАК Содержание,
	|	ДД.Организация                                         КАК Организация,
	|	ДД.Подразделение                                       КАК Подразделение,
	|	ДД.Отправитель                                         КАК Отправитель,
	|	ДД.Получатель                                          КАК Получатель,
	|	ДД.СкладПодразделение                                  КАК СкладПодразделение,
	|	ДД.Регистратор                                         КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                          КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов                                          КАК ВидЗапасов,
	|	ДД.АналитикаФинансовогоУчета                           КАК АналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартий                                КАК АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС                                  КАК ВидДеятельностиНДС,
	|	ДД.Номенклатура                                        КАК Номенклатура,
	|	ДД.Характеристика                                      КАК Характеристика,
	|	ДД.Серия                                               КАК Серия,
	|	ДД.Назначение                                          КАК Назначение,
	|	ДД.НаправлениеДеятельности                             КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции                                   КАК СтатьяКалькуляции,
	|	ДД.Партия                                              КАК Партия,
	|	ДД.ПартияПроизводства                                  КАК ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство                                 КАК ЗаказНаПроизводство,
	
	|	СУММА(ДД.аНачальныйОстатокКоличество)                  КАК аНачальныйОстатокКоличество,
	|	СУММА(ДД.аНачальныйОстатокСтоимость)                   КАК аНачальныйОстатокСтоимость,
	|	СУММА(ДД.аНачальныйОстатокПР)                          КАК аНачальныйОстатокПР,
	|	СУММА(ДД.аНачальныйОстатокВР)                          КАК аНачальныйОстатокВР,
	|	СУММА(ДД.аНачальныйОстатокЗабалансовая)                КАК аНачальныйОстатокЗабалансовая,
	
	|	СУММА(ДД.бПоступилоКоличество) КАК бПоступилоКоличество,
	|	СУММА(ДД.бПоступилоСтоимость) КАК бПоступилоСтоимость,
	|	СУММА(ДД.бПоступилоПР) КАК бПоступилоПР,
	|	СУММА(ДД.бПоступилоВР) КАК бПоступилоВР,
	|	СУММА(ДД.бПоступилоЗабалансовая) КАК бПоступилоЗабалансовая,
	
	|	СУММА(ДД.вПеремещенияКоличество) КАК вПеремещенияКоличество,
	|	СУММА(ДД.вПеремещенияСтоимость) КАК вПеремещенияСтоимость,
	|	СУММА(ДД.вПеремещенияПР) КАК вПеремещенияПР,
	|	СУММА(ДД.вПеремещенияВР) КАК вПеремещенияВР,
	|	СУММА(ДД.вПеремещенияЗабалансовая) КАК вПеремещенияЗабалансовая,
	
	|	СУММА(ДД.гРасходНаПроизводствоКоличество) КАК гРасходНаПроизводствоКоличество,
	|	СУММА(ДД.гРасходНаПроизводствоСтоимость) КАК гРасходНаПроизводствоСтоимость,
	|	СУММА(ДД.гРасходНаПроизводствоПР) КАК гРасходНаПроизводствоПР,
	|	СУММА(ДД.гРасходНаПроизводствоВР) КАК гРасходНаПроизводствоВР,
	|	СУММА(ДД.гРасходНаПроизводствоЗабалансовая) КАК гРасходНаПроизводствоЗабалансовая,
	
	|	СУММА(ДД.дСписаноКоличество) КАК дСписаноКоличество,
	|	СУММА(ДД.дСписаноСтоимость) КАК дСписаноСтоимость,
	|	СУММА(ДД.дСписаноПР) КАК дСписаноПР,
	|	СУММА(ДД.дСписаноВР) КАК дСписаноВР,
	|	СУММА(ДД.дСписаноЗабалансовая) КАК дСписаноЗабалансовая,
	
	|	СУММА(ДД.еКонечныйОстатокКоличество) КАК еКонечныйОстатокКоличество,
	|	СУММА(ДД.еКонечныйОстатокСтоимость) КАК еКонечныйОстатокСтоимость,
	|	СУММА(ДД.еКонечныйОстатокПР) КАК еКонечныйОстатокПР,
	|	СУММА(ДД.еКонечныйОстатокВР) КАК еКонечныйОстатокВР,
	|	СУММА(ДД.еКонечныйОстатокЗабалансовая) КАК еКонечныйОстатокЗабалансовая,
	
	|	СУММА(ДД.жПереданоКоличество) КАК жПереданоКоличество,
	|	СУММА(ДД.жПереданоСтоимость) КАК жПереданоСтоимость,
	|	СУММА(ДД.жПереданоПР) КАК жПереданоПР,
	|	СУММА(ДД.жПереданоВР) КАК жПереданоВР,
	|	СУММА(ДД.жПереданоЗабалансовая) КАК жПереданоЗабалансовая
	|{ВЫБРАТЬ
	|Таблица,
	|Содержание,
	|Организация.*,
	|Подразделение.*,
	|Отправитель.*,
	|Получатель.*,
	|СкладПодразделение.*,
	|Регистратор.*,
	|АналитикаУчетаНоменклатуры.*,
	|ВидЗапасов.*,
	|АналитикаФинансовогоУчета.*,
	|АналитикаУчетаПартий.*,
	|ВидДеятельностиНДС.*,
	|Номенклатура.*,
	|Характеристика.*,
	|Серия.*,
	|Назначение.*,
	|НаправлениеДеятельности.*,
	|СтатьяКалькуляции.*,
	|Партия.*,
	|ПартияПроизводства.*,
	|ЗаказНаПроизводство.*,
	|аНачальныйОстатокКоличество,
	|аНачальныйОстатокСтоимость,
	|аНачальныйОстатокПР,
	|аНачальныйОстатокВР,
	|аНачальныйОстатокЗабалансовая,
	|бПоступилоКоличество,
	|бПоступилоСтоимость,
	|бПоступилоПР,
	|бПоступилоВР,
	|бПоступилоЗабалансовая,
	|вПеремещенияКоличество,
	|вПеремещенияСтоимость,
	|вПеремещенияПР,
	|вПеремещенияВР,
	|вПеремещенияЗабалансовая,
	|гРасходНаПроизводствоКоличество,
	|гРасходНаПроизводствоСтоимость,
	|гРасходНаПроизводствоПР,
	|гРасходНаПроизводствоВР,
	|гРасходНаПроизводствоЗабалансовая,
	|дСписаноКоличество,
	|дСписаноСтоимость,
	|дСписаноПР,
	|дСписаноВР,
	|дСписаноЗабалансовая,
	|еКонечныйОстатокКоличество,
	|еКонечныйОстатокСтоимость,
	|еКонечныйОстатокПР,
	|еКонечныйОстатокВР,
	|еКонечныйОстатокЗабалансовая,
	|жПереданоКоличество,
	|жПереданоСтоимость,
	|жПереданоПР,
	|жПереданоВР,
	|жПереданоЗабалансовая}
	|ИЗ
	|
	|(ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА Выпуски.Подразделение ЕСТЬ NULL
	|			ТОГДА ""Материалы""
	|		ИНАЧЕ ""Продукция""
	|	КОНЕЦ                                                  КАК Таблица,
	|	""Начальный остаток""                                  КАК Содержание,
	|	ДД.Организация                                         КАК Организация,
	|	СкладыПодразделения.Подразделение                      КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                           КАК Отправитель,
	|	НЕОПРЕДЕЛЕНО                                           КАК Получатель,
	|	Аналитика.МестоХранения                                КАК СкладПодразделение,
	|	НЕОПРЕДЕЛЕНО                                           КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры                          КАК АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов                                          КАК ВидЗапасов,
	|	ДД.АналитикаФинансовогоУчета                           КАК АналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартий                                КАК АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС                                  КАК ВидДеятельностиНДС,
	|	Аналитика.Номенклатура                                 КАК Номенклатура,
	|	Аналитика.Характеристика                               КАК Характеристика,
	|	Аналитика.Серия                                        КАК Серия,
	|	Аналитика.Назначение                                   КАК Назначение,
	|	Аналитика.Назначение.НаправлениеДеятельности           КАК НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции                            КАК СтатьяКалькуляции,
	|	ДД.Партия                                              КАК Партия,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).ПартияПроизводства
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                  КАК ПартияПроизводства,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).Распоряжение
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                  КАК ЗаказНаПроизводство,
	|	ДД.КоличествоОстаток                                   КАК аНачальныйОстатокКоличество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток + ДД.ДопРасходыОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеСНДСОстаток + ДД.ПостатейныеПеременныеСНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток + ДД.ДопРасходыРеглОстаток + ДД.ТрудозатратыРеглОстаток + ДД.ПостатейныеПостоянныеРеглОстаток + ДД.ПостатейныеПеременныеРеглОстаток
	|		ИНАЧЕ	
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ                                                  КАК аНачальныйОстатокСтоимость,
	|	ДД.ПостояннаяРазницаОстаток                            КАК аНачальныйОстатокПР,
	|	ДД.ВременнаяРазницаОстаток                             КАК аНачальныйОстатокВР,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансоваяОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРеглОстаток
	|	КОНЕЦ                                                  КАК аНачальныйОстатокЗабалансовая,
	
	|	0 КАК бПоступилоКоличество,
	|	0 КАК бПоступилоСтоимость,
	|	0 КАК бПоступилоПР,
	|	0 КАК бПоступилоВР,
	|	0 КАК бПоступилоЗабалансовая,
	
	|	0 КАК вПеремещенияКоличество,
	|	0 КАК вПеремещенияСтоимость,
	|	0 КАК вПеремещенияПР,
	|	0 КАК вПеремещенияВР,
	|	0 КАК вПеремещенияЗабалансовая,
	
	|	0 КАК гРасходНаПроизводствоКоличество,
	|	0 КАК гРасходНаПроизводствоСтоимость,
	|	0 КАК гРасходНаПроизводствоПР,
	|	0 КАК гРасходНаПроизводствоВР,
	|	0 КАК гРасходНаПроизводствоЗабалансовая,
	
	|	0 КАК дСписаноКоличество,
	|	0 КАК дСписаноСтоимость,
	|	0 КАК дСписаноПР,
	|	0 КАК дСписаноВР,
	|	0 КАК дСписаноЗабалансовая,
	
	|	0 КАК еКонечныйОстатокКоличество,
	|	0 КАК еКонечныйОстатокСтоимость,
	|	0 КАК еКонечныйОстатокПР,
	|	0 КАК еКонечныйОстатокВР,
	|	0 КАК еКонечныйОстатокЗабалансовая,
	
	|	0 КАК жПереданоКоличество,
	|	0 КАК жПереданоСтоимость,
	|	0 КАК жПереданоПР,
	|	0 КАК жПереданоВР,
	|	0 КАК жПереданоЗабалансовая
	
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(
	|			{(&НачалоПериода)},
	|			НЕ &БезОтбораПоПериоду
	|				И ((АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|					И АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая)
	|					ИЛИ АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)) И АналитикаУчетаНоменклатуры.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)) КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК СкладыПодразделения
	|		ПО (Аналитика.МестоХранения = СкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
	|		ПО ДД.АналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
	|			И (СкладыПодразделения.Подразделение = Выпуски.Подразделение)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА Выпуски.Подразделение ЕСТЬ NULL
	|			ТОГДА ""Материалы""
	|		ИНАЧЕ ""Продукция""
	|	КОНЕЦ,
	|	""Поступило со склада или кладовых других цехов и приходы по перемещениям"",
	|	ДД.Организация,
	|	КорСкладыПодразделения.Подразделение,
	|	Аналитика.МестоХранения,
	|	КорАналитика.МестоХранения,
	|	КорАналитика.МестоХранения,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорВидЗапасов,
	|	ДД.КорАналитикаФинансовогоУчета,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.КорВидДеятельностиНДС,
	|	КорАналитика.Номенклатура,
	|	КорАналитика.Характеристика,
	|	КорАналитика.Серия,
	|	КорАналитика.Назначение,
	|	КорАналитика.Назначение.НаправлениеДеятельности,
	|	КорАналитика.СтатьяКалькуляции,
	|	ДД.Партия,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(КорАналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(КорАналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).ПартияПроизводства
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(КорАналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(КорАналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).Распоряжение
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ СкладыПодразделения.Подразделение ЕСТЬ NULL
	|			ТОГДА ДД.Количество
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ СкладыПодразделения.Подразделение ЕСТЬ NULL
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|					КОГДА &ДанныеПоСебестоимости = 2
	|						ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|					КОГДА &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|					ИНАЧЕ	
	|						ВЫБОР КОГДА &ПоПредприятию
	|							ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|						ИНАЧЕ
	|							ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|						КОНЕЦ
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ СкладыПодразделения.Подразделение ЕСТЬ NULL
	|			ТОГДА ДД.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ СкладыПодразделения.Подразделение ЕСТЬ NULL
	|			ТОГДА ДД.ВременнаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ СкладыПодразделения.Подразделение ЕСТЬ NULL
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА 0
	|					КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|						ТОГДА СтоимостьЗабалансовая
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА СтоимостьЗабалансоваяРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,

	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|			ТОГДА ДД.Количество
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|					КОГДА &ДанныеПоСебестоимости = 2
	|						ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|					КОГДА &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|					ИНАЧЕ	
	|						ВЫБОР КОГДА &ПоПредприятию
	|							ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|						ИНАЧЕ
	|							ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|						КОНЕЦ
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|			ТОГДА ДД.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|			ТОГДА ДД.ВременнаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА 0
	|					КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьЗабалансовая
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|		ПО ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК КорСкладыПодразделения
	|		ПО (КорАналитика.МестоХранения = КорСкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК СкладыПодразделения
	|		ПО (Аналитика.МестоХранения = СкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
	|		ПО ДД.КорАналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
	|			И (КорСкладыПодразделения.Подразделение = Выпуски.Подразделение)
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И КорАналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И ((КорАналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|		И КорАналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ КорАналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ КорАналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер))
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА Выпуски.Подразделение ЕСТЬ NULL
	|			ТОГДА ""Материалы""
	|		ИНАЧЕ ""Продукция""
	|	КОНЕЦ,
	|	""Расходы по перемещениям, передачи на склад, в другие кладовые, в производство"",
	|	ДД.Организация,
	|	СкладыПодразделения.Подразделение,
	|	Аналитика.МестоХранения,
	|	КорАналитика.МестоХранения,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	ДД.Партия,
	|	ВЫБОР
	|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства)
	|			ТОГДА ДД.КорПартия
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(КорАналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(КорАналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).ПартияПроизводства
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).ПартияПроизводства
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(КорАналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(КорАналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).Распоряжение
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).Распоряжение
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	
	// начальный остаток
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// поступило
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// перемещения
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|				И НЕ ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
	|			ТОГДА -1 * ДД.Количество
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|				И НЕ ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
	|			ТОГДА -1 * ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|					КОГДА &ДанныеПоСебестоимости = 2
	|						ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|					КОГДА &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|					ИНАЧЕ	
	|						ВЫБОР КОГДА &ПоПредприятию
	|							ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|						ИНАЧЕ
	|							ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|						КОНЕЦ
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|				И НЕ ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
	|			ТОГДА -1 * ДД.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|				И НЕ ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
	|			ТОГДА -1 * ДД.ВременнаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СкладыПодразделения.Подразделение = КорСкладыПодразделения.Подразделение
	|				И НЕ ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства),
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию))
	|			ТОГДА -1 * ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА 0
	|					КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьЗабалансовая
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	
	// на производство
	|	ВЫБОР
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|		И ((Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			И Аналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер))
	|			ТОГДА ДД.Количество
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|		И ((Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			И Аналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер))
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|					КОГДА &ДанныеПоСебестоимости = 2
	|						ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|					КОГДА &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|					ИНАЧЕ	
	|						ВЫБОР КОГДА &ПоПредприятию
	|							ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|						ИНАЧЕ
	|							ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|						КОНЕЦ
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|		И ((Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			И Аналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер))
	|			ТОГДА ДД.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			ТОГДА ДД.ВременнаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|		И ((Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			И Аналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер))
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА 0
	|					КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьЗабалансовая
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	
	// списание
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// конечный остаток
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// передача на склад
	|	ВЫБОР
	|		КОГДА (СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ КорСкладыПодразделения.Подразделение ЕСТЬ NULL)
	|					И ДД.ХозяйственнаяОперация НЕ В(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			ТОГДА ДД.Количество
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ КорСкладыПодразделения.Подразделение ЕСТЬ NULL)
	|					И ДД.ХозяйственнаяОперация НЕ В(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|					КОГДА &ДанныеПоСебестоимости = 2
	|						ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|					КОГДА &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|					ИНАЧЕ	
	|						ВЫБОР КОГДА &ПоПредприятию
	|							ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|						ИНАЧЕ
	|							ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|						КОНЕЦ
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ КорСкладыПодразделения.Подразделение ЕСТЬ NULL)
	|					И ДД.ХозяйственнаяОперация НЕ В(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			ТОГДА ДД.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ КорСкладыПодразделения.Подразделение ЕСТЬ NULL)
	|					И ДД.ХозяйственнаяОперация НЕ В(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			ТОГДА ДД.ВременнаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА (СкладыПодразделения.Подразделение <> КорСкладыПодразделения.Подразделение
	|				ИЛИ КорСкладыПодразделения.Подразделение ЕСТЬ NULL)
	|					И ДД.ХозяйственнаяОперация НЕ В(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаПартииПроизводства))
	|			ТОГДА ВЫБОР
	|					КОГДА &ДанныеПоСебестоимости = 1
	|						ТОГДА 0
	|					КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|						ТОГДА ДД.СтоимостьЗабалансовая
	|					КОГДА &ДанныеПоСебестоимости = 4
	|						ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ
	
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|		ПО ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК КорСкладыПодразделения
	|		ПО (КорАналитика.МестоХранения = КорСкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК СкладыПодразделения
	|		ПО (Аналитика.МестоХранения = СкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
	|		ПО ДД.АналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
	|			И (СкладыПодразделения.Подразделение = Выпуски.Подразделение)
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И ((Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|		И Аналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер)
	|			ИЛИ КорАналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ КорАналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер))
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|	И НЕ (ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|		ИЛИ ДД.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА Выпуски.Подразделение ЕСТЬ NULL
	|			ТОГДА ""Материалы""
	|		ИНАЧЕ ""Продукция""
	|	КОНЕЦ,
	|	""Списания на расходы"",
	|	ДД.Организация,
	|	СкладыПодразделения.Подразделение,
	|	Аналитика.МестоХранения,
	|	ДД.СтатьяРасходовСписания,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	ДД.Партия,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).ПартияПроизводства
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).Распоряжение
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	
	// начальный остаток
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// поступило
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// перемещения
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// на производство
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// списание
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ	
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	
	// конечный остаток
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	// передача на склад
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|		ПО ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК КорСкладыПодразделения
	|		ПО (КорАналитика.МестоХранения = КорСкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК СкладыПодразделения
	|		ПО (Аналитика.МестоХранения = СкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
	|		ПО ДД.АналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
	|			И (СкладыПодразделения.Подразделение = Выпуски.Подразделение)
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И ((Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			И Аналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение))
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И (ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|		ИЛИ ДД.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА Выпуски.Подразделение ЕСТЬ NULL
	|			ТОГДА ""Материалы""
	|		ИНАЧЕ ""Продукция""
	|	КОНЕЦ,
	|	""Приходы от поставщика и выпуски продукции"",
	|	ДД.Организация,
	|	СкладыПодразделения.Подразделение,
	|	ЕСТЬNULL(РеквизитыПроизводстваБезЗаказа.Подразделение, ЕСТЬNULL(РеквизитыОтчетов.Подразделение, СкладыПодразделения.Подразделение)),
	|	Аналитика.МестоХранения,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	ДД.Партия,
	|	ВЫБОР
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость))
	|			ТОГДА ДД.Партия
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость))
	|			И ПродукцияОтчета.ЭтапПроизводства.Распоряжение ЕСТЬ НЕ NULL
	|			ТОГДА ПродукцияОтчета.ЭтапПроизводства.Распоряжение
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость))
	|			И ОтходыОтчета.ЭтапПроизводства.Распоряжение ЕСТЬ НЕ NULL
	|			ТОГДА ОтходыОтчета.ЭтапПроизводства.Распоряжение
	|		КОГДА ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|										ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость))
	|			И ТИПЗНАЧЕНИЯ(ДД.Партия) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ДД.Партия.Распоряжение
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,

	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ	
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК СкладыПодразделения
	|		ПО (Аналитика.МестоХранения = СкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
	|		ПО ДД.АналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
	|			И (СкладыПодразделения.Подразделение = Выпуски.Подразделение)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК РеквизитыПроизводстваБезЗаказа
	|		ПО ДД.Регистратор = РеквизитыПроизводстваБезЗаказа.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК РеквизитыОтчетов
	|		ПО ДД.Регистратор = РеквизитыОтчетов.Ссылка
	//++ НЕ УТКА
	// заказ на производство по отчетам переработчика по этапам выбираем из этапов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК ПродукцияОтчета
	|		ПО ДД.Регистратор = ПродукцияОтчета.Ссылка
	|			И ДД.АналитикаУчетаПартий.КодСтроки = ПродукцияОтчета.КодСтроки
	|			И ПродукцияОтчета.Ссылка.ГруппировкаЗатрат = ЗНАЧЕНИЕ(Перечисление.ГруппировкиЗатратВЗаказеПереработчику.ПоЭтапамПроизводства)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.ВозвратныеОтходы КАК ОтходыОтчета
	|		ПО ДД.Регистратор = ОтходыОтчета.Ссылка
	|			И ДД.АналитикаУчетаПартий.КодСтроки = ОтходыОтчета.КодСтроки
	|			И ОтходыОтчета.Ссылка.ГруппировкаЗатрат = ЗНАЧЕНИЕ(Перечисление.ГруппировкиЗатратВЗаказеПереработчику.ПоЭтапамПроизводства)
	//-- НЕ УТКА	
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ((Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|		И Аналитика.СкладскаяТерритория.ЦеховаяКладовая)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ИЛИ Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер))
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И ДД.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|								ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость),
	|								ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА Выпуски.Подразделение ЕСТЬ NULL
	|			ТОГДА ""Материалы""
	|		ИНАЧЕ ""Продукция""
	|	КОНЕЦ,
	|	""Конечный остаток"",
	|	ДД.Организация,
	|	СкладыПодразделения.Подразделение,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	Аналитика.МестоХранения,
	|	НЕОПРЕДЕЛЕНО,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	ДД.Партия,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).ПартияПроизводства
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(Аналитика.Назначение.Заказ) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.Назначение.Заказ КАК Документ.ЭтапПроизводства2_2).Распоряжение
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,

	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	ДД.КоличествоОстаток,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток + ДД.ДопРасходыОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеСНДСОстаток + ДД.ПостатейныеПеременныеСНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток + ДД.ДопРасходыРеглОстаток + ДД.ТрудозатратыРеглОстаток + ДД.ПостатейныеПостоянныеРеглОстаток + ДД.ПостатейныеПеременныеРеглОстаток
	|		ИНАЧЕ	
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазницаОстаток,
	|	ДД.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансоваяОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРеглОстаток
	|	КОНЕЦ,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(
	|			{(&ОкончаниеПериодаГраница)},
	|			((АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|				И АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая)
	|				ИЛИ АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение))
	|					И АналитикаУчетаНоменклатуры.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)) КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СкладыПодразделения КАК СкладыПодразделения
	|		ПО (Аналитика.МестоХранения = СкладыПодразделения.Склад)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
	|		ПО ДД.АналитикаУчетаНоменклатуры = Выпуски.АналитикаУчетаНоменклатуры
	|			И (СкладыПодразделения.Подразделение = Выпуски.Подразделение)
	|) КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|
	|	ДД.Таблица,
	|	ДД.Содержание,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Отправитель,
	|	ДД.Получатель,
	|	ДД.СкладПодразделение,
	|	ДД.Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.Серия,
	|	ДД.Назначение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	ДД.Партия,
	|	ДД.ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство
	|";
	
	Ресурсы = Новый Массив;
	
	Ресурсы.Добавить("аНачальныйОстатокКоличество");
	Ресурсы.Добавить("аНачальныйОстатокСтоимость");
	Ресурсы.Добавить("аНачальныйОстатокПР");
	Ресурсы.Добавить("аНачальныйОстатокВР");
	Ресурсы.Добавить("аНачальныйОстатокЗабалансовая");
	
	Ресурсы.Добавить("бПоступилоКоличество");
	Ресурсы.Добавить("бПоступилоСтоимость");
	Ресурсы.Добавить("бПоступилоПР");
	Ресурсы.Добавить("бПоступилоВР");
	Ресурсы.Добавить("бПоступилоЗабалансовая");
	
	Ресурсы.Добавить("вПеремещенияКоличество");
	Ресурсы.Добавить("вПеремещенияСтоимость");
	Ресурсы.Добавить("вПеремещенияПР");
	Ресурсы.Добавить("вПеремещенияВР");
	Ресурсы.Добавить("вПеремещенияЗабалансовая");
	
	Ресурсы.Добавить("гРасходНаПроизводствоКоличество");
	Ресурсы.Добавить("гРасходНаПроизводствоСтоимость");
	Ресурсы.Добавить("гРасходНаПроизводствоПР");
	Ресурсы.Добавить("гРасходНаПроизводствоВР");
	Ресурсы.Добавить("гРасходНаПроизводствоЗабалансовая");
	
	Ресурсы.Добавить("дСписаноКоличество");
	Ресурсы.Добавить("дСписаноСтоимость");
	Ресурсы.Добавить("дСписаноПР");
	Ресурсы.Добавить("дСписаноВР");
	Ресурсы.Добавить("дСписаноЗабалансовая");
	
	Ресурсы.Добавить("еКонечныйОстатокКоличество");
	Ресурсы.Добавить("еКонечныйОстатокСтоимость");
	Ресурсы.Добавить("еКонечныйОстатокПР");
	Ресурсы.Добавить("еКонечныйОстатокВР");
	Ресурсы.Добавить("еКонечныйОстатокЗабалансовая");
	
	Ресурсы.Добавить("жПереданоКоличество");
	Ресурсы.Добавить("жПереданоСтоимость");
	Ресурсы.Добавить("жПереданоПР");
	Ресурсы.Добавить("жПереданоВР");
	Ресурсы.Добавить("жПереданоЗабалансовая");
	
	Возврат Новый Структура("ТекстЗапроса, Ресурсы", ТекстЗапроса, Ресурсы);
	
КонецФункции

Функция ТекстЗапросаПроизводственныеЗатратыПостатейные() Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДД.Таблица                                             КАК Таблица,
	|	ДД.Содержание                                          КАК Содержание,
	|	ДД.Организация                                         КАК Организация,
	|	ДД.Подразделение                                       КАК Подразделение,
	|	ДД.Отправитель                                         КАК Отправитель,
	|	ДД.Получатель                                          КАК Получатель,
	|	ДД.Регистратор                                         КАК Регистратор,
	|	ДД.СтатьяРасходов                                      КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                   КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности                             КАК НаправлениеДеятельности,
	|	ДД.ПартияПроизводства                                  КАК ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство                                 КАК ЗаказНаПроизводство,
	
	|	СУММА(ДД.аНачальныйОстатокСтоимость)                   КАК аНачальныйОстатокСтоимость,
	|	СУММА(ДД.аНачальныйОстатокПР)                          КАК аНачальныйОстатокПР,
	|	СУММА(ДД.аНачальныйОстатокВР)                          КАК аНачальныйОстатокВР,
	
	|	СУММА(ДД.бПоступилоСтоимость)                          КАК бПоступилоСтоимость,
	|	СУММА(ДД.бПоступилоПР)                                 КАК бПоступилоПР,
	|	СУММА(ДД.бПоступилоВР)                                 КАК бПоступилоВР,
	
	|	СУММА(ДД.гРасходНаПроизводствоСтоимость)               КАК гРасходНаПроизводствоСтоимость,
	|	СУММА(ДД.гРасходНаПроизводствоПР)                      КАК гРасходНаПроизводствоПР,
	|	СУММА(ДД.гРасходНаПроизводствоВР)                      КАК гРасходНаПроизводствоВР,
	
	|	СУММА(ДД.ПрочееСписаниеСтоимость)               	   КАК ПрочееСписаниеСтоимость,
	|	СУММА(ДД.ПрочееСписаниеПР)               	           КАК ПрочееСписаниеПР,
	|	СУММА(ДД.ПрочееСписаниеВР)               	           КАК ПрочееСписаниеВР,
	
	|	СУММА(ДД.еКонечныйОстатокСтоимость)                    КАК еКонечныйОстатокСтоимость,
	|	СУММА(ДД.еКонечныйОстатокПР)                           КАК еКонечныйОстатокПР,
	|	СУММА(ДД.еКонечныйОстатокВР)                           КАК еКонечныйОстатокВР
	|{ВЫБРАТЬ
	|Таблица,
	|Содержание,
	|Организация.*,
	|Подразделение.*,
	|Отправитель.*,
	|Получатель.*,
	|Регистратор.*,
	|СтатьяРасходов.*,
	|АналитикаРасходов.*,
	|НаправлениеДеятельности.*,
	|ПартияПроизводства.*,
	|ЗаказНаПроизводство.*,
	|аНачальныйОстатокСтоимость,
	|аНачальныйОстатокПР,
	|аНачальныйОстатокВР,
	|бПоступилоСтоимость,
	|бПоступилоПР,
	|бПоступилоВР,
	|гРасходНаПроизводствоСтоимость,
	|гРасходНаПроизводствоПР,
	|гРасходНаПроизводствоВР,
	|ПрочееСписаниеСтоимость,
	|ПрочееСписаниеПР,
	|ПрочееСписаниеВР,
	|еКонечныйОстатокСтоимость,
	|еКонечныйОстатокПР,
	|еКонечныйОстатокВР}
	|	
	|ИЗ
	|
	|(ВЫБРАТЬ
	|	""Постатейные""                                        КАК Таблица,
	|	""Начальный остаток""                                  КАК Содержание,
	|	ДД.Организация                                         КАК Организация,
	|	ДД.Подразделение                                       КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Отправитель,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Получатель,
	|	ВЫБОР
//++ НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЭтапПроизводства2_2.ПустаяСсылка)
//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                  КАК Регистратор,
	|	ДД.СтатьяРасходов                                      КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                   КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности                             КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                           КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО                                           КАК ЗаказНаПроизводство,
	
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СуммаОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СуммаБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СуммаУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СуммаРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СуммаБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СуммаУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ                                                  КАК аНачальныйОстатокСтоимость,
	|	ДД.ПостояннаяРазницаОстаток                            КАК аНачальныйОстатокПР,
	|	ДД.ВременнаяРазницаОстаток                             КАК аНачальныйОстатокВР,
	
	|	0                                                      КАК бПоступилоСтоимость,
	|	0                                                      КАК бПоступилоПР,
	|	0                                                      КАК бПоступилоВР,
	
	|	0                                                      КАК гРасходНаПроизводствоСтоимость,
	|	0                                                      КАК гРасходНаПроизводствоПР,
	|	0                                                      КАК гРасходНаПроизводствоВР,
	
	|	0                                                      КАК ПрочееСписаниеСтоимость,
	|	0                                                      КАК ПрочееСписаниеПР,
	|	0                                                      КАК ПрочееСписаниеВР,
	
	|	0                                                      КАК еКонечныйОстатокСтоимость,
	|	0                                                      КАК еКонечныйОстатокПР,
	|	0                                                      КАК еКонечныйОстатокВР
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы.Остатки(
	|			{(&НачалоПериода)},
	|			НЕ &БезОтбораПоПериоду
	|				И (СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|					ИЛИ СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))) КАК ДД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Постатейные"",
	|	""Закупка услуг, регистрация, отражение зарплаты"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	
	|	0,
	|	0,
	|	0,
	
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Сумма
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СуммаБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СуммаУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СуммаРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СуммаБезНДС
	|			ИНАЧЕ
	|				ДД.СуммаУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК ДД
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И (ДД.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|					ИЛИ ДД.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Постатейные"",
	|	""Распределение на производство"",
	|	ДД.Организация,
	|	Реквизиты.Подразделение,
	|	Реквизиты.Подразделение,
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	Реквизиты.НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ ДД.ЗаказНаПроизводство
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Реквизиты
	|		ПО ДД.Регистратор = Реквизиты.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Постатейные"",
	|	""Списание на другие статьи, выбытие"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Подразделение,
	|	ДД.КорСтатьяРасходов,
	|	ДД.Регистратор,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Сумма
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СуммаБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СуммаУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СуммаРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СуммаБезНДС
	|			ИНАЧЕ
	|				ДД.СуммаУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК ДД
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И (ДД.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|					ИЛИ ДД.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Постатейные"",
	|	""Конечный остаток"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СуммаОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СуммаБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СуммаУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СуммаРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СуммаБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СуммаУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазницаОстаток,
	|	ДД.ВременнаяРазницаОстаток
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы.Остатки(
	|			{(&ОкончаниеПериодаГраница)},
	|			(СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|					ИЛИ СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))) КАК ДД) КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|
	|	ДД.Таблица,
	|	ДД.Содержание,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Отправитель,
	|	ДД.Получатель,
	|	ДД.Регистратор,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	ДД.ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство";
	
	Ресурсы = Новый Массив;
	Ресурсы.Добавить("аНачальныйОстатокСтоимость");
	Ресурсы.Добавить("аНачальныйОстатокПР");
	Ресурсы.Добавить("аНачальныйОстатокВР");
	
	Ресурсы.Добавить("бПоступилоСтоимость");
	Ресурсы.Добавить("бПоступилоПР");
	Ресурсы.Добавить("бПоступилоВР");
	
	Ресурсы.Добавить("гРасходНаПроизводствоСтоимость");
	Ресурсы.Добавить("гРасходНаПроизводствоПР");
	Ресурсы.Добавить("гРасходНаПроизводствоВР");
	
	Ресурсы.Добавить("ПрочееСписаниеСтоимость");
	Ресурсы.Добавить("ПрочееСписаниеПР");
	Ресурсы.Добавить("ПрочееСписаниеВР");
	
	Ресурсы.Добавить("еКонечныйОстатокСтоимость");
	Ресурсы.Добавить("еКонечныйОстатокПР");
	Ресурсы.Добавить("еКонечныйОстатокВР");
	
	Возврат Новый Структура("ТекстЗапроса, Ресурсы", ТекстЗапроса, Ресурсы);
	
КонецФункции

Функция ТекстЗапросаПроизводственныеЗатратыПоПартиямПроизводства() Экспорт
	
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДД.Таблица                                КАК Таблица,
	|	ДД.Содержание                             КАК Содержание,
	|	ДД.ТипЗатрат                              КАК ТипЗатрат,
	|	ДД.ВидЗатрат                              КАК ВидЗатрат,
	|	ДД.Организация                            КАК Организация,
	|	ДД.Подразделение                          КАК Подразделение,
	|	ДД.ПодразделениеОтправитель               КАК ПодразделениеОтправитель,
	|	ДД.Регистратор                            КАК Регистратор,
	|	ДД.НаправлениеДеятельности                КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции                      КАК СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры             КАК АналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура                           КАК Номенклатура,
	|	ДД.Характеристика                         КАК Характеристика,
	|	ДД.Серия                                  КАК Серия,
	|	ДД.Назначение                             КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот                               КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов                         КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                      КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.АналитикаУчетаПродукции                КАК АналитикаУчетаПродукции,
	|	ДД.Продукция                              КАК Продукция,
	|	ДД.ХарактеристикаПродукции                КАК ХарактеристикаПродукции,
	|	ДД.СерияПродукции                         КАК СерияПродукции,
	|	ДД.НазначениеПродукции                    КАК НазначениеПродукции,
	|	
	|	ДД.ПартияПроизводства                     КАК ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство                    КАК ЗаказНаПроизводство,
	
	|	СУММА(ДД.аНачальныйОстатокКоличество)     КАК аНачальныйОстатокКоличество,
	|	СУММА(ДД.аНачальныйОстатокСтоимость)      КАК аНачальныйОстатокСтоимость,
	|	СУММА(ДД.аНачальныйОстатокПР)             КАК аНачальныйОстатокПР,
	|	СУММА(ДД.аНачальныйОстатокВР)             КАК аНачальныйОстатокВР,
	|	СУММА(ДД.аНачальныйОстатокЗабалансовая)   КАК аНачальныйОстатокЗабалансовая,
	|	
	|	СУММА(ДД.бПоступилоКоличество)            КАК бПоступилоКоличество,
	|	СУММА(ДД.бПоступилоСтоимость)             КАК бПоступилоСтоимость,
	|	СУММА(ДД.бПоступилоПР)                    КАК бПоступилоПР,
	|	СУММА(ДД.бПоступилоВР)                    КАК бПоступилоВР,
	|	СУММА(ДД.бПоступилоЗабалансовая)          КАК бПоступилоЗабалансовая,
	|	
	|	СУММА(ДД.гРасходНаПроизводствоКоличество) КАК гРасходНаПроизводствоКоличество,
	|	СУММА(ДД.гРасходНаПроизводствоСтоимость)  КАК гРасходНаПроизводствоСтоимость,
	|	СУММА(ДД.гРасходНаПроизводствоПР)         КАК гРасходНаПроизводствоПР,
	|	СУММА(ДД.гРасходНаПроизводствоВР)         КАК гРасходНаПроизводствоВР,
	|	СУММА(ДД.гРасходНаПроизводствоЗабалансовая)КАК гРасходНаПроизводствоЗабалансовая,
	|	
	|	СУММА(ДД.еКонечныйОстатокКоличество)      КАК еКонечныйОстатокКоличество,
	|	СУММА(ДД.еКонечныйОстатокСтоимость)       КАК еКонечныйОстатокСтоимость,
	|	СУММА(ДД.еКонечныйОстатокПР)              КАК еКонечныйОстатокПР,
	|	СУММА(ДД.еКонечныйОстатокВР)              КАК еКонечныйОстатокВР,
	|	СУММА(ДД.еКонечныйОстатокЗабалансовая)    КАК еКонечныйОстатокЗабалансовая
	|{ВЫБРАТЬ
	|Таблица,
	|Содержание,
	|ТипЗатрат.*,
	|ВидЗатрат,
	|Организация.*,
	|Подразделение.*,
	|ПодразделениеОтправитель.*,
	|Регистратор.*,
	|НаправлениеДеятельности.*,
	|СтатьяКалькуляции.*,
	|АналитикаУчетаНоменклатуры.*,
	|Номенклатура.*,
	|Характеристика.*,
	|Серия.*,
	|Назначение.*,
	|ВидРабот.*,
	|СтатьяРасходов.*,
	|АналитикаРасходов.*,
	|АналитикаУчетаПродукции.*,
	|Продукция.*,
	|ХарактеристикаПродукции.*,
	|СерияПродукции.*,
	|НазначениеПродукции.*,
	|ПартияПроизводства.*,
	|ЗаказНаПроизводство.*,
	|аНачальныйОстатокКоличество,
	|аНачальныйОстатокСтоимость,
	|аНачальныйОстатокПР,
	|аНачальныйОстатокВР,
	|аНачальныйОстатокЗабалансовая,
	|бПоступилоКоличество,
	|бПоступилоСтоимость,
	|бПоступилоПР,
	|бПоступилоВР,
	|бПоступилоЗабалансовая,
	|гРасходНаПроизводствоКоличество,
	|гРасходНаПроизводствоСтоимость,
	|гРасходНаПроизводствоПР,
	|гРасходНаПроизводствоВР,
	|гРасходНаПроизводствоЗабалансовая,
	|еКонечныйОстатокКоличество,
	|еКонечныйОстатокСтоимость,
	|еКонечныйОстатокПР,
	|еКонечныйОстатокВР,
	|еКонечныйОстатокЗабалансовая}
	|ИЗ
	// материалы
	|(ВЫБРАТЬ
	|	""Производство"" КАК Таблица,
	|	""Начальный остаток (материалы)"" КАК Содержание,
	|	Аналитика.СтатьяКалькуляции.ТипЗатрат КАК ТипЗатрат,
	|	ВЫБОР 
	|		КОГДА Аналитика.СтатьяКалькуляции.ТипЗатрат В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.Материальные),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.ВозвратныеОтходы))
	|			ТОГДА ""Материальные""
	|		ИНАЧЕ
	|			""Услуги""
	|	КОНЕЦ КАК ВидЗатрат,
	|	ДД.Организация КАК Организация,
	|	Аналитика.Подразделение КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеОтправитель,
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	Аналитика.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура КАК Номенклатура,
	|	Аналитика.Характеристика КАК Характеристика,
	|	Аналитика.Серия КАК Серия,
	|	Аналитика.Назначение КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|	
	|	ДД.Партия КАК ПартияПроизводства,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	ДД.КоличествоОстаток        КАК аНачальныйОстатокКоличество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток + ДД.ДопРасходыОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеСНДСОстаток + ДД.ПостатейныеПеременныеСНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток + ДД.ДопРасходыРеглОстаток + ДД.ТрудозатратыРеглОстаток + ДД.ПостатейныеПостоянныеРеглОстаток + ДД.ПостатейныеПеременныеРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ                       КАК аНачальныйОстатокСтоимость,
	|	ДД.ПостояннаяРазницаОстаток КАК аНачальныйОстатокПР,
	|	ДД.ВременнаяРазницаОстаток  КАК аНачальныйОстатокВР,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансоваяОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРеглОстаток
	|	КОНЕЦ                       КАК аНачальныйОстатокЗабалансовая,
	|	
	|	0 КАК бПоступилоКоличество,
	|	0 КАК бПоступилоСтоимость,
	|	0 КАК бПоступилоПР,
	|	0 КАК бПоступилоВР,
	|	0 КАК бПоступилоЗабалансовая,
	|	
	|	0 КАК гРасходНаПроизводствоКоличество,
	|	0 КАК гРасходНаПроизводствоСтоимость,
	|	0 КАК гРасходНаПроизводствоПР,
	|	0 КАК гРасходНаПроизводствоВР,
	|	0 КАК гРасходНаПроизводствоЗабалансовая,
	|	
	|	0 КАК еКонечныйОстатокКоличество,
	|	0 КАК еКонечныйОстатокСтоимость,
	|	0 КАК еКонечныйОстатокПР,
	|	0 КАК еКонечныйОстатокВР,
	|	0 КАК еКонечныйОстатокЗабалансовая
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(
	|			{(&НачалоПериода)},
	|			НЕ &БезОтбораПоПериоду
	|				И АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|				И (АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	//++ НЕ УТКА
	|						ИЛИ Партия Ссылка Документ.ЗаказНаПроизводство
	//-- НЕ УТКА
	|			)) КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.Партия
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (материалы) для 2.2"",
	|	КорАналитика.СтатьяКалькуляции.ТипЗатрат,
	|	""Материальные"",
	|	ДД.Организация,
	|	КорАналитика.МестоХранения,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор,
	|	КорАналитика.Назначение.НаправлениеДеятельности,
	|	КорАналитика.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	КорАналитика.Номенклатура,
	|	КорАналитика.Характеристика,
	|	КорАналитика.Серия,
	|	КорАналитика.Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.КорПартия,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|			ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|			ПО ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.КорПартия
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) 
	|	И КорАналитика.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (материалы) для 2.1"",
	|	КорАналитика.СтатьяКалькуляции.ТипЗатрат,
	|	""Материальные"",
	|	ДД.Организация,
	|	КорАналитика.МестоХранения,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор,
	|	КорАналитика.Назначение.НаправлениеДеятельности,
	|	КорАналитика.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	КорАналитика.Номенклатура,
	|	КорАналитика.Характеристика,
	|	КорАналитика.Серия,
	|	КорАналитика.Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.КорПартия,
	|	ДД.КорПартия,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|			ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|			ПО ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ((ДД.Регистратор Ссылка Документ.ВыпускПродукции И НЕ ВЫРАЗИТЬ(ДД.Регистратор КАК Документ.ВыпускПродукции).ВыпускПоРаспоряжениям)
	|		ИЛИ (ДД.Регистратор Ссылка Документ.РаспределениеПроизводственныхЗатрат И НЕ ВЫРАЗИТЬ(ДД.Регистратор КАК Документ.РаспределениеПроизводственныхЗатрат).НовоеПроизводство)
	//++ НЕ УТКА
	|		ИЛИ ДД.Регистратор Ссылка Документ.МаршрутныйЛистПроизводства
	//-- НЕ УТКА
	|		)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (отходы по фиксированной стоимости)"",
	|	Аналитика.СтатьяКалькуляции.ТипЗатрат,
	|	""Материальные"" КАК ВидЗатрат,
	|	ДД.Организация,
	|	Аналитика.МестоХранения,
	|	КорАналитика.МестоХранения,
	|	ДД.Регистратор,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.Партия,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|			ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
	|			ПО ДД.КорАналитикаУчетаНоменклатуры = КорАналитика.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.Партия
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И Аналитика.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (услуги переработчика) для 2.2"",
	|	Аналитика.СтатьяКалькуляции.ТипЗатрат,
	|	""Услуги"" КАК ВидЗатрат,
	|	ДД.Организация,
	|	Аналитика.МестоХранения,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.Партия,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.Партия
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 
	|	И Аналитика.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) 
	|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Расход из незавершенного производства (материалы) для 2.2"",
	|	Аналитика.СтатьяКалькуляции.ТипЗатрат,
	|	""Материальные"" КАК ВидЗатрат,
	|	ДД.Организация,
	|	Аналитика.МестоХранения,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	АналитикаПродукции.Номенклатура,
	|	АналитикаПродукции.Характеристика,
	|	АналитикаПродукции.Серия,
	|	АналитикаПродукции.Назначение,
	|	
	|	ДД.Партия,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
	|		ПО ДД.КорАналитикаУчетаНоменклатуры = АналитикаПродукции.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.Партия
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И Аналитика.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Расход из незавершенного производства (материалы) для 2.1"",
	|	Аналитика.СтатьяКалькуляции.ТипЗатрат,
	|	""Материальные"" КАК ВидЗатрат,
	|	ДД.Организация,
	|	Аналитика.МестоХранения,
	|	Аналитика.МестоХранения,
	|	ДД.Регистратор,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	АналитикаПродукции.Номенклатура,
	|	АналитикаПродукции.Характеристика,
	|	АналитикаПродукции.Серия,
	|	АналитикаПродукции.Назначение,
	|	
	|	ДД.Партия,
	|	ДД.Партия,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость + ДД.ДопРасходы + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеСНДС + ДД.ПостатейныеПеременныеСНДС
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл + ДД.ДопРасходыРегл + ДД.ТрудозатратыРегл + ДД.ПостатейныеПостоянныеРегл + ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС + ДД.ДопРасходыБезНДС + ДД.Трудозатраты + ДД.ПостатейныеПостоянныеБезНДС + ДД.ПостатейныеПеременныеБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр + ДД.ДопРасходыУпр + ДД.ТрудозатратыУпр + ДД.ПостатейныеПостоянныеУпр + ДД.ПостатейныеПеременныеУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансовая
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРегл
	|	КОНЕЦ,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
	|		ПО ДД.КорАналитикаУчетаНоменклатуры = АналитикаПродукции.Ссылка
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И ДД.Регистратор Ссылка Документ.ВыпускПродукции
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Конечный остаток (материалы)"",
	|	Аналитика.СтатьяКалькуляции.ТипЗатрат,
	|	ВЫБОР 
	|		КОГДА Аналитика.СтатьяКалькуляции.ТипЗатрат В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.Материальные),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.ВозвратныеОтходы))
	|			ТОГДА ""Материальные""
	|		ИНАЧЕ
	|			""Услуги""
	|	КОНЕЦ КАК ВидЗатрат,
	|	ДД.Организация,
	|	Аналитика.МестоХранения,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО,
	|	Аналитика.Назначение.НаправлениеДеятельности,
	|	Аналитика.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.Партия,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.КоличествоОстаток,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток + ДД.ДопРасходыОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеСНДСОстаток + ДД.ПостатейныеПеременныеСНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток + ДД.ДопРасходыРеглОстаток + ДД.ТрудозатратыРеглОстаток + ДД.ПостатейныеПостоянныеРеглОстаток + ДД.ПостатейныеПеременныеРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток + ДД.ДопРасходыБезНДСОстаток + ДД.ТрудозатратыОстаток + ДД.ПостатейныеПостоянныеБезНДСОстаток + ДД.ПостатейныеПеременныеБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток + ДД.ДопРасходыУпрОстаток + ДД.ТрудозатратыУпрОстаток + ДД.ПостатейныеПостоянныеУпрОстаток + ДД.ПостатейныеПеременныеУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазницаОстаток,
	|	ДД.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА 0
	|		КОГДА &ДанныеПоСебестоимости = 2 ИЛИ &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьЗабалансоваяОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьЗабалансоваяРеглОстаток
	|	КОНЕЦ
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(
	|			{(&ОкончаниеПериодаГраница)},
	|			АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|				И (АналитикаУчетаНоменклатуры.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	//++ НЕ УТКА
	|						ИЛИ Партия Ссылка Документ.ЗаказНаПроизводство
	//-- НЕ УТКА
	|			)) КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.Партия
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	// трудозатраты
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Начальный остаток (трудозатраты) для 2.2"" КАК Содержание,
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	ДД.КоличествоОстаток КАК аНачальныйОстатокКоличество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ДД.СтоимостьОстаток
	|	КОНЕЦ КАК аНачальныйОстатокСтоимость,
	|	0,
	|	0,
	|	0,
	|	
	|	0 КАК бПоступилоКоличество,
	|	0 КАК бПоступилоСтоимость,
	|	0 КАК бПоступилоПР,
	|	0 КАК бПоступилоВР,
	|	0 КАК бПоступилоЗабалансовая,
	|	
	|	0 КАК гРасходНаПроизводствоКоличество,
	|	0 КАК гРасходНаПроизводствоСтоимость,
	|	0 КАК гРасходНаПроизводствоПР,
	|	0 КАК гРасходНаПроизводствоВР,
	|	0 КАК гРасходНаПроизводствоЗабалансовая,
	|	
	|	0 КАК еКонечныйОстатокКоличество,
	|	0 КАК еКонечныйОстатокСтоимость,
	|	0 КАК еКонечныйОстатокПР,
	|	0 КАК еКонечныйОстатокВР,
	|	0 КАК еКонечныйОстатокЗабалансовая
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(
	|			{(&НачалоПериода)},
	|			(ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|				ИЛИ УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО)
	|			И НЕ &БезОтбораПоПериоду) КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Начальный остаток (трудозатраты) для 2.1"" КАК Содержание,
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.ЗаказНаПроизводство КАК Партия,
	|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	
	|	ДД.КоличествоОстаток КАК аНачальныйОстатокКоличество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ДД.СтоимостьОстаток
	|	КОНЕЦ КАК аНачальныйОстатокСтоимость,
	|	0,
	|	0,
	|	0,
	|	
	|	0 КАК бПоступилоКоличество,
	|	0 КАК бПоступилоСтоимость,
	|	0 КАК бПоступилоПР,
	|	0 КАК бПоступилоВР,
	|	0 КАК бПоступилоЗабалансовая,
	|	
	|	0 КАК гРасходНаПроизводствоКоличество,
	|	0 КАК гРасходНаПроизводствоСтоимость,
	|	0 КАК гРасходНаПроизводствоПР,
	|	0 КАК гРасходНаПроизводствоВР,
	|	0 КАК гРасходНаПроизводствоЗабалансовая,
	|	
	|	0 КАК еКонечныйОстатокКоличество,
	|	0 КАК еКонечныйОстатокСтоимость,
	|	0 КАК еКонечныйОстатокПР,
	|	0 КАК еКонечныйОстатокВР,
	|	0 КАК еКонечныйОстатокЗабалансовая
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(
	|			{(&НачалоПериода)},
	|			ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			И УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО
	|			И НЕ &БезОтбораПоПериоду) КАК ДД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (трудозатраты) для 2.2"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ДД.Стоимость
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И (ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|		ИЛИ ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (трудозатраты) для 2.1"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА ДД.ЗаказНаПроизводство Ссылка Документ.ЗаказНаПроизводство
	|			ТОГДА ДД.ЗаказНаПроизводство.НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.ЗаказНаПроизводство,
	|	ДД.ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ДД.Стоимость
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|	И ДД.УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Расход из незавершенного производства (трудозатраты) для 2.2"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.КорАналитикаУчетаПродукции,
	|	АналитикаПродукции.Номенклатура,
	|	АналитикаПродукции.Характеристика,
	|	АналитикаПродукции.Серия,
	|	АналитикаПродукции.Назначение,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ДД.Стоимость
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
	|		ПО ДД.КорАналитикаУчетаПродукции = АналитикаПродукции.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И (ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|		ИЛИ ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Расход из незавершенного производства (трудозатраты) для 2.1"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА ДД.ЗаказНаПроизводство Ссылка Документ.ЗаказНаПроизводство
	|			ТОГДА ДД.ЗаказНаПроизводство.НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.КорАналитикаУчетаПродукции,
	|	АналитикаПродукции.Номенклатура,
	|	АналитикаПродукции.Характеристика,
	|	АналитикаПродукции.Серия,
	|	АналитикаПродукции.Назначение,
	|
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА ДД.ЗаказНаПроизводство <> ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
	|			ТОГДА ДД.ЗаказНаПроизводство
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ДД.ДокументВыпуска
	|	КОНЕЦ КАК Партия,
	|	ДД.ЗаказНаПроизводство,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.Количество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ДД.Стоимость
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
	|	ПО ДД.КорАналитикаУчетаПродукции = АналитикаПродукции.Ссылка
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|	И ДД.УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Конечный остаток (трудозатраты) для 2.2"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.КоличествоОстаток,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ДД.СтоимостьОстаток
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(
	|			{(&ОкончаниеПериодаГраница)},
	|			ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|				ИЛИ УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО) КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Конечный остаток (трудозатраты) для 2.1"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Трудозатраты"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка),
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	Значение(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.ЗаказНаПроизводство,
	|	ДД.ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	ДД.КоличествоОстаток,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ДД.СтоимостьОстаток
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(
	|			{(&ОкончаниеПериодаГраница)},
	|			ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			И УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО) КАК ДД
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	// постатейные
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Начальный остаток (постатейные) для 2.2"" КАК Содержание,
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0                            КАК аНачальныйОстатокКоличество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ КАК аНачальныйОстатокСтоимость,
	|	ДД.ПостояннаяРазницаОстаток  КАК аНачальныйОстатокПР,
	|	ДД.ВременнаяРазницаОстаток   КАК аНачальныйОстатокВР,
	|	0                            КАК аНачальныйОстатокЗабалансовая,
	|	
	|	0 КАК бПоступилоКоличество,
	|	0 КАК бПоступилоСтоимость,
	|	0 КАК бПоступилоПР,
	|	0 КАК бПоступилоВР,
	|	0 КАК бПоступилоЗабалансовая,
	|	
	|	0 КАК гРасходНаПроизводствоКоличество,
	|	0 КАК гРасходНаПроизводствоСтоимость,
	|	0 КАК гРасходНаПроизводствоПР,
	|	0 КАК гРасходНаПроизводствоВР,
	|	0 КАК гРасходНаПроизводствоЗабалансовая,
	|	
	|	0 КАК еКонечныйОстатокКоличество,
	|	0 КАК еКонечныйОстатокСтоимость,
	|	0 КАК еКонечныйОстатокПР,
	|	0 КАК еКонечныйОстатокВР,
	|	0 КАК еКонечныйОстатокЗабалансовая
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(
	|			{(&НачалоПериода)},
	|			(ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|				ИЛИ УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО)
	|			И НЕ &БезОтбораПоПериоду) КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Начальный остаток (постатейные) для 2.1"" КАК Содержание,
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	ДД.ЗаказНаПроизводство.НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.ЗаказНаПроизводство,
	|	ДД.ЗаказНаПроизводство,
	|	
	|	0                            КАК аНачальныйОстатокКоличество,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ КАК аНачальныйОстатокСтоимость,
	|	ДД.ПостояннаяРазницаОстаток  КАК аНачальныйОстатокПР,
	|	ДД.ВременнаяРазницаОстаток   КАК аНачальныйОстатокВР,
	|	0                            КАК аНачальныйОстатокЗабалансовая,
	|	
	|	0 КАК бПоступилоКоличество,
	|	0 КАК бПоступилоСтоимость,
	|	0 КАК бПоступилоПР,
	|	0 КАК бПоступилоВР,
	|	0 КАК бПоступилоЗабалансовая,
	|	
	|	0 КАК гРасходНаПроизводствоКоличество,
	|	0 КАК гРасходНаПроизводствоСтоимость,
	|	0 КАК гРасходНаПроизводствоПР,
	|	0 КАК гРасходНаПроизводствоВР,
	|	0 КАК гРасходНаПроизводствоЗабалансовая,
	|	
	|	0 КАК еКонечныйОстатокКоличество,
	|	0 КАК еКонечныйОстатокСтоимость,
	|	0 КАК еКонечныйОстатокПР,
	|	0 КАК еКонечныйОстатокВР,
	|	0 КАК еКонечныйОстатокЗабалансовая
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(
	|			{(&НачалоПериода)},
	|			ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			И УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО
	|			И НЕ &БезОтбораПоПериоду) КАК ДД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (постатейные) для 2.2"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	Реквизиты.Подразделение,
	|	ДД.Регистратор,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Реквизиты
	|		ПО ДД.Регистратор = Реквизиты.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И (ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|		ИЛИ ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Поступило на незавершенное производство (постатейные) для 2.1"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	Реквизиты.Подразделение,
	|	ДД.Регистратор,
	|	ДД.ЗаказНаПроизводство.НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.ЗаказНаПроизводство,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА ДД.ЗаказНаПроизводство Ссылка Документ.ЗаказНаПроизводство
	|			ТОГДА ДД.ЗаказНаПроизводство
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Реквизиты
	|		ПО ДД.Регистратор = Реквизиты.Ссылка
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|	И ДД.УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Расход из незавершенного производства (постатейные) для 2.2"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.АналитикаУчетаПродукции,
	|	АналитикаПродукции.Номенклатура,
	|	АналитикаПродукции.Характеристика,
	|	АналитикаПродукции.Серия,
	|	АналитикаПродукции.Назначение,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
	|		ПО ДД.АналитикаУчетаПродукции = АналитикаПродукции.Ссылка
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И (ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|		ИЛИ ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Расход из незавершенного производства (постатейные) для 2.1"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.Подразделение,
	|	ДД.Регистратор,
	|	ДД.ЗаказНаПроизводство.НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.АналитикаУчетаПродукции,
	|	АналитикаПродукции.Номенклатура,
	|	АналитикаПродукции.Характеристика,
	|	АналитикаПродукции.Серия,
	|	АналитикаПродукции.Назначение,
	|
	|	ДД.ЗаказНаПроизводство,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА ДД.ЗаказНаПроизводство Ссылка Документ.ЗаказНаПроизводство
	|			ТОГДА ДД.ЗаказНаПроизводство
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.Стоимость
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДС
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпр
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДС
	|			ИНАЧЕ
	|				ДД.СтоимостьУпр
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница,
	|	0,
	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
	|	ПО ДД.АналитикаУчетаПродукции = АналитикаПродукции.Ссылка
	|ГДЕ
	|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			ИЛИ &БезОтбораПоПериоду)
	|	И ДД.ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|	И ДД.УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Конечный остаток (постатейные) для 2.2"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР
	|		КОГДА СпрПартииПроизводства.Ссылка ЕСТЬ НЕ NULL
	|			ТОГДА СпрПартииПроизводства.НаправлениеДеятельности
	//++ НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ЭтапПроизводства2_2)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ЭтапПроизводства2_2).НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ПроизводствоБезЗаказа)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ПроизводствоБезЗаказа).НаправлениеДеятельности
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.УдалитьПартияПроизводства) = ТИП(Документ.ОтчетПереработчика)
	|			ТОГДА ВЫРАЗИТЬ(ДД.УдалитьПартияПроизводства КАК Документ.ОтчетПереработчика).НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ВЫБОР
	|		КОГДА ДД.ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			ТОГДА ДД.ПартияПроизводства
	|		КОГДА ДД.УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ДД.УдалитьПартияПроизводства
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА СпрПартииПроизводства.Документ ЕСТЬ НЕ NULL
	|			И ТИПЗНАЧЕНИЯ(СпрПартииПроизводства.Документ) = ТИП(Документ.ЗаказНаПроизводство2_2)
	|			ТОГДА СпрПартииПроизводства.Документ
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство2_2.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазницаОстаток,
	|	ДД.ВременнаяРазницаОстаток,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(
	|			{(&ОкончаниеПериодаГраница)},
	|			ПартияПроизводства <> ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|				ИЛИ УдалитьПартияПроизводства <> НЕОПРЕДЕЛЕНО) КАК ДД
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""Производство"",
	|	""Конечный остаток (постатейные) для 2.1"",
	|	ДД.СтатьяКалькуляции.ТипЗатрат,
	|	""Постатейные"",
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка),
	|	НЕОПРЕДЕЛЕНО,
	|	ДД.ЗаказНаПроизводство.НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Значение(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	Значение(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	Значение(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
	|	
	|	// аналитика трудозатрат
	|	Значение(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
	|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияПродукции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК НазначениеПродукции,
	|
	|	ДД.ЗаказНаПроизводство,
	|	ВЫБОР
	//++ НЕ УТКА
	|		КОГДА ДД.ЗаказНаПроизводство Ссылка Документ.ЗаказНаПроизводство
	|			ТОГДА ДД.ЗаказНаПроизводство
	|		КОГДА ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	
	|	0,
	|	ВЫБОР
	|		КОГДА &ДанныеПоСебестоимости = 1
	|			ТОГДА ДД.СтоимостьОстаток
	|		КОГДА &ДанныеПоСебестоимости = 2
	|			ТОГДА ДД.СтоимостьБезНДСОстаток
	|		КОГДА &ДанныеПоСебестоимости = 3
	|			ТОГДА ДД.СтоимостьУпрОстаток
	|		КОГДА &ДанныеПоСебестоимости = 4
	|			ТОГДА ДД.СтоимостьРеглОстаток
	|		ИНАЧЕ
	|			ВЫБОР КОГДА &ПоПредприятию
	|				ТОГДА ДД.СтоимостьБезНДСОстаток
	|			ИНАЧЕ
	|				ДД.СтоимостьУпрОстаток
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ДД.ПостояннаяРазницаОстаток,
	|	ДД.ВременнаяРазницаОстаток,
	|	0
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(
	|			{(&ОкончаниеПериодаГраница)},
	|			ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|			И УдалитьПартияПроизводства = НЕОПРЕДЕЛЕНО) КАК ДД
	|) КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|
	|	ДД.Таблица,
	|	ДД.Содержание,
	|	ДД.ТипЗатрат,
	|	ДД.ВидЗатрат,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.ПодразделениеОтправитель,
	|	ДД.Регистратор,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяКалькуляции,
	|	
	|	// аналитика материала
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.Серия,
	|	ДД.Назначение,
	|	
	|	// аналитика трудозатрат
	|	ДД.ВидРабот,
	|	
	|	// аналитика постатейного расхода
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	
	|	// аналитика продукции
	|	ДД.АналитикаУчетаПродукции,
	|	ДД.Продукция,
	|	ДД.ХарактеристикаПродукции,
	|	ДД.СерияПродукции,
	|	ДД.НазначениеПродукции,
	|	
	|	ДД.ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство
	|";
	
	Ресурсы = Новый Массив;
	
	Ресурсы.Добавить("аНачальныйОстатокКоличество");
	Ресурсы.Добавить("аНачальныйОстатокСтоимость");
	Ресурсы.Добавить("аНачальныйОстатокПР");
	Ресурсы.Добавить("аНачальныйОстатокВР");
	Ресурсы.Добавить("аНачальныйОстатокЗабалансовая");
	
	Ресурсы.Добавить("бПоступилоКоличество");
	Ресурсы.Добавить("бПоступилоСтоимость");
	Ресурсы.Добавить("бПоступилоПР");
	Ресурсы.Добавить("бПоступилоВР");
	Ресурсы.Добавить("бПоступилоЗабалансовая");

	Ресурсы.Добавить("гРасходНаПроизводствоКоличество");
	Ресурсы.Добавить("гРасходНаПроизводствоСтоимость");
	Ресурсы.Добавить("гРасходНаПроизводствоПР");
	Ресурсы.Добавить("гРасходНаПроизводствоВР");
	Ресурсы.Добавить("гРасходНаПроизводствоЗабалансовая");

	Ресурсы.Добавить("еКонечныйОстатокКоличество");
	Ресурсы.Добавить("еКонечныйОстатокСтоимость");
	Ресурсы.Добавить("еКонечныйОстатокПР");
	Ресурсы.Добавить("еКонечныйОстатокВР");
	Ресурсы.Добавить("еКонечныйОстатокЗабалансовая");
	
	Возврат Новый Структура("ТекстЗапроса, Ресурсы", ТекстЗапроса, Ресурсы);

КонецФункции

//-- НЕ УТ

//++ НЕ УТКА

#Область ФоновоеЗаданиеРасходаТоваровОрганизацийНаПроизводство

// Процедура проверяет наличие записей в очереди к распределению товаров организаций на расход в производстве.
//  Если фоновых заданий не запущено, то запускает задание по распределению.
Процедура ПроверитьЗапуститьФоновоеРаспределениеТоваровОрганизацийНаПроизводство() Экспорт
	
	ПараметрыЗаданий = ЗатратыСервер.ПараметрыКРаспределениюТоваровОрганизаций();
	Для Каждого ТекПараметры Из ПараметрыЗаданий Цикл
		ЗатратыСервер.ЗапускВыполненияФоновогоРасходаТоваровОрганизацийНаПроизводство(ТекПараметры)
	КонецЦикла;
	
КонецПроцедуры

Функция ПараметрыКРаспределениюТоваровОрганизаций(Отборы = Неопределено) Экспорт
	
	Перем Организации, ПериодЗаполнения;
	
	ПоВсемОрганизациям = Истина;
	ПоВсемПериодамЗаполнения = Истина;
	
	Если Отборы <> Неопределено Тогда
		
		Отборы.Свойство("Организации", Организации);
		Отборы.Свойство("ПериодЗаполнения", ПериодЗаполнения);
		
		ПоВсемОрганизациям = Не ЗначениеЗаполнено(Организации);
		ПоВсемПериодамЗаполнения = Не ЗначениеЗаполнено(ПериодЗаполнения);
		
	КонецЕсли;
	
	НачатьТранзакцию();
	
	Попытка
		
		Результат = Новый Массив;
		Блокировка = Новый БлокировкаДанных;
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство");
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
		
		Блокировка.Заблокировать();
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Очередь.Организация,
		|	Очередь.Подразделение
		|ИЗ
		|	РегистрСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство КАК Очередь
		|
		|ГДЕ
		|	(Очередь.Организация В (&Организации) ИЛИ &ПоВсемОрганизациям)
		|	И (Очередь.ПериодЗаполнения <= &ПериодЗаполнения ИЛИ &ПоВсемПериодамЗаполнения)";
		
		Запрос.УстановитьПараметр("Организации", Организации);
		Запрос.УстановитьПараметр("ПоВсемОрганизациям", ПоВсемОрганизациям);
		Запрос.УстановитьПараметр("ПериодЗаполнения", ПериодЗаполнения);
		Запрос.УстановитьПараметр("ПоВсемПериодамЗаполнения", ПоВсемПериодамЗаполнения);
		
		УстановитьПривилегированныйРежим(Истина);
		Выборка = Запрос.Выполнить().Выбрать();
		УстановитьПривилегированныйРежим(Ложь);
		
		Пока Выборка.Следующий() Цикл
			Ключ = "РасходТоваровОрганизацийНаПроизводство"
				+ Строка(Выборка.Организация.УникальныйИдентификатор())
				+ Строка(Выборка.Подразделение.УникальныйИдентификатор());
			
			Отбор = Новый Структура();
			Отбор.Вставить("Ключ", Ключ);
			Отбор.Вставить("Состояние", СостояниеФоновогоЗадания.Активно);
			
			АктивныеЗадания = ФоновыеЗадания.ПолучитьФоновыеЗадания(Отбор);
			
			Если АктивныеЗадания.Количество() = 0 Тогда
				Результат.Добавить(Новый Структура("Организация, Подразделение", Выборка.Организация, Выборка.Подразделение));
			КонецЕсли;
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		
		КодОсновногоЯзыка = ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка();
		ТекстСообщения = НСтр("ru = 'Не удалось заблокировать регистр сведений ""Очередь расхода товаров организаций на производство"" для проверки работы фоновых заданий по причине: %Причина%';
								|en = 'Cannot lock the ""Queue of company goods consumption for production"" information register to check background jobs due to: %Причина%'",
			КодОсновногоЯзыка);
		
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
		ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Ошибка, , ,
			ТекстСообщения);
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

Процедура ДобавитьВОчередьРасходТоваровОрганизацийНаПроизводство(Организация, Подразделение, ЭтапыПроизводства, ПериодЗаполнения) Экспорт
	
	ТребуетсяЗапускЗадания = Ложь;
	
	Если ТипЗнч(ЭтапыПроизводства) = Тип("Массив") Тогда
		МассивЭтапов = ЭтапыПроизводства;
	Иначе
		МассивЭтапов = Новый Массив;
		МассивЭтапов.Добавить(ЭтапыПроизводства);
	КонецЕсли;
	
	Если МассивЭтапов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.УстановитьЗначение("Организация",Организация);
	ЭлементБлокировки.УстановитьЗначение("Подразделение",Подразделение);
	Блокировка.Заблокировать();
	
	НаборЗаписейОчереди = РегистрыСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство.СоздатьНаборЗаписей();
	
	НаборЗаписейОчереди.Отбор.Организация.Установить(Организация);
	НаборЗаписейОчереди.Отбор.Подразделение.Установить(Подразделение);
	
	НаборЗаписейОчереди.Прочитать();
	
	Если НаборЗаписейОчереди.Количество() = 0 Тогда
		ТребуетсяЗапускЗадания = Истина;
		Разделитель = 1;
	Иначе
		Разделитель = РегистрыСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство.РазделительНовойЗаписи(Организация, Подразделение);
	КонецЕсли;
	
	Для Каждого Этап Из МассивЭтапов Цикл
		
		ЗаписьОчереди = НаборЗаписейОчереди.Добавить();
		ЗаписьОчереди.Организация = Организация;
		ЗаписьОчереди.Подразделение = Подразделение;
		ЗаписьОчереди.Разделитель = Разделитель;
		ЗаписьОчереди.ЭтапПроизводства = Этап;
		ЗаписьОчереди.ПериодЗаполнения = ПериодЗаполнения;
		
	КонецЦикла;

	Попытка
		НаборЗаписейОчереди.Записать();
	Исключение
		
		ТекстСообщения = НСтр("ru = 'Не удалось сформировать очередь расхода материалов на производство по организации: %Организация%; подразделению: %Подразделение%';
								|en = 'Cannot generate queue of material consumption for production for the %Организация% company; the %Подразделение% department'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Организация%", Организация);
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Подразделение%", Подразделение);
		ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Ошибка,,, ТекстСообщения);
		
		ВызватьИсключение;
		
	КонецПопытки;
	
	Если ТребуетсяЗапускЗадания Тогда
		СтруктураПараметров = Новый Структура("Организация, Подразделение", Организация, Подразделение);
		ЗапускВыполненияФоновогоРасходаТоваровОрганизацийНаПроизводство(СтруктураПараметров);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗапускВыполненияФоновогоРасходаТоваровОрганизацийНаПроизводство(СтруктураПараметров) Экспорт
	
	НаименованиеЗадания = НСтр("ru = 'Формирование расхода товаров организаций на производство по организации: %Организация%; подразделению: %Подразделение%';
								|en = 'Generate company goods consumption for production by company: %Организация%; department: %Подразделение%'");
	НаименованиеЗадания = СтрЗаменить(НаименованиеЗадания, "%Организация%", СтруктураПараметров.Организация);
	НаименованиеЗадания = СтрЗаменить(НаименованиеЗадания, "%Подразделение%", СтруктураПараметров.Подразделение);
	
	ИмяЭкспортнойПроцедуры = "ЗатратыСервер.РасходТоваровОрганизацийНаПроизводство";
	
	МассивПараметров = Новый Массив();
	МассивПараметров.Добавить(СтруктураПараметров);
	
	ПараметрыЗадания = Новый Массив();
	ПараметрыЗадания.Добавить(ИмяЭкспортнойПроцедуры);
	ПараметрыЗадания.Добавить(МассивПараметров);
	
	Ключ = "РасходТоваровОрганизацийНаПроизводство"
	+ Строка(СтруктураПараметров.Организация.УникальныйИдентификатор())
	+ Строка(СтруктураПараметров.Подразделение.УникальныйИдентификатор());
	
	Отбор = Новый Структура();
	Отбор.Вставить("Ключ", Ключ);
	Отбор.Вставить("Состояние", СостояниеФоновогоЗадания.Активно);
	
	АктивныеЗадания = ФоновыеЗадания.ПолучитьФоновыеЗадания(Отбор);
	
	Если АктивныеЗадания.Количество() > 0 Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		ФоновыеЗадания.Выполнить("ОбщегоНазначения.ВыполнитьМетодКонфигурации", ПараметрыЗадания, Ключ, НаименованиеЗадания);
	Исключение
		ТекстСообщения = НСтр("ru = 'Не удалось запустить задание по расходу материалов на производство по причине: %Причина%';
								|en = 'Cannot run the material consumption job for production due to: %Причина%'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Ошибка,
			Метаданные.Документы.ЭтапПроизводства2_2,
			,
			ТекстСообщения);
	КонецПопытки;
	
КонецПроцедуры

Процедура РасходТоваровОрганизацийНаПроизводство(ПараметрыЗадания) Экспорт
	
	Организация = ПараметрыЗадания.Организация;
	Подразделение = ПараметрыЗадания.Подразделение;
	
	ПараметрыРасчета = Неопределено;
	ПараметрыЗадания.Свойство("ПараметрыРасчета", ПараметрыРасчета);
	
	Если ПараметрыЗадания.Свойство("КоличествоОшибок") Тогда
		
		МаксимальноеКоличествоОшибок = 3;
		
		Если ПараметрыЗадания.КоличествоОшибок >= МаксимальноеКоличествоОшибок Тогда
			
			ТекстСообщения = НСтр("ru = 'Распределение товаров на производство остановлено по организации: %Организация%; подразделению: %Подразделение%. Количество неудачных попыток: %КоличествоОшибок%';
									|en = 'Allocation of goods to production is stopped for company: %Организация%; department %Подразделение%. The number of failed attempts: %КоличествоОшибок%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Организация%", Организация);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Подразделение%", Подразделение);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%КоличествоОшибок%", ПараметрыЗадания.КоличествоОшибок);
			
			Если ПараметрыРасчета <> Неопределено Тогда
				
				ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
					ПараметрыРасчета,
					Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаВосстановленияДвиженийДокументов,
					ТекстСообщения,
					ТекстСообщения);
				
				УниверсальныеМеханизмыПартийИСебестоимости.ЗарегистрироватьПроблемуВыполненияРасчета(
					ПараметрыРасчета,
					Организация,
					НСтр("ru = 'Не удалось исправить проблемы в движениях документов';
						|en = 'Cannot fix the issues in the document records'"),
					ТекстСообщения);
				
			Иначе
				ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка, , ,
				ТекстСообщения);
			КонецЕсли;
			
			Возврат;
		КонецЕсли;
	Иначе
		ПараметрыЗадания.Вставить("КоличествоОшибок", 0);
	КонецЕсли;
	
	ЕстьОшибка = Ложь;
	
	Разделитель = 0;
	Пока ПроверитьНаличиеЗаписейВОчередиРасходаТоваровОрганизацийНаПроизводство(ПараметрыЗадания, Разделитель) Цикл
		ЕстьОшибка = СформироватьРасходТоваровОрганизацийНаПроизводство(ПараметрыЗадания);
		Если ЕстьОшибка Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция СформироватьРасходТоваровОрганизацийНаПроизводство(ПараметрыЗадания)
	
	ЕстьОшибка = Ложь;
	
	Если ПараметрыЗадания.ТаблицаЭтапов.Количество() = 0 Тогда
		Возврат ЕстьОшибка;
	КонецЕсли;
	
	ТаблицаВидовЗапасов = Новый ТаблицаЗначений;
	ТаблицаВидовЗапасов.Колонки.Добавить("АналитикаУчетаНоменклатуры", Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаНоменклатуры"));
	ТаблицаВидовЗапасов.Колонки.Добавить("СтатьяКалькуляции",          Новый ОписаниеТипов("СправочникСсылка.СтатьиКалькуляции"));
	ТаблицаВидовЗапасов.Колонки.Добавить("ВидЗапасов",                 Новый ОписаниеТипов("СправочникСсылка.ВидыЗапасов"));
	ТаблицаВидовЗапасов.Колонки.Добавить("ВидЗапасовПолучателя",       Новый ОписаниеТипов("СправочникСсылка.ВидыЗапасов"));
	ТаблицаВидовЗапасов.Колонки.Добавить("НомерГТД",                   Новый ОписаниеТипов("СправочникСсылка.НомераГТД"));
	ТаблицаВидовЗапасов.Колонки.Добавить("Количество",                 Новый ОписаниеТипов("Число"));
	ТаблицаВидовЗапасов.Колонки.Добавить("ДатаОтгрузки",               Новый ОписаниеТипов("Дата"));
	
	Для Каждого СтрокаТаблицы Из ПараметрыЗадания.ТаблицаЭтапов Цикл
		
		НачатьТранзакцию();
		
		Попытка
			
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить("Документ.ЭтапПроизводства2_2");
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
			ЭлементБлокировки.УстановитьЗначение("Ссылка", СтрокаТаблицы.Этап);
			
			Если ОбщегоНазначения.ИнформационнаяБазаФайловая() Тогда
				// Установка исключительной блокировки до чтения движений этапа в процедуре ВременныеТаблицыРасходаЭтапаПроизводства.
				// Блокировка здесь нужна файлового варианта, чтобы ожидание на блокировке выполнялось именно здесь.
				// Иначе в ВременныеТаблицыРасходаЭтапаПроизводства будет наложена разделяемая блокировка, а исключительная в ЗаполнитьВидыЗапасовПоТоварамОрганизаций.
				// При этом, ожидание на блокировке в ЗаполнитьВидыЗапасовПоТоварамОрганизаций будет приводить к конфликту,
				// поскольку другая транзакция не может завершиться, пока активна разделяемая блокировка этих регистров.
				ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ТоварыОрганизаций.НаборЗаписей");
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
				ЭлементБлокировки.УстановитьЗначение("Регистратор", СтрокаТаблицы.Этап);
				
				ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.РезервыТоваровОрганизаций.НаборЗаписей");
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
				ЭлементБлокировки.УстановитьЗначение("Регистратор", СтрокаТаблицы.Этап);
				
				ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ТоварыКОформлениюОтчетовКомитенту.НаборЗаписей");
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
				ЭлементБлокировки.УстановитьЗначение("Регистратор", СтрокаТаблицы.Этап);
				
				ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.СебестоимостьТоваров.НаборЗаписей");
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
				ЭлементБлокировки.УстановитьЗначение("Регистратор", СтрокаТаблицы.Этап);
			КонецЕсли;
			
			Блокировка.Заблокировать();
			
			Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СтрокаТаблицы.Этап, "Организация, Ответственный, Подразделение, Дата, ВыпускПодДеятельность, Ссылка");
			Реквизиты.Вставить("ВидыЗапасов", ТаблицаВидовЗапасов);
			Реквизиты.Вставить("ДополнительныеСвойства", Новый Структура);
			Реквизиты.Вставить("Движения", Новый Массив);
			Реквизиты.Движения.Добавить("ТоварыОрганизаций");
			Реквизиты.Движения.Добавить("РезервыТоваровОрганизаций");
			Реквизиты.Движения.Добавить("ТоварыКОформлениюОтчетовКомитенту");
			
			Отказ = Ложь;
			
			ПараметрыЗаполнения = ЗапасыСервер.ПараметрыЗаполненияВидовЗапасов();
			
			ПараметрыЗаполнения.ОтборыВидовЗапасов.ТипЗапасов.Добавить(Перечисления.ТипыЗапасов.МатериалДавальца);
			ПараметрыЗаполнения.ОтборыВидовЗапасов.ТипЗапасов.Добавить(Перечисления.ТипыЗапасов.ПродукцияДавальца);
			ПараметрыЗаполнения.НалогообложениеНДС = Реквизиты.ВыпускПодДеятельность;
			ПараметрыЗаполнения.ТаблицаВидыЗапасов = ТаблицаВидовЗапасов;
			ПараметрыЗаполнения.ПодбиратьЗапасыРазныхПериодов = Истина;
			ПараметрыЗаполнения.ПериодЗаполнения = СтрокаТаблицы.ПериодЗаполнения;
			ПараметрыЗаполнения.СообщатьОбОшибкахЗаполнения = Ложь;
			ПараметрыЗаполнения.ПриНехваткеТоваровОрганизацииЗаполнятьВидамиЗапасовПоУмолчанию = Ложь;
			ПараметрыЗаполнения.ЭтоРасходТоваровОрганизацийНаПроизводство = Истина;
			ПараметрыЗаполнения.ПодбиратьВТЧТоварыПринятыеНаОтветственноеХранение = "Никогда";
			
			УстановитьПривилегированныйРежим(Истина);
				МенеджерВременныхТаблиц = ВременныеТаблицыРасходаЭтапаПроизводства(СтрокаТаблицы.Этап, СтрокаТаблицы.ПериодЗаполнения);
				ЗапасыСервер.ЗаполнитьВидыЗапасовПоТоварамОрганизаций(Реквизиты, МенеджерВременныхТаблиц, Отказ, ПараметрыЗаполнения);
			УстановитьПривилегированныйРежим(Ложь);
			
			ЗаполнитьАналитикуПолучателяРасходаЭтаповПроизводства(МенеджерВременныхТаблиц, ПараметрыЗаполнения.ТаблицаВидыЗапасов);
			
			УстановитьПривилегированныйРежим(Истина);
				НаборыЗаписей = НаборыЗаписейОтложенногоПроведенияЭтапаПроизводства(Реквизиты, ПараметрыЗаполнения, СтрокаТаблицы);
			
				Для Каждого НаборЗаписей Из НаборыЗаписей Цикл
					НаборЗаписей.Записать();
				КонецЦикла;
			УстановитьПривилегированныйРежим(Ложь);
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			
			ТекстСообщения = НСтр("ru = 'Не удалось распределить товары на производство по документу: %1 по причине: %2';
									|en = 'Cannot allocate goods to production for the %1 document due to: %2'");
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, СтрокаТаблицы.Этап, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			
			ПараметрыРасчета = Неопределено;
			ПараметрыЗадания.Свойство("ПараметрыРасчета", ПараметрыРасчета);
			
			Если ПараметрыРасчета <> Неопределено Тогда
				
				ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
					ПараметрыРасчета,
					Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаВосстановленияДвиженийДокументов,
					ТекстСообщения,
					ТекстСообщения);
				
				УниверсальныеМеханизмыПартийИСебестоимости.ЗарегистрироватьПроблемуВыполненияРасчета(
					ПараметрыРасчета,
					Реквизиты.Организация,
					НСтр("ru = 'Не удалось исправить проблемы в движениях документов';
						|en = 'Cannot fix the issues in the document records'"),
					ТекстСообщения);
				
			Иначе
				ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(),
					УровеньЖурналаРегистрации.Ошибка,
					Метаданные.Документы.ЭтапПроизводства2_2,
					,
					ТекстСообщения);
				
			КонецЕсли;
			
			ЕстьОшибка = Истина;
			
			Прервать;
			
		КонецПопытки;
		
		ТаблицаВидовЗапасов.Очистить();
		
	КонецЦикла;
	
	Возврат ЕстьОшибка;
	
КонецФункции

Функция НаборыЗаписейОтложенногоПроведенияЭтапаПроизводства(Реквизиты, ПараметрыЗаполнения, ПараметрыЗадания)
	
	ИменаРегистров = Новый Структура("ТоварыОрганизаций, ТоварыКОформлениюОтчетовКомитенту, СебестоимостьТоваров");
	
	ДополнительныеСвойства = Реквизиты.ДополнительныеСвойства;
	ДополнительныеСвойства.Вставить("ЭтоНовый", Ложь);
	ДополнительныеСвойства.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
	ДополнительныеСвойства.Вставить("ПериодЗаполненияВидовЗапасовИСебестоимости", ПараметрыЗаполнения.ПериодЗаполнения);
	ДополнительныеСвойства.Вставить("ТаблицаВидыЗапасов", ПараметрыЗаполнения.ТаблицаВидыЗапасов);
	ДополнительныеСвойства.Вставить("ТаблицаРезервыТоваровОрганизаций", Реквизиты.ДополнительныеСвойства.ТаблицаРезервыТоваровОрганизаций);
	
	ПроведениеСерверУТ.ИнициализироватьДополнительныеСвойстваДляПроведения(Реквизиты.Ссылка, ДополнительныеСвойства);
	Документы.ЭтапПроизводства2_2.ИнициализироватьДанныеДокументаОтложенно(Реквизиты.Ссылка, ДополнительныеСвойства, ИменаРегистров);
	
	Результат = Новый Массив;
	
	Для Каждого ИмяРегистра Из ИменаРегистров Цикл
		МенеджерРегистра = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени("РегистрНакопления." + ИмяРегистра.Ключ);
		НаборЗаписей = МенеджерРегистра.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(Реквизиты.Ссылка);
		НаборЗаписей.Загрузить(ДополнительныеСвойства.ТаблицыДляДвижений["Таблица" + ИмяРегистра.Ключ]);
		ПроведениеСерверУТ.ЗаполнитьДополнительныеСвойстваНабораПоДокументу(Реквизиты, НаборЗаписей);
		
		ДополнитьНаборыЗаписямиИзИБ(НаборЗаписей, Реквизиты.Ссылка, ПараметрыЗаполнения.ПериодЗаполнения, ДополнительныеСвойства);
		
		Результат.Добавить(НаборЗаписей);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ПроверитьНаличиеЗаписейВОчередиРасходаТоваровОрганизацийНаПроизводство(ПараметрыЗадания, Разделитель)
	
	Организация = ПараметрыЗадания.Организация;
	Подразделение = ПараметрыЗадания.Подразделение;
	ПараметрыРасчета = Неопределено;
	ПараметрыЗадания.Свойство("ПараметрыРасчета", ПараметрыРасчета);
	
	НачатьТранзакцию();
	
	Попытка
		
		Блокировка = Новый БлокировкаДанных;
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство");
		
		// При первом проходе очистка очереди не требуется.
		// При втором и последующих проходах устанавливается исключительная блокировка т.к. возможна очистка очереди.
		Если Разделитель = 0 Тогда
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
		Иначе
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		КонецЕсли;
		
		ЭлементБлокировки.УстановитьЗначение("Организация", Организация);
		ЭлементБлокировки.УстановитьЗначение("Подразделение", Подразделение);
		
		Блокировка.Заблокировать();
		
		ЕстьЗаписиВОчереди = ТребуетсяСформироватьРасходТоваровОрганизацийНаПроизводство(ПараметрыЗадания, Разделитель);
		
		Если Не ЕстьЗаписиВОчереди И Разделитель > 0 Тогда
			НаборЗаписей = РегистрыСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Организация.Установить(Организация);
			НаборЗаписей.Отбор.Подразделение.Установить(Подразделение);
			УстановитьПривилегированныйРежим(Истина);
			НаборЗаписей.Записать();
			УстановитьПривилегированныйРежим(Ложь);
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		
		ЕстьЗаписиВОчереди = Истина;
		ПараметрыЗадания.КоличествоОшибок = ПараметрыЗадания.КоличествоОшибок + 1;
		
		КодОсновногоЯзыка = ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка();
		ТекстСообщения = НСтр("ru = 'Не удалось проверить наличие записей в очереди к распределению товаров на производство пр организации: %Организация%; подразделение: %Подразделение%';
								|en = 'Cannot check if there are entries in the queue to allocate goods to production in the %Организация% company; the %Подразделение% department'",
			КодОсновногоЯзыка);
		
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Организация%", Организация);
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Подразделение%", Подразделение);
		
		Если ПараметрыРасчета <> Неопределено Тогда
			
			ПротоколРасчетаПартийИСебестоимости.ЗафиксироватьОшибкуРасчета(
				ПараметрыРасчета,
				Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаВосстановленияДвиженийДокументов,
				ТекстСообщения,
				ТекстСообщения);
			
			УниверсальныеМеханизмыПартийИСебестоимости.ЗарегистрироватьПроблемуВыполненияРасчета(
				ПараметрыРасчета,
				Организация,
				НСтр("ru = 'Не удалось исправить проблемы в движениях документов';
					|en = 'Cannot fix the issues in the document records'"),
				ТекстСообщения);
			
		Иначе
			ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка, , ,
				ТекстСообщения);
			
		КонецЕсли;
		
	КонецПопытки;
	
	Возврат ЕстьЗаписиВОчереди;
	
КонецФункции

Функция ТребуетсяСформироватьРасходТоваровОрганизацийНаПроизводство(ПараметрыЗадания, Разделитель)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Очередь.Организация      КАК Организация,
	|	Очередь.Подразделение    КАК Подразделение,
	|	Очередь.ЭтапПроизводства КАК Этап,
	|	МИНИМУМ(Очередь.ПериодЗаполнения)  КАК ПериодЗаполнения
	|ИЗ
	|	РегистрСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство КАК Очередь
	|ГДЕ
	|	Очередь.Организация = &Организация
	|	И Очередь.Подразделение = &Подразделение
	|	И Очередь.Разделитель > &Разделитель
	|
	|СГРУППИРОВАТЬ ПО
	|	Очередь.Организация,
	|	Очередь.Подразделение,
	|	Очередь.ЭтапПроизводства
	|
	|;
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(Очередь.Разделитель)  КАК Разделитель
	|ИЗ
	|	РегистрСведений.ЗаданияКРаспределениюТоваровОрганизацийНаПроизводство КАК Очередь
	|ГДЕ
	|	Очередь.Организация = &Организация
	|	И Очередь.Подразделение = &Подразделение
	|	И Очередь.Разделитель > &Разделитель
	|
	|СГРУППИРОВАТЬ ПО
	|	Очередь.Организация,
	|	Очередь.Подразделение";
	
	Запрос.УстановитьПараметр("Организация", ПараметрыЗадания.Организация);
	Запрос.УстановитьПараметр("Подразделение", ПараметрыЗадания.Подразделение);
	Запрос.УстановитьПараметр("Разделитель", Разделитель);
	
	УстановитьПривилегированныйРежим(Истина);
	Результаты = Запрос.ВыполнитьПакет();
	УстановитьПривилегированныйРежим(Ложь);
	
	ТаблицаЭтапов = Результаты[0].Выгрузить();
	
	ПараметрыЗадания.Вставить("ТаблицаЭтапов", ТаблицаЭтапов);
	
	Если Не Результаты[1].Пустой() Тогда
		Выборка = Результаты[1].Выбрать();
		Выборка.Следующий();
		Разделитель = Выборка.Разделитель;
	КонецЕсли;
	
	Возврат ТаблицаЭтапов.Количество() <> 0;
	
КонецФункции

Функция ВременныеТаблицыРасходаЭтапаПроизводства(Этап, ПериодЗаполнения) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	ЭтапПроизводства.Дата                                     КАК Дата,
	|	ЭтапПроизводства.Организация                              КАК Организация,
	|	Неопределено                                              КАК Партнер,
	|	Неопределено                                              КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.СоглашенияСПоставщиками.ПустаяСсылка) КАК Соглашение,
	|	ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)    КАК Договор,
	|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)                  КАК Валюта,
	|	ЭтапПроизводства.ВыпускПодДеятельность                    КАК НалогообложениеНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства) КАК ХозяйственнаяОперация,
	|	ЛОЖЬ                                                      КАК ЕстьСделкиВТабличнойЧасти,
	|	ВЫБОР КОГДА СтруктураПредприятия.ВариантОбособленногоУчетаТоваров = ЗНАЧЕНИЕ(Перечисление.ВариантыОбособленногоУчетаТоваров.ПоПодразделению)
	|		И &ФормироватьВидыЗапасовПоПодразделениямМенеджерам
	|	ТОГДА
	|		ЭтапПроизводства.Подразделение
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ                                                     КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)            КАК Менеджер,
	|	ЗНАЧЕНИЕ(Справочник.СделкиСКлиентами.ПустаяСсылка)        КАК Сделка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)                  КАК ТипЗапасов
	|ПОМЕСТИТЬ ТаблицаДанныхДокумента
	|ИЗ
	|	Документ.ЭтапПроизводства2_2 КАК ЭтапПроизводства
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СтруктураПредприятия КАК СтруктураПредприятия
	|	ПО СтруктураПредприятия.Ссылка = ЭтапПроизводства.Подразделение
	|ГДЕ
	|	ЭтапПроизводства.Ссылка = &Ссылка
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Организация                         КАК Организация,
	|	ТаблицаТоваров.НомерСтроки                    КАК НомерСтроки,
	|	ТаблицаТоваров.Номенклатура                   КАК Номенклатура,
	|	ТаблицаТоваров.Характеристика                 КАК Характеристика,
	|	ТаблицаТоваров.Серия                          КАК Серия,
	|	ТаблицаТоваров.СтатусУказанияСерий            КАК СтатусУказанияСерий,
	|	ТаблицаТоваров.СтатьяКалькуляции              КАК СтатьяКалькуляции,
	|	Реквизиты.Подразделение                       КАК Склад,
	|	Реквизиты.Назначение                          КАК Назначение,
	|	Аналитика.КлючАналитики                       КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.АналитикаУчетаНоменклатуры     КАК КорАналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.Количество                     КАК Количество,
	|	ТаблицаТоваров.ДатаРасхода                    КАК ДатаОтгрузки,
	|	НЕОПРЕДЕЛЕНО                                  КАК ДатаПоступления,
	|	НЕОПРЕДЕЛЕНО                                  КАК ДокументРеализации,
	|	ЗНАЧЕНИЕ(Справочник.СделкиСКлиентами.ПустаяСсылка) КАК Сделка,
	|	ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.ПустаяСсылка) КАК СтавкаНДС,
	|	0                                             КАК СуммаСНДС,
	|	0                                             КАК СуммаНДС,
	|	0                                             КАК СуммаВознаграждения,
	|	0                                             КАК СуммаНДСВознаграждения,
	|	НЕОПРЕДЕЛЕНО                                  КАК ГруппаПродукции,
	|	ИСТИНА                                        КАК ПодбиратьВидыЗапасов,
	|	ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)   КАК НомерГТД,
	|	Реквизиты.ПартияПроизводства                  КАК ПартияПроизводства
	|ПОМЕСТИТЬ втТаблицаТоваров
	|ИЗ
	|	Документ.ЭтапПроизводства2_2.РасходМатериаловИРабот КАК ТаблицаТоваров
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|		ПО ТаблицаТоваров.Ссылка = Реквизиты.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|		ПО ТаблицаТоваров.Номенклатура = Аналитика.Номенклатура
	|		И ТаблицаТоваров.Характеристика = Аналитика.Характеристика
	|		И Реквизиты.Подразделение = Аналитика.МестоХранения
	|		И (ВЫБОР
	|				КОГДА ТаблицаТоваров.СтатусУказанияСерий = 14
	|					ТОГДА ТаблицаТоваров.Серия
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|		КОНЕЦ = Аналитика.Серия)
	|		И Реквизиты.Назначение = Аналитика.Назначение
	|		И ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) = Аналитика.СтатьяКалькуляции
	|
	|ГДЕ
	|	ТаблицаТоваров.ДатаРасхода >= &ПериодЗаполнения
	|	И Реквизиты.Ссылка = &Ссылка
	|
	|;
	|//////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТоваров.НомерСтроки                    КАК НомерСтроки,
	|	ТаблицаТоваров.Номенклатура                   КАК Номенклатура,
	|	ТаблицаТоваров.Характеристика                 КАК Характеристика,
	|	ТаблицаТоваров.Серия                          КАК Серия,
	|	ТаблицаТоваров.СтатусУказанияСерий            КАК СтатусУказанияСерий,
	|	ТаблицаТоваров.СтатьяКалькуляции              КАК СтатьяКалькуляции,
	|	ТаблицаТоваров.Склад                          КАК Склад,
	|	ТаблицаТоваров.Назначение                     КАК Назначение,
	|	ТаблицаТоваров.АналитикаУчетаНоменклатуры     КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.КорАналитикаУчетаНоменклатуры  КАК КорАналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.Количество                     КАК Количество,
	|	ТаблицаТоваров.ДатаОтгрузки                   КАК ДатаОтгрузки,
	|	ТаблицаТоваров.ДатаПоступления                КАК ДатаПоступления,
	|	ТаблицаТоваров.ДокументРеализации             КАК ДокументРеализации,
	|	ТаблицаТоваров.Сделка                         КАК Сделка,
	|	ТаблицаТоваров.СтавкаНДС                      КАК СтавкаНДС,
	|	ТаблицаТоваров.СуммаСНДС                      КАК СуммаСНДС,
	|	ТаблицаТоваров.СуммаНДС                       КАК СуммаНДС,
	|	ТаблицаТоваров.СуммаВознаграждения            КАК СуммаВознаграждения,
	|	ТаблицаТоваров.СуммаНДСВознаграждения         КАК СуммаНДСВознаграждения,
	|	ТаблицаТоваров.ГруппаПродукции                КАК ГруппаПродукции,
	|	ТаблицаТоваров.ПодбиратьВидыЗапасов           КАК ПодбиратьВидыЗапасов,
	|	ТаблицаТоваров.НомерГТД                       КАК НомерГТД,
	|	ТаблицаТоваров.ПартияПроизводства             КАК ПартияПроизводства
	|ПОМЕСТИТЬ ТаблицаТоваров
	|ИЗ
	|	втТаблицаТоваров КАК ТаблицаТоваров
	|
	|;
	|//////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	0                                              КАК НомерСтроки,
	|	ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры  КАК АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура                         КАК Номенклатура,
	|	Аналитика.Характеристика                       КАК Характеристика,
	|	Аналитика.Серия                                КАК Серия,
	|	Аналитика.Подразделение                        КАК Склад,
	|	Аналитика.Назначение                           КАК Назначение,
	|	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)       КАК СкладОтгрузки,
	|	НЕОПРЕДЕЛЕНО                                   КАК ДокументРеализации,
	|	ТаблицаВидыЗапасов.ВидЗапасов                  КАК ВидЗапасов,
	|	ТаблицаВидыЗапасов.НомерГТД                    КАК НомерГТД,
	|	ТаблицаВидыЗапасов.Количество                  КАК Количество,
	|	НЕОПРЕДЕЛЕНО                                   КАК Сделка,
	|	НЕОПРЕДЕЛЕНО                                   КАК ГруппаПродукции,
	|	ТаблицаВидыЗапасов.Период                      КАК ДатаОтгрузки,
	|	ЛОЖЬ                                           КАК ВидыЗапасовУказаныВручную
	|	
	|ПОМЕСТИТЬ ТаблицаВидыЗапасовПоПериодам
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ТаблицаВидыЗапасов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2 КАК Реквизиты
	|		ПО ТаблицаВидыЗапасов.Регистратор = Реквизиты.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТаблицаВидыЗапасов.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|ГДЕ
	|	Реквизиты.Ссылка = &Ссылка
	|	И ТаблицаВидыЗапасов.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|	И ТаблицаВидыЗапасов.Период >= &ПериодЗаполнения
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КОНЕЦПЕРИОДА(ТаблицаТоваров.ДатаОтгрузки, МЕСЯЦ) КАК Период
	|ПОМЕСТИТЬ ТаблицаПериодов
	|ИЗ
	|	ТаблицаТоваров КАК ТаблицаТоваров
	|ГДЕ
	|	ТаблицаТоваров.ДатаОтгрузки >= &ПериодЗаполнения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Резервы.Период КАК Период,
	|	Резервы.Регистратор КАК Регистратор,
	|	Резервы.НомерСтроки КАК НомерСтроки,
	|	Резервы.Активность КАК Активность,
	|	Резервы.ВидДвижения КАК ВидДвижения,
	|	Резервы.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Резервы.Организация КАК Организация,
	|	Резервы.ВидЗапасов КАК ВидЗапасов,
	|	Резервы.НомерГТД КАК НомерГТД,
	|	Резервы.Количество КАК Количество,
	|	Резервы.КорОрганизация КАК КорОрганизация,
	|	Резервы.КорВидЗапасов КАК КорВидЗапасов
	|ПОМЕСТИТЬ ДвиженияРезервыТоварыОрганизацийПередЗаписью
	|ИЗ
	|	РегистрНакопления.РезервыТоваровОрганизаций КАК Резервы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиАналитикиУчетаНоменклатуры
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
	|			ПО КлючиАналитикиУчетаНоменклатуры.Назначение = Назначения.Ссылка
	|		ПО Резервы.АналитикаУчетаНоменклатуры = КлючиАналитикиУчетаНоменклатуры.Ссылка
	|ГДЕ
	|	Назначения.Заказ = &Ссылка
	|");
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("Ссылка", Этап);
	Запрос.УстановитьПараметр("ФормироватьВидыЗапасовПоПодразделениямМенеджерам", ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоПодразделениямМенеджерам"));
	Запрос.УстановитьПараметр("ПериодЗаполнения", ПериодЗаполнения);
	
	ЗапасыСервер.ДополнитьВременныеТаблицыОбязательнымиКолонками(Запрос);
	
	Запрос.Выполнить();
	
	Возврат МенеджерВременныхТаблиц;
	
КонецФункции

Процедура ЗаполнитьАналитикуПолучателяРасходаЭтаповПроизводства(МенеджерВременныхТаблиц, ТаблицаВидыЗапасов)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаТоваров.АналитикаУчетаНоменклатуры          КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.Номенклатура.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	ТаблицаТоваров.Организация                         КАК Организация,
	|	КОНЕЦПЕРИОДА(ТаблицаТоваров.ДатаОтгрузки, МЕСЯЦ)   КАК Период,
	|	ТаблицаТоваров.ДатаОтгрузки                        КАК ДатаОтгрузки,
	|	ТаблицаТоваров.СтатьяКалькуляции                   КАК СтатьяКалькуляции,
	|	СУММА(ТаблицаТоваров.Количество)                   КАК Количество
	|ИЗ
	|	втТаблицаТоваров КАК ТаблицаТоваров
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваров.АналитикаУчетаНоменклатуры,
	|	ТаблицаТоваров.ДатаОтгрузки,
	|	ТаблицаТоваров.СтатьяКалькуляции,
	|	ТаблицаТоваров.Организация,
	|	ТаблицаТоваров.Номенклатура.ГруппаФинансовогоУчета
	|
	|УПОРЯДОЧИТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	ДатаОтгрузки,
	|	Количество УБЫВ";
	
	ВыборкаТовары = Запрос.Выполнить().Выбрать();
	
	ОтборТоваров = Новый Структура("АналитикаУчетаНоменклатуры, Период");
	
	ТаблицаВидыЗапасов.Свернуть("АналитикаУчетаНоменклатуры, СтатьяКалькуляции, ВидЗапасов, ВидЗапасовПолучателя, НомерГТД, Период, ДатаОтгрузки", "Количество");
	
	ТипыЗапасов = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(ТаблицаВидыЗапасов.ВыгрузитьКолонку("ВидЗапасов"), "ТипЗапасов");
	
	Пока ВыборкаТовары.Следующий() Цикл
		
		КоличествоТоваров = ВыборкаТовары.Количество;
		
		ЗаполнитьЗначенияСвойств(ОтборТоваров, ВыборкаТовары);
		
		Для Каждого СтрокаЗапасов Из ТаблицаВидыЗапасов.НайтиСтроки(ОтборТоваров) Цикл
			
			Если СтрокаЗапасов.Количество = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Количество = Мин(КоличествоТоваров, СтрокаЗапасов.Количество);
			
			НоваяСтрока = ТаблицаВидыЗапасов.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаЗапасов);
			
			НоваяСтрока.СтатьяКалькуляции = ВыборкаТовары.СтатьяКалькуляции;
			НоваяСтрока.ДатаОтгрузки = ВыборкаТовары.ДатаОтгрузки;
			НоваяСтрока.Количество = Количество;
			
			Если ТипыЗапасов[СтрокаЗапасов.ВидЗапасов] = Перечисления.ТипыЗапасов.КомиссионныйТовар Тогда
				НоваяСтрока.ВидЗапасовПолучателя = Справочники.ВидыЗапасов.ВидЗапасовДокумента(ВыборкаТовары.Организация, , ВыборкаТовары);
			Иначе
				НоваяСтрока.ВидЗапасовПолучателя = НоваяСтрока.ВидЗапасов;
			КонецЕсли;
			
			СтрокаЗапасов.Количество = СтрокаЗапасов.Количество - НоваяСтрока.Количество;
			
			КоличествоТоваров = КоличествоТоваров - НоваяСтрока.Количество;
			
			Если КоличествоТоваров = 0 Тогда
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	МассивУдаляемыхСтрок = ТаблицаВидыЗапасов.НайтиСтроки(Новый Структура("Количество", 0));
	Для Каждого СтрокаТаблицы Из МассивУдаляемыхСтрок Цикл
		ТаблицаВидыЗапасов.Удалить(СтрокаТаблицы);
	КонецЦикла;
	
КонецПроцедуры

Процедура ДополнитьНаборыЗаписямиИзИБ(НаборЗаписей, Регистратор, ПериодЗаполнения, ДополнительныеСвойства)
	
	Если ТипЗнч(НаборЗаписей) = Тип("РегистрНакопленияНаборЗаписей.СебестоимостьТоваров") Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Регистратор",   Регистратор);
		Запрос.УстановитьПараметр("ПериодЗаполненияВидовЗапасовИСебестоимости", ПериодЗаполнения);
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	*
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|ГДЕ
		|	Т.Регистратор = &Регистратор
		|	И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства)
		|	И Т.Период >= &ПериодЗаполненияВидовЗапасовИСебестоимости
		|	И НЕ Т.РасчетПартий
		|	И НЕ Т.РасчетСебестоимости
		|";
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		КонецЦикла;
		
		РегистрыНакопления.СебестоимостьТоваров.ИнициализироватьСохранениеДвиженийНабораЗаписейЗаПериод(
			НаборЗаписей,
			ДополнительныеСвойства);
		
	КонецЕсли;
	
КонецПроцедуры

Функция СобытиеЖурналаРегистрации()
	
	Возврат НСтр("ru = 'Расход материалов на производство (фоновое задание)';
				|en = 'Consumption of materials for production (background job)'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	
КонецФункции

#КонецОбласти

//-- НЕ УТКА

Процедура ДобавитьОтборПоВыбраннымРесурсам(Ресурсы, НаборДанных) Экспорт
	
	Если СтрНайти(НаборДанных.Запрос, "ИМЕЮЩИЕ") > 0 Тогда
		// в запросе уже есть отбор
		Возврат;
	КонецЕсли;
	
	НачалоЗапроса = "
	|ИМЕЮЩИЕ
	|	СУММА(%1) <> 0";
	
	ШаблонРесурса = "
	|	ИЛИ СУММА(%1) <> 0";
	
	ТекстОтбора = "";
	
	Для Каждого Поле Из НаборДанных.Поля Цикл
		Если Ресурсы.Найти(Поле.Имя) <> Неопределено Тогда
			
			Если ТекстОтбора = "" Тогда
				ТекстОтбора = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НачалоЗапроса, Поле.Имя);
			Иначе
				ТекстОтбора = ТекстОтбора + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ШаблонРесурса, Поле.Имя);
			КонецЕсли;
			
		КонецЕсли;
	КонецЦикла;
	
	НаборДанных.Запрос = НаборДанных.Запрос + ТекстОтбора;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

//++ НЕ УТ

#Область БлокировкаПриОбновленииИБ

Процедура ПроверитьБлокировкуВходящихДанныхПриОбновленииИБ(ПредставлениеОперации)
	
	ВходящиеДанные = Новый Соответствие;
	
	ВходящиеДанные.Вставить(Метаданные.Документы.ВыпускПродукции);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РаспоряженияНаСписаниеПоНормативам);
	
	ЗакрытиеМесяцаСервер.ПроверитьБлокировкуВходящихДанныхПриОбновленииИБ(ВходящиеДанные, ПредставлениеОперации);
	
КонецПроцедуры

#КонецОбласти

//-- НЕ УТ

#КонецОбласти

