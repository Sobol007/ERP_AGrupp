
#Область ПрограммныйИнтерфейс

// Процедура формирует запрос-команду исходящего вызова
//
// Параметры:
//	НомерАбонента			- Строка	- Номер вызываемого абонента
//	ДанныеПользователяАТС	- Структура	- Данные пользователя АТС
//	URL						- Строка	- Корневой URL запроса
//	ТелоЗапроса				- Строка	- Тело сформированного запроса
//	Заголовки				- Структура	- Структура заголовков запроса
//	Ошибка					- Строка	- Возвращаемое описание возникшей ошибки
//
Процедура ПриСозданииИсходящегоВызова(НомерАбонента, ДанныеПользователяАТС, URL, ТелоЗапроса, Заголовки, Ошибка) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	ДлинаВнутреннихНомеров = Константы.сфпМаксимальнаяДлинаВнутреннихНомеров.Получить();
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
		
		ЗаписьJSON.ЗаписатьИмяСвойства("from");
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		ЗаписьJSON.ЗаписатьИмяСвойства("extension");
		ЗаписьJSON.ЗаписатьЗначение(ДанныеПользователяАТС.ВнутреннийНомер);
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("to_number");
		ЗаписьJSON.ЗаписатьЗначение(?(СтрДлина(НомерАбонента) >= 10, "7", "") + НомерАбонента);

		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "commands/callback";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
		
		ЗаписьJSON.ЗаписатьИмяСвойства("from");
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		ЗаписьJSON.ЗаписатьИмяСвойства("extension");
		ЗаписьJSON.ЗаписатьЗначение(ДанныеПользователяАТС.ВнутреннийНомер);
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("to_number");
		ЗаписьJSON.ЗаписатьЗначение(?(СтрДлина(НомерАбонента) > ДлинаВнутреннихНомеров, "7", "") + НомерАбонента);
		
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "commands/callback";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		
		НомерАбонента = ПреобразоватьНомерДляКонтактнойИнформации(НомерАбонента);
		
		Если НЕ ЗначениеЗаполнено(ДанныеПользователяАТС.ИсходящийНомер) Тогда
			Ошибка = "НеЗаполненНомерИсходящегоЗвонкаПользователя";
			Возврат;
		КонецЕсли;
		
		Токен = ТокенДоступаAPI(ДанныеПользователяАТС.ВнутреннийНомер, Ошибка);
		
		Если ЗначениеЗаполнено(Ошибка) Тогда
			Возврат;
		КонецЕсли;
		
		Если Токен = Неопределено Тогда
			ВызватьИсключение НСтр("ru='Не удалось авторизоваться.'");
		КонецЕсли;
		
		URL = URL + "api/v2/calls/makecall";
		
		Заголовки.Вставить("Authorization", "bearer " + Токен);
		Заголовки.Вставить("x-api-key", НастройкиТелефонии.КлючДляАвторизацииАТСЯндекс);
		
		ПараметрыЗапроса.Добавить("from=" + ДанныеПользователяАТС.ИсходящийНомер);
		ПараметрыЗапроса.Добавить("to=" + ?(СтрДлина(НомерАбонента) > ДлинаВнутреннихНомеров, "7", "") + НомерАбонента);
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Билайн Тогда
		URL = URL + "apis/portal/abonents/" + ДанныеПользователяАТС.ВнутреннийНомер + "/call?phoneNumber=" + НомерАбонента;
				
		Заголовки.Вставить("X-MPBX-API-AUTH-TOKEN", НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
		
	ИначеЕсли сфпСофтФонПроСерверПереопределяемый.ЭтоПлатформаITooLabs(ИспользуемаяАТС) Тогда
		ПараметрыЗапроса.Добавить("cmd=makeCall");
		ПараметрыЗапроса.Добавить("phone=" + ?(СтрДлина(НомерАбонента) > ДлинаВнутреннихНомеров, "8", "") + НомерАбонента);
		ПараметрыЗапроса.Добавить("user=" + ДанныеПользователяАТС.ВнутреннийНомер);
		ПараметрыЗапроса.Добавить("token=" + НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);	
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос-команду перевода неотвеченного вызова
//
// Параметры:
//	ИдентификаторЗвонкаВАТС	- Строка	- Идентификатор звонка
//	НомерАбонента			- Строка	- Номер абонента
//	ВнутреннийНомер			- Строка	- Внутренний номер
//	Hold					- Булево	- Признак постановки звонка на удержание (Истина - Удержание, Ложь - Слепой перевод)
//	URL						- Строка	- Корневой URL запроса
//	ТелоЗапроса				- Строка	- Тело сформированного запроса
//	Заголовки				- Структура	- Структура заголовков запроса
//	Ошибка					- Строка	- Возвращаемое описание возникшей ошибки
//	json					- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПереводеНеотвеченногоВызова(ИдентификаторЗвонкаВАТС, НомерАбонента, ВнутреннийНомер, Hold, URL, ТелоЗапроса, Заголовки, Ошибка, json = "") Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
		
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
				
		ЗаписьJSON.ЗаписатьИмяСвойства("call_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗвонкаВАТС);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("method");
		ЗаписьJSON.ЗаписатьЗначение(?(Hold, "hold", "blind"));
		
		ЗаписьJSON.ЗаписатьИмяСвойства("to_number");
		ЗаписьJSON.ЗаписатьЗначение(НомерАбонента);
						
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "commands/transfer";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
				
		ЗаписьJSON.ЗаписатьИмяСвойства("call_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗвонкаВАТС);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("to_number");
		ЗаписьJSON.ЗаписатьЗначение(НомерАбонента);
		
		Если Hold Тогда
			ЗаписьJSON.ЗаписатьИмяСвойства("method");
			ЗаписьJSON.ЗаписатьЗначение(?(Hold, "hold", "blind"));
		
			ЗаписьJSON.ЗаписатьИмяСвойства("initiator");
			ЗаписьJSON.ЗаписатьЗначение(ВнутреннийНомер);
		КонецЕсли;	
		
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		Если Hold Тогда
			URL = URL + "commands/transfer";
		
		Иначе	
			URL = URL + "commands/route";
		КонецЕсли;	
	
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		Ошибка = "МетодНеПоддерживается";
		Возврат;
		
	ИначеЕсли сфпСофтФонПроСерверПереопределяемый.ЭтоПлатформаITooLabs(ИспользуемаяАТС) Тогда
		ПараметрыЗапроса.Добавить("cmd=makeCall");
		//ПараметрыЗапроса.Добавить("phone=" + НомерАбонента);
		//ПараметрыЗапроса.Добавить("user=" + ДанныеПользователяАТС.ВнутреннийНомер);
		ПараметрыЗапроса.Добавить("token=" + НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);	
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос-команду перевода отвеченного вызова
//
// Параметры:
//	ИдентификаторЗвонкаВАТС	- Строка	- Идентификатор звонка
//	НомерАбонента			- Строка	- Номер абонента
//	ВнутреннийНомер			- Строка	- Внутренний номер
//	Hold					- Булево	- Признак постановки звонка на удержание (Истина - Удержание, Ложь - Слепой перевод)
//	URL						- Строка	- Корневой URL запроса
//	ТелоЗапроса				- Строка	- Тело сформированного запроса
//	Заголовки				- Структура	- Структура заголовков запроса
//	Ошибка					- Строка	- Возвращаемое описание возникшей ошибки
//	json					- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПереводеОтвеченногоВызова(ИдентификаторЗвонкаВАТС, НомерАбонента, ВнутреннийНомер, Hold, URL, ТелоЗапроса, Заголовки, Ошибка, json = "") Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
		
	ИспользуемаяАТС = сфпОбщегоНазначенияПовтИсп.ПолучитьЗначениеКонстанты("сфпИспользуемаяАТС");
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда

		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
				
		ЗаписьJSON.ЗаписатьИмяСвойства("call_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗвонкаВАТС);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("to_number");
		ЗаписьJSON.ЗаписатьЗначение(НомерАбонента);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("method");
		ЗаписьJSON.ЗаписатьЗначение(?(Hold, "hold", "blind"));
		
		ЗаписьJSON.ЗаписатьИмяСвойства("initiator");
		ЗаписьJSON.ЗаписатьЗначение(ВнутреннийНомер);
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "commands/transfer";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда

		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
				
		ЗаписьJSON.ЗаписатьИмяСвойства("call_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗвонкаВАТС);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("to_number");
		ЗаписьJSON.ЗаписатьЗначение(НомерАбонента);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("method");
		ЗаписьJSON.ЗаписатьЗначение(?(Hold, "hold", "blind"));
		
		ЗаписьJSON.ЗаписатьИмяСвойства("initiator");
		ЗаписьJSON.ЗаписатьЗначение(ВнутреннийНомер);
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "commands/transfer";
	
	ИначеЕсли сфпСофтФонПроСерверПереопределяемый.ЭтоПлатформаITooLabs(ИспользуемаяАТС) Тогда
		ПараметрыЗапроса.Добавить("cmd=makeCall");
		//ПараметрыЗапроса.Добавить("phone=" + НомерАбонента);
		//ПараметрыЗапроса.Добавить("user=" + ДанныеПользователяАТС.ВнутреннийНомер);
		ПараметрыЗапроса.Добавить("token=" + НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос-команду завершения вызова
//
// Параметры:
//	ИдентификаторЗвонкаВАТС	- Строка	- Идентификатор звонка
//	URL						- Строка	- Корневой URL запроса
//	ТелоЗапроса				- Строка	- Тело сформированного запроса
//	Заголовки				- Структура	- Структура заголовков запроса
//	Ошибка					- Строка	- Возвращаемое описание возникшей ошибки
//	json					- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриЗавершенииВызова(ИдентификаторЗвонкаВАТС, URL, ТелоЗапроса, Заголовки, Ошибка, json = Неопределено) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
				
		ЗаписьJSON.ЗаписатьИмяСвойства("call_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗвонкаВАТС);
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "commands/call/hangup";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("command_id");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Новый УникальныйИдентификатор));
				
		ЗаписьJSON.ЗаписатьИмяСвойства("call_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗвонкаВАТС);
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "commands/call/hangup";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		
		//НомерАбонента = ПреобразоватьНомерДляКонтактнойИнформации(НомерАбонента);
		//
		//Если НЕ ЗначениеЗаполнено(ДанныеПользователяАТС.ИсходящийНомер) Тогда
		//	Ошибка = "НеЗаполненНомерИсходящегоЗвонкаПользователя";
		//	Возврат;
		//КонецЕсли;
		//
		//Токен = ТокенДоступаAPI(ДанныеПользователяАТС.ВнутреннийНомер, Ошибка);
		//
		//Если Ошибка <> Неопределено Тогда
		//	Возврат;
		//КонецЕсли;
		//
		//Если Токен = Неопределено Тогда
		//	ВызватьИсключение НСтр("ru='Не удалось авторизоваться.'");
		//КонецЕсли;
		//
		//URL = URL + "api/v2/calls/makecall";
		//
		//Заголовки.Вставить("Authorization", "bearer " + Токен);
		//Заголовки.Вставить("x-api-key", сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии().КлючДляАвторизацииАТСЯндекс);
		//
		//ПараметрыЗапроса.Добавить("from=" + ДанныеПользователяАТС.ИсходящийНомер);
		//ПараметрыЗапроса.Добавить("to=" + НомерАбонента);
		
	ИначеЕсли сфпСофтФонПроСерверПереопределяемый.ЭтоПлатформаITooLabs(ИспользуемаяАТС) Тогда
		// Команда не поддерживается оператором
		Ошибка = "КомандаНеПоддерживаетсяОператором";
		Возврат;	
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос получения статуса подключения
//
// Параметры:
//	URL			- Строка	- Корневой URL запроса
//	HTTPМетод	- Строка	- Метод (POST, GET)
//	ТелоЗапроса	- Строка	- Тело сформированного запроса
//	Заголовки	- Структура	- Структура заголовков запроса
//	Ошибка		- Строка	- Возвращаемое описание возникшей ошибки
//	json		- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПроверкеСтатусаПодключения(URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("extension");
		ЗаписьJSON.ЗаписатьЗначение("");
		
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "config/users/request";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("number");
		ЗаписьJSON.ЗаписатьЗначение("70001234567");
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "queries/user_info_by_dct_number";

	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		HTTPМетод = "GET";		
		URL = URL + "api/v2/auth/ping";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Билайн Тогда
		HTTPМетод = "GET";
		URL = URL + "apis/portal/subscription";
		
		Заголовки.Вставить("X-MPBX-API-AUTH-TOKEN", НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
		
	ИначеЕсли ЭтоПлатформаItoolabs(ИспользуемаяАТС) Тогда
		ПараметрыЗапроса.Добавить("cmd=accounts");
		ПараметрыЗапроса.Добавить("token=" + НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);	
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос получения подписки на события АТС
//
// Параметры:
//	URL			- Строка	- Корневой URL запроса
//	HTTPМетод	- Строка	- Метод (POST, GET)
//	ТелоЗапроса	- Строка	- Тело сформированного запроса
//	Заголовки	- Структура	- Структура заголовков запроса
//	Ошибка		- Строка	- Возвращаемое описание возникшей ошибки
//	json		- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПодпискеНаСобытия(URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	АдресОбратногоВызова = сфпСофтФонПроСервер.АдресОбратногоВызоваОблачнаяТелефония(ИспользуемаяАТС);
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) ИЛИ НЕ ЗначениеЗаполнено(АдресОбратногоВызова) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Билайн Тогда
		HTTPМетод = "PUT";
		URL = URL + "apis/portal/subscription";
				
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("subscriptionType");
		ЗаписьJSON.ЗаписатьЗначение("BASIC_CALL");
		
		ЗаписьJSON.ЗаписатьИмяСвойства("url");
		ЗаписьJSON.ЗаписатьЗначение(АдресОбратногоВызова);
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		Заголовки.Вставить("Content-Type", "application/json");
		Заголовки.Вставить("X-MPBX-API-AUTH-TOKEN", НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
		
		ТелоЗапроса = json;
	КонецЕсли;
	
	//ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос получения данных подписки на события
//
// Параметры:
//	URL			- Строка	- Корневой URL запроса
//	HTTPМетод	- Строка	- Метод (POST, GET)
//	ТелоЗапроса	- Строка	- Тело сформированного запроса
//	Заголовки	- Структура	- Структура заголовков запроса
//	Ошибка		- Строка	- Возвращаемое описание возникшей ошибки
//	json		- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПолученииДанныхПодпискиНаСобытия(URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	АдресОбратногоВызова = сфпСофтФонПроСервер.АдресОбратногоВызоваОблачнаяТелефония(ИспользуемаяАТС);
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) ИЛИ НЕ ЗначениеЗаполнено(АдресОбратногоВызова) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	ПараметрыЗапроса = Новый Массив();
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Билайн Тогда
		HTTPМетод = "GET";
		URL = URL + "apis/portal/subscription?subscriptionId=" + НастройкиТелефонии.КлючПодпискиНаСобытия;
				
		//Заголовки.Вставить("Content-Type", "application/json");
		Заголовки.Вставить("X-MPBX-API-AUTH-TOKEN", НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
		
		//ПараметрыЗапроса.Добавить("subscriptionId=" + НастройкиТелефонии.КлючПодпискиНаСобытия);
	КонецЕсли;
	
	//ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	ТелоЗапроса = "";
	
КонецПроцедуры

// Процедура формирует запрос получения данных автоподписки
//
// Параметры:
//	URL			- Строка	- Корневой URL запроса
//	HTTPМетод	- Строка	- Метод (POST, GET)
//	ТелоЗапроса	- Строка	- Тело сформированного запроса
//	Заголовки	- Структура	- Структура заголовков запроса
//	Ошибка		- Строка	- Возвращаемое описание возникшей ошибки
//	json		- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриАвтоподписке(URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json, ПараметрыАвтоподписки) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	АдресОбратногоВызова = сфпСофтФонПроСервер.АдресОбратногоВызоваОблачнаяТелефония(ИспользуемаяАТС);
		
	ПараметрыЗапроса = Новый Массив();
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Гравител Тогда
		URL = "https://bit.gravitel.ru/reg/rarus/";
		Заголовки.Вставить("Content-Type", "application/json");

		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("key");
		ЗаписьJSON.ЗаписатьЗначение("12345-12345-12345");
		
		ЗаписьJSON.ЗаписатьИмяСвойства("full_name");
		ЗаписьJSON.ЗаписатьЗначение(ПараметрыАвтоподписки.Наименование);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("mob_tel");
		ЗаписьJSON.ЗаписатьЗначение(ПараметрыАвтоподписки.Телефон);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("emai");
		ЗаписьJSON.ЗаписатьЗначение(ПараметрыАвтоподписки.ЭлектроннаяПочта);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("crmurl");
		ЗаписьJSON.ЗаписатьЗначение(АдресОбратногоВызова);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("crmtoken");
		ЗаписьJSON.ЗаписатьЗначение(ПараметрыАвтоподписки.Токен);
		
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		ТелоЗапроса = json;
	КонецЕсли;

КонецПроцедуры

// Процедура формирует запрос получения списка абонентов АТС
//
// Параметры:
//	URL			- Строка	- Корневой URL запроса
//	HTTPМетод	- Строка	- Метод (POST, GET)
//	ТелоЗапроса	- Строка	- Тело сформированного запроса
//	Заголовки	- Структура	- Структура заголовков запроса
//	Ошибка		- Строка	- Возвращаемое описание возникшей ошибки
//	json		- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПолученииАбонентов(URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	
	ПараметрыЗапроса = Новый Массив();
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "config/users/request";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ТелоЗапроса = "
		|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		|sign=" + sign + "
		|json=" + json;
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "config/users/request";
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Билайн Тогда
		HTTPМетод = "GET";
		URL = URL + "apis/portal/abonents";
		
		Заголовки.Вставить("X-MPBX-API-AUTH-TOKEN", НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
		
		ТелоЗапроса = json;			
		
	ИначеЕсли сфпСофтФонПроСерверПереопределяемый.ЭтоПлатформаITooLabs(ИспользуемаяАТС) Тогда
		ПараметрыЗапроса.Добавить("cmd=accounts");
		ПараметрыЗапроса.Добавить("token=" + НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);	
	КонецЕсли;
	
	Если ПараметрыЗапроса.Количество() > 0 Тогда
		ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	КонецЕсли;	
	
КонецПроцедуры

// Процедура формирует запрос получения данных абонента
//
// Параметры:
//	ВнутреннийНомер	- Строка	- Внутренний номер
//	URL				- Строка	- Корневой URL запроса
//	HTTPМетод		- Строка	- Метод (POST, GET)
//	ТелоЗапроса		- Строка	- Тело сформированного запроса
//	Заголовки		- Структура	- Структура заголовков запроса
//	Ошибка			- Строка	- Возвращаемое описание возникшей ошибки
//	json			- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПолученииДанныхАбонента(ВнутреннийНомер, URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		HTTPМетод = "GET";
		
		Если НЕ ЗначениеЗаполнено(ВнутреннийНомер) Тогда
			Ошибка = "НеЗаполненВнутреннийНомерПользователя";
			Возврат;
		КонецЕсли;
		
		Токен = ТокенДоступаAPI(ВнутреннийНомер, Ошибка);
		
		Если ЗначениеЗаполнено(Ошибка) Тогда
			Возврат;
		КонецЕсли;
		
		Если Токен = Неопределено Тогда
			ВызватьИсключение НСтр("ru='Не удалось авторизоваться.'");
		КонецЕсли;
		
		URL = URL + "api/v2/profile/" + ВнутреннийНомер;
		
		Заголовки.Вставить("Authorization", "bearer " + Токен);
		Заголовки.Вставить("x-api-key", сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии().КлючДляАвторизацииАТСЯндекс);
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос получения исходящих номеров
//
// Параметры:
//	ВнутреннийНомер	- Строка	- Внутренний номер
//	URL				- Строка	- Корневой URL запроса
//	HTTPМетод		- Строка	- Метод (POST, GET)
//	ТелоЗапроса		- Строка	- Тело сформированного запроса
//	Заголовки		- Структура	- Структура заголовков запроса
//	Ошибка			- Строка	- Возвращаемое описание возникшей ошибки
//	json			- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПолученииИсходящихНомеров(ВнутреннийНомер, URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		HTTPМетод = "GET";
		
		Если НЕ ЗначениеЗаполнено(ВнутреннийНомер) Тогда
			Ошибка = "НеЗаполненВнутреннийНомерПользователя";
			Возврат;
		КонецЕсли;
		
		Токен = ТокенДоступаAPI(ВнутреннийНомер, Ошибка);
		
		Если ЗначениеЗаполнено(Ошибка) Тогда
			Возврат;
		КонецЕсли;
		
		Если Токен = Неопределено Тогда
			ВызватьИсключение НСтр("ru='Не удалось авторизоваться.'");
		КонецЕсли;
		
		URL = URL + "api/v2/phonenumbers";
		
		Заголовки.Вставить("Authorization", "bearer " + Токен);
		Заголовки.Вставить("x-api-key", сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии().КлючДляАвторизацииАТСЯндекс);
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура формирует запрос получения записи разговора
//
// Параметры:
//	ИдентификаторЗаписи	- Строка	- Идентификатор записи разговора
//	URL					- Строка	- Корневой URL запроса
//	HTTPМетод			- Строка	- Метод (POST, GET)
//	ТелоЗапроса			- Строка	- Тело сформированного запроса
//	Заголовки			- Структура	- Структура заголовков запроса
//	Ошибка				- Строка	- Возвращаемое описание возникшей ошибки
//	json				- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриПолученииЗаписиРазговора(ИдентификаторЗаписи, ВнутреннийНомер, РежимПолученияЗаписи, URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = сфпОбщегоНазначенияПовтИсп.ПолучитьЗначениеКонстанты("сфпИспользуемаяАТС");
	
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		HTTPМетод = Неопределено;
		
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("recording_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗаписи);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("action");
		ЗаписьJSON.ЗаписатьЗначение("download");
		
		ЗаписьJSON.ЗаписатьИмяСвойства("extension");
		ЗаписьJSON.ЗаписатьЗначение(ВнутреннийНомер);
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		URL = URL + "queries/recording/post?" + сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");

	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет));
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("recording_id");
		ЗаписьJSON.ЗаписатьЗначение(ИдентификаторЗаписи);
		
		ЗаписьJSON.ЗаписатьИмяСвойства("action");
		ЗаписьJSON.ЗаписатьЗначение(РежимПолученияЗаписи);
				
		ЗаписьJSON.ЗаписатьКонецОбъекта();
		json = ЗаписьJSON.Закрыть();
		
		sign = ПолучитьSign(НастройкиТелефонии.vpbx_api_key, json, НастройкиТелефонии.vpbx_api_salt);
		
		//ТелоЗапроса = "
		//|vpbx_api_key=" + НастройкиТелефонии.vpbx_api_key + "
		//|sign=" + sign + "
		//|json=" + json;
		//
		//ПараметрыЗапроса.Добавить("vpbx_api_key=" + КодировкаURL(НастройкиТелефонии.vpbx_api_key));
		//ПараметрыЗапроса.Добавить("sign=" + КодировкаURL(sign));
		//ПараметрыЗапроса.Добавить("json=" + КодировкаURL(json));
		
		//URL = URL + "queries/recording/post";
		
		HTTPМетод = "GET";
		
		vpbx_api_key = НастройкиТелефонии.vpbx_api_key;
		vpbx_api_salt = НастройкиТелефонии.vpbx_api_salt;
		timestamp = Формат((ТекущаяДата() + 86400) - Дата("19700101"), "ЧН=0; ЧГ=0");
		sign = ПолучитьSign(vpbx_api_key, timestamp, ИдентификаторЗаписи, vpbx_api_salt);

		URL = URL + "queries/recording/link/" + ИдентификаторЗаписи + "/" + РежимПолученияЗаписи + "/" + vpbx_api_key + "/" + timestamp + "/" + sign;

	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Билайн Тогда
		HTTPМетод = "GET";
		
		Позиция = Найти(ИдентификаторЗаписи, "/");
		extTrackingId = КодировкаURL(Лев(ИдентификаторЗаписи, Позиция - 1));
		userId = КодировкаURL(Сред(ИдентификаторЗаписи, Позиция + 1));
		
		URL = URL + "apis/portal/records/" + extTrackingId + "/" + userId + "/reference";
		
		Заголовки.Вставить("X-MPBX-API-AUTH-TOKEN", НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
	КонецЕсли;

	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");

КонецПроцедуры

// Процедура формирует запрос загрузки записи разговора
//
// Параметры:
//	ИдентификаторЗаписи	- Строка	- Идентификатор записи разговора
//	URL					- Строка	- Корневой URL запроса
//	HTTPМетод			- Строка	- Метод (POST, GET)
//	ТелоЗапроса			- Строка	- Тело сформированного запроса
//	Заголовки			- Структура	- Структура заголовков запроса
//	Ошибка				- Строка	- Возвращаемое описание возникшей ошибки
//	json				- Строка	- Возвращаемая строка json-запроса
//
Процедура ПриЗагрузкеЗаписиРазговора(ИдентификаторЗаписи, URL, HTTPМетод, ТелоЗапроса, Заголовки, Ошибка, json) Экспорт
	
	НастройкиТелефонии = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии();
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	ПараметрыЗапроса = Новый Массив;
	
	Если НЕ НастройкиИнтеграцииЗаполнены(ИспользуемаяАТС, НастройкиТелефонии) Тогда
		Ошибка = "НеЗаполненыНастройкиИнтеграции";
		Возврат;
	КонецЕсли;
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		HTTPМетод = "GET";
		
		URL = ИдентификаторЗаписи;
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		HTTPМетод = "GET";
		
		URL = ИдентификаторЗаписи;
		
	ИначеЕсли сфпСофтФонПроСерверПереопределяемый.ЭтоПлатформаITooLabs(ИспользуемаяАТС) Тогда
		HTTPМетод = "GET";
		
		URL = ИдентификаторЗаписи;
	КонецЕсли;
	
	ТелоЗапроса = сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&");
	
КонецПроцедуры

// Процедура обработки ответа на запрос исходящего вызова
//
// Параметры:
//	HTTPОтвет						- HTTPОтвет	- Ответ сервера
//	ИмяСобытияДляЖурналаРегистрации	- Строка	- Имя события для записи журнала регистрации
//
Процедура ПриОбработкеОтветаНаСозданиеИсходящегоВызова(HTTPОтвет, ИмяСобытияДляЖурналаРегистрации) Экспорт
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		ТелоОтвета = РаскодироватьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку(), СпособКодированияСтроки.КодировкаURL);
		
		Если HTTPОтвет.КодСостояния = 200 Тогда
			
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
			ПараметрыОтвета = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			КодОтвета = Неопределено;
			Если ПараметрыОтвета.Свойство("result", КодОтвета) Тогда
				// 1ххх: Действие успешно выполнено
				Если сфпОбщегоНазначения.сфпСтрНачинаетсяС(КодОтвета, "1") Тогда
					Возврат;
				КонецЕсли;
				
				ЗаголовокОшибки = РасшифровкаОшибкиMango(КодОтвета);
				ТекстОшибки = ТелоОтвета;

			Иначе
				Возврат;
			КонецЕсли;	
			
		Иначе
			
			ЗаголовокОшибки = НСтр("ru='Ошибка при инициализации вызова.'");
			ТекстОшибки = ТелоОтвета;
			
		КонецЕсли;
		
	ИначеЕсли ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		ТелоОтвета = РаскодироватьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку(), СпособКодированияСтроки.КодировкаURL);
		
		Если HTTPОтвет.КодСостояния = 200 Тогда
			
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
			ПараметрыОтвета = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			КодОтвета = Неопределено;
			Если ПараметрыОтвета.Свойство("result", КодОтвета) Тогда
				// 1ххх: Действие успешно выполнено
				Если сфпОбщегоНазначения.сфпСтрНачинаетсяС(КодОтвета, "1") Тогда
					Возврат;
				КонецЕсли;
				
				ЗаголовокОшибки = РасшифровкаОшибкиMango(КодОтвета);
				ТекстОшибки = ТелоОтвета;

			Иначе
				Возврат;
			КонецЕсли;	
			
		Иначе
			
			ЗаголовокОшибки = НСтр("ru='Ошибка при инициализации вызова.'");
			ТекстОшибки = ТелоОтвета;
			
		КонецЕсли;
		
	ИначеЕсли сфпСофтФонПроСерверПереопределяемый.ЭтоПлатформаITooLabs(ИспользуемаяАТС) Тогда
		// 200 ОК
		Если HTTPОтвет.КодСостояния = 200 Тогда
			Возврат;
		КонецЕсли;
		
		ЗаголовокОшибки = РасшифровкаОшибкиItoolabs(HTTPОтвет.КодСостояния);
		ТекстОшибки = РаскодироватьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку(), СпособКодированияСтроки.КодировкаURL);
		
	Иначе
		Возврат;
	КонецЕсли;
	
	ТекстОшибки = сфпОбщегоНазначенияКлиентСервер.ПодставитьПараметрыВСтроку("%1%2%3", ЗаголовокОшибки, Символы.ПС, ТекстОшибки);
	
	ЗаписатьЗапросВЖурналРегистрации(ИмяСобытияДляЖурналаРегистрации, ТекстОшибки, УровеньЖурналаРегистрации.Ошибка);
	
	ВызватьИсключение ТекстОшибки;
	
КонецПроцедуры

// Возвращает ссылку на запись разговора
//
// Параметры:
//	ИдентификаторЗвонка	- Строка	- Идентификатор звонка
//	ВнутреннийНомер		- Строка	- Внутренний номер
//	Ошибка				- Строка	- Возвращаемое описание возникшей ошибки
//
Функция СсылкаНаЗаписьРазговора(ИдентификаторЗвонка, ВнутреннийНомер, Ошибка) Экспорт
	
	ИспользуемаяАТС = Константы.сфпИспользуемаяАТС.Получить();
	Если ИспользуемаяАТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		Возврат ДанныеЗвонка(ИдентификаторЗвонка, ВнутреннийНомер, Ошибка);
	КонецЕсли;
	
КонецФункции

// Возвращает настройку отображения исходящего номера
Функция НастройкиФормыПользователей() Экспорт
	
	НастройкиФормы = Новый Структура;
	НастройкиФормы.Вставить("ПоказыватьИсходящийНомер", Константы.сфпИспользуемаяАТС.Получить() = Перечисления.сфпДоступныеАТС.Яндекс);
	
	Возврат НастройкиФормы;
	
КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

/////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Функция возвращает массив идентификаторов записей телефонного разговора, доступных для прослушивания текущим пользователем
//
// Параметры:
//	ИдентификаторЗвонка	- Число	- Идентификатор звонка
//	ДатаНачало			- Дата	- Дата начала записи
//
// Возвращаемое значение:
//	Массив	- Массив идентификаторов записей телефонного разговора
//
Функция сфпПолучитьСписокЗаписейТелефонногоРазговора(ИдентификаторЗвонка, ДатаНачало) Экспорт
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ИдентификаторЗвонка",	ИдентификаторЗвонка);
	Запрос.УстановитьПараметр("НачалоЗаписи",			НачалоДня(ДатаНачало));
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	сфпЗаписиТелефонныхПереговоров.ИдентификаторЗвонка,
	|	сфпЗаписиТелефонныхПереговоров.ИдентификаторЗаписи,
	|	сфпЗаписиТелефонныхПереговоров.НачалоЗаписи,
	|	сфпЗаписиТелефонныхПереговоров.Пользователь,
	|	сфпЗаписиТелефонныхПереговоров.НомерВнТелефона,
	|	сфпЗаписиТелефонныхПереговоров.Контакт,
	|	сфпЗаписиТелефонныхПереговоров.НомерТелефона,
	|	сфпЗаписиТелефонныхПереговоров.ПродолжительностьЗаписи,
	|	сфпЗаписиТелефонныхПереговоров.ИмяЛинии
	|ИЗ
	|	РегистрСведений.сфпЗаписиТелефонныхПереговоров КАК сфпЗаписиТелефонныхПереговоров
	|ГДЕ
	|	сфпЗаписиТелефонныхПереговоров.ИдентификаторЗвонка = &ИдентификаторЗвонка
	|	И сфпЗаписиТелефонныхПереговоров.НачалоЗаписи >= &НачалоЗаписи";
	ТаблицаЗаписей = Запрос.Выполнить().Выгрузить();
	Возврат ОбщегоНазначения.ТаблицаЗначенийВМассив(ТаблицаЗаписей);
КонецФункции // сфпСофтФонПроСервер.ПолучитьСписокЗаписейТелефонногоРазговора()

// Функция создает документ "Телефонный звонок"
//
// Параметры:
//	СтруктураЗвонка	- Структура	- Структура данных звонка
//
Функция сфпСоздатьТелефонныйЗвонок(СтруктураЗвонка, ДанныеЗаполнения) Экспорт
	
	ИмяДокументаТелефонныйЗвонок = СтрЗаменить(сфпСофтФонПроСервер.сфпИмяДокументаТелефонныйЗвонок(), "Документ.", "");
	РеквизитыДокумента = Метаданные.Документы[ИмяДокументаТелефонныйЗвонок].Реквизиты;
	
	ПустойАбонентПредставление = НСтр("ru='!!!Не определен!!!';en='!!!Indefined!!!'");
	
	ДлительностьЗвонка = 0;
	Если СтруктураЗвонка.Свойство("ДатаОтвета") И СтруктураЗвонка.Свойство("ДатаОкончания") Тогда
		Если ЗначениеЗаполнено(СтруктураЗвонка.ДатаОтвета) И ЗначениеЗаполнено(СтруктураЗвонка.ДатаОкончания) Тогда
			ДлительностьЗвонка = (СтруктураЗвонка.ДатаОкончания - СтруктураЗвонка.ДатаОтвета);
		КонецЕсли;
	КонецЕсли;
	
	НовыйЗвонок	= Документы[ИмяДокументаТелефонныйЗвонок].СоздатьДокумент();
	НовыйЗвонок.Дата				   = ?(СтруктураЗвонка.Свойство("ДатаНачала"), СтруктураЗвонка.ДатаНачала, сфпСофтФонПроСервер.сфпТекущаяДата());
	НовыйЗвонок.Входящий			   = СтруктураЗвонка.ВходящийЗвонок;
	НовыйЗвонок.АбонентКакСвязаться	   = СтруктураЗвонка.НомерТелефона; 
	НовыйЗвонок.АбонентПредставление   = ПустойАбонентПредставление;
	НовыйЗвонок.Автор				   = сфпСофтФонПроСервер.сфпТекущийПользователь();
	НовыйЗвонок.Ответственный		   = НовыйЗвонок.Автор;
	НовыйЗвонок.сфпСостояниеЗвонка	   = Перечисления.сфпСостоянияЗвонков.Отвеченный;
	НовыйЗвонок.сфпИдентификаторЗвонка = СтруктураЗвонка.hCall;
	НовыйЗвонок.сфпИдентификаторЗаписи = СтруктураЗвонка.ИдентификаторЗаписи;
	НовыйЗвонок.сфпДлительностьЗвонка  = ДлительностьЗвонка;
	НовыйЗвонок.Описание			   = сфпСофтФонПроСервер.сфпЗаполнитьОписаниеТелефонногоЗвонка(НовыйЗвонок.сфпДлительностьЗвонка);
	
	Если РеквизитыДокумента.Найти("Важность") <> Неопределено Тогда
		Если НовыйЗвонок["Важность"].Метаданные().Имя = "ВариантыВажностиЗадачи" Тогда
			  НовыйЗвонок["Важность"] = Перечисления["ВариантыВажностиЗадачи"].Обычная;
		Иначе НовыйЗвонок["Важность"] = Перечисления["ВариантыВажностиВзаимодействия"].Обычная;
		КонецЕсли;
	КонецЕсли;
	
	Если РеквизитыДокумента.Найти("Тема") <> Неопределено Тогда
		НовыйЗвонок.Тема = сфпСофтФонПроСервер.сфпЗаполнитьТемуТелефонногоЗвонка(НовыйЗвонок.Входящий, НовыйЗвонок.Дата);
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(СтруктураЗвонка.Контакт) Тогда
		Если ЗначениеЗаполнено(СтруктураЗвонка.ContactID) Тогда
			СтруктураЗвонка.Контакт	= сфпСофтФонПроСервер.сфпНайтиКонтактПоGUID(СтруктураЗвонка.ContactID);
		КонецЕсли;
	КонецЕсли;
	
	//Если НЕ ЗначениеЗаполнено(СтруктураЗвонка.Контакт) Тогда
	//	Если СтруктураЗвонка.МассивЗвонящих <> Неопределено Тогда
	//		Если СтруктураЗвонка.МассивЗвонящих.Количество() > 0 Тогда
	//			Если Найти(СтруктураЗвонка.МассивЗвонящих[0], "Объект не найден") > 0 Тогда
	//				  СтруктураЗвонка.Контакт = Неопределено;
	//			Иначе СтруктураЗвонка.Контакт = СтруктураЗвонка.МассивЗвонящих[0];
	//			КонецЕсли;
	//		КонецЕсли;
	//	КонецЕсли;
	//КонецЕсли;

	Если ЗначениеЗаполнено(СтруктураЗвонка.Контакт) Тогда
		НовыйЗвонок["АбонентКонтакт"] = СтруктураЗвонка.Контакт;
		НовыйЗвонок["АбонентПредставление"]	= сфпСофтФонПроСервер.сфпПолучитьНаименованиеКонтакта(СтруктураЗвонка.Контакт);
		Если Найти(Строка(СтруктураЗвонка.Контакт), "<Объект не найден>") > 0 Тогда
			НовыйЗвонок["Комментарий"] = Строка(ТипЗнч(СтруктураЗвонка.Контакт)) + ": "
					+ сфпСофтФонПроСервер.сфпПолучитьНаименованиеКонтакта(СтруктураЗвонка.Контакт) + НСтр("ru = ', номер: '") 
					+ сфпСофтФонПроСервер.сфпПолучитьПредставлениеНомераТелефона(СтруктураЗвонка.Контакт, СтруктураЗвонка.НомерТелефона)
					+ Символы.ПС + НСтр("ru='К данному абоненту в доступе отказано.';en='Access to this subscriber is denied.'")
					+ НСтр("ru=' Для разрешения работы с абонентом обратитесь к руководителю или администратору.'");
		КонецЕсли;

	ИначеЕсли СтруктураЗвонка.ВнешнийЗвонок Тогда
		Если СтруктураЗвонка.МассивЗвонящих = Неопределено Тогда
			Если НЕ ПустаяСтрока(СтруктураЗвонка.CallerInfoName) И Найти(СтруктураЗвонка.CallerInfoName, СтруктураЗвонка.НомерТелефона) = 0 Тогда
				  НовыйЗвонок["АбонентПредставление"] = СтруктураЗвонка.CallerInfoName;
			Иначе НовыйЗвонок["АбонентПредставление"] = ПустойАбонентПредставление;
			КонецЕсли;

		ИначеЕсли СтруктураЗвонка.МассивЗвонящих.Количество() = 0 Тогда
			Если НЕ ПустаяСтрока(СтруктураЗвонка.CallerInfoName) И Найти(СтруктураЗвонка.CallerInfoName, СтруктураЗвонка.НомерТелефона) = 0 Тогда
				  НовыйЗвонок["АбонентПредставление"] = СтруктураЗвонка.CallerInfoName;
			Иначе НовыйЗвонок["АбонентПредставление"] = ПустойАбонентПредставление;
			КонецЕсли;	
		КонецЕсли;

	Иначе	
		Если НЕ ПустаяСтрока(СтруктураЗвонка.CalledInfoName) Тогда
			  НовыйЗвонок["АбонентПредставление"] = СтруктураЗвонка.CalledInfoName;
		Иначе НовыйЗвонок["АбонентПредставление"] = ПустойАбонентПредставление;
		КонецЕсли;	
	КонецЕсли;

	Если ЗначениеЗаполнено(ДанныеЗаполнения) Тогда
		Если ДанныеЗаполнения.Свойство("Основание") Тогда
			НовыйЗвонок["ВзаимодействиеОснование"] = ДанныеЗаполнения.Основание;
		КонецЕсли;
		
		Если ДанныеЗаполнения.Свойство("сфпСтруктураCoMagic") Тогда
			сфпСтруктураВнешнихДанных = ДанныеЗаполнения.сфпСтруктураCoMagic;
			НовыйЗвонок["сфпCoMagicID"] = сфпСтруктураВнешнихДанных.comagic_context.visitor_id;
			НовыйЗвонок["Описание"] = НовыйЗвонок["Описание"] + ?(НовыйЗвонок["Описание"], "", Символы.ПС)
				+ НСтр("ru='Кампания: '") + сфпСтруктураВнешнихДанных.comagic_context.campaign + Символы.ПС
				+ НСтр("ru='Сайт: '") + сфпСтруктураВнешнихДанных.comagic_context.site + Символы.ПС
				+ НСтр("ru='Ключевые слова: '") + сфпСтруктураВнешнихДанных.comagic_context.search_query; 
		КонецЕсли;	
	КонецЕсли;

	// Отдельная врезка на заполнение представление абонента, если звонок совершается из телемаркетинга.
	Если ЗначениеЗаполнено(ДанныеЗаполнения) И ТипЗнч(ДанныеЗаполнения) = Тип("Структура") Тогда
		Если ДанныеЗаполнения.Свойство("Основание") И ТипЗнч(ДанныеЗаполнения.Основание) = Тип("ДокументСсылка.CRM_Телемаркетинг") Тогда
			Если ДанныеЗаполнения.Свойство("Описание") И ЗначениеЗаполнено(ДанныеЗаполнения.Описание) Тогда
				// Звоним потенциальному клиенту
				НовыйЗвонок["АбонентПредставление"] = ДанныеЗаполнения.Описание;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		УстановитьПривилегированныйРежим(Истина);
		НовыйЗвонок.Записать();
		ЗвонокЗаписан = Истина;
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());
		ЗвонокЗаписан	= Ложь;
	КонецПопытки;
	
	ИмяМероприятия = СтруктураЗвонка.Caller_Destination_Number;
	Если ЗначениеЗаполнено(ИмяМероприятия) И ЗвонокЗаписан Тогда
		ПартнерИнтереса = "";
		
		Если ЗначениеЗаполнено(НовыйЗвонок.АбонентКонтакт) Тогда
			Если ТипЗнч(НовыйЗвонок.АбонентКонтакт) = Тип("СправочникСсылка.Партнеры") Тогда
				ПартнерИнтереса = НовыйЗвонок.АбонентКонтакт;
				
			ИначеЕсли ТипЗнч(НовыйЗвонок.АбонентКонтакт) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда
				ПартнерИнтереса = НовыйЗвонок.АбонентКонтакт.Владелец;
			КонецЕсли;
			 
		Иначе
			ПотенциальныйКлиентОбъект = Справочники.CRM_ПотенциальныеКлиенты.СоздатьЭлемент();
			ПотенциальныйКлиентОбъект.Наименование = НовыйЗвонок.АбонентКакСвязаться;
			ПотенциальныйКлиентОбъект.ОбменДанными.Загрузка = Истина;
			ПотенциальныйКлиентОбъект.Записать();
			
			ПартнерИнтереса = ПотенциальныйКлиентОбъект.Ссылка;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ПартнерИнтереса) Тогда
			Мероприятие = Справочники.МаркетинговыеМероприятия.НайтиПоНаименованию(ИмяМероприятия, Истина);
			Если Мероприятие.Пустая() Тогда
				МероприятиеОбъект = Справочники.МаркетинговыеМероприятия.СоздатьЭлемент();
				МероприятиеОбъект.Наименование = ИмяМероприятия;
				МероприятиеОбъект.ОбменДанными.Загрузка = Истина;
				МероприятиеОбъект.Записать();
				
				Мероприятие = МероприятиеОбъект.Ссылка;
			КонецЕсли;
			
			МенеджерЗаписи = РегистрыСведений.ИсточникиПервичногоИнтереса.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.Период = НовыйЗвонок.Дата;
			МенеджерЗаписи.Партнер = ПартнерИнтереса;
			МенеджерЗаписи.Сделка = НовыйЗвонок.Ссылка;
			МенеджерЗаписи.ИсточникПервичногоИнтереса = Мероприятие;
			МенеджерЗаписи.КаналПервичногоИнтереса = ПланыВидовХарактеристик.КаналыРекламныхВоздействий.CRM_БезУказанияИсточника;
			МенеджерЗаписи.Записать();
		КонецЕсли;	
	КонецЕсли;
		
	Если ЗначениеЗаполнено(ДанныеЗаполнения) И ТипЗнч(ДанныеЗаполнения) = Тип("Структура") Тогда
		Если ЗвонокЗаписан И ДанныеЗаполнения.Свойство("Взаимодействие") Тогда
			CRM_ВзаимодействияСервер.ДобавитьДокументВРегистр(ДанныеЗаполнения.Взаимодействие, НовыйЗвонок.Ссылка);
		КонецЕсли;	
	КонецЕсли;

	Возврат НовыйЗвонок.Ссылка;

КонецФункции // сфпСоздатьТелефонныйЗвонок()

// Функция возврашает элемент справочника CRM_СостоянияИнтересов
Функция сфпСостояниеИнтересаВыявлениеПотребностей() Экспорт
	Возврат Справочники.CRM_СостоянияИнтересов.НайтиПоНаименованию("Выявление потребностей", Истина);
КонецФункции

// Функция создает документ "CRM_Интерес"
//
// Параметры:
//	СтруктураЗвонка	- Структура	- Структура данных звонка
//
Функция сфпСоздатьИнтерес(СтруктураЗвонка) Экспорт
	НовыйИнтерес = Документы["CRM_Интерес"].СоздатьДокумент();
	Если НЕ ЗначениеЗаполнено(СтруктураЗвонка.Контакт) Тогда
		Если ЗначениеЗаполнено(СтруктураЗвонка.ContactID) Тогда
			СтруктураЗвонка.Контакт	= сфпСофтФонПроСервер.сфпНайтиКонтактПоGUID(СтруктураЗвонка.ContactID);
		КонецЕсли;
	КонецЕсли;	
	
	НовыйИнтерес["Автор"] 				= сфпСофтФонПроСервер.сфпТекущийПользователь();
	НовыйИнтерес["Дата"] 				= CRM_ОбщегоНазначенияСервер.ПолучитьТекущуюДатуСеанса();
	НовыйИнтерес["ДокументОснование"] 	= СтруктураЗвонка.НовыйЗвонок;
	НовыйИнтерес["Ответственный"] 		= НовыйИнтерес["Автор"];
		
	ЗначениеНастройки = CRM_ОбщегоНазначенияПовтИсп.ПолучитьЗначениеНастройки("ОсновнаяОрганизация");
	Если ЗначениеЗаполнено(ЗначениеНастройки) Тогда
		НовыйИнтерес["Организация"] = ЗначениеНастройки;
	Иначе
		НовыйИнтерес["Организация"] = CRM_ОбщегоНазначенияСервер.ПолучитьПредопределеннуюОрганизацию();
	КонецЕсли;
	
	НовыйИнтерес["Подразделение"]       = НовыйИнтерес["Автор"].Подразделение;
	НовыйИнтерес["Офис"]       			= НовыйИнтерес["Подразделение"].CRM_Офис;	
	//НовыйИнтерес["СостояниеИнтереса"]   = Справочники.CRM_СостоянияИнтересов.ВыявлениеПотребностей;	
	НовыйИнтерес["Тема"]				= НСтр("ru='#Создан автоматически средствами СофтФон';en='# Created automatically with SoftPhone tools'");
	НовыйИнтерес["ТипУслуги"]			= Справочники.CRM_ТипУслуги.ПоставкаТоварыУслуги;	
	
	Если ЗначениеЗаполнено(СтруктураЗвонка.Контакт) Тогда
		Если Найти(Строка(СтруктураЗвонка.Контакт), НСтр("ru='<Объект не найден>';en='<Object not found>'")) > 0 Тогда
			НовыйИнтерес["Описание"]	= НовыйИнтерес["Описание"] + Символы.ПС  + Строка(ТипЗнч(СтруктураЗвонка.Контакт)) + ": "
					+ сфпСофтФонПроСервер.сфпПолучитьНаименованиеКонтакта(СтруктураЗвонка.Контакт) + НСтр("ru = ', номер: '") 
					+ сфпСофтФонПроСервер.сфпПолучитьПредставлениеНомераТелефона(СтруктураЗвонка.Контакт, СтруктураЗвонка.НомерТелефона)
					+ Символы.ПС + НСтр("ru='К данному абоненту в доступе отказано.';en='Access to this subscriber is denied.'")
					+ НСтр("ru=' Для разрешения работы с абонентом обратитесь к руководителю или администратору.'");
		ИначеЕсли ТипЗнч(СтруктураЗвонка.Контакт) = Тип("СправочникСсылка.Партнеры") Тогда
			НовыйИнтерес["Партнер"]			= СтруктураЗвонка.Контакт;
			НовыйИнтерес["КонтактноеЛицо"]  = НовыйИнтерес["Партнер"].CRM_ОсновноеКонтактноеЛицо;
		ИначеЕсли ТипЗнч(СтруктураЗвонка.Контакт) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда
			НовыйИнтерес["КонтактноеЛицо"]	= СтруктураЗвонка.Контакт;
			НовыйИнтерес["Партнер"]			= сфпСофтФонПроСервер.сфпПолучитьВладельцаКонтакта(СтруктураЗвонка.Контакт);
		ИначеЕсли ТипЗнч(СтруктураЗвонка.Контакт) = Тип("СправочникСсылка.CRM_ПотенциальныеКлиенты") Тогда
		    Клиент = сфпСофтФонПроСервер.сфпПолучитьВладельцаКонтакта(СтруктураЗвонка.Контакт);
			Если ЗначениеЗаполнено(Клиент) Тогда
				НовыйИнтерес["Партнер"]	= Клиент;			
			Иначе				
				НовыйИнтерес["ПотенциальныйКлиент"]	= СтруктураЗвонка.Контакт;			
			КонецЕсли;
		Иначе
			НовыйИнтерес["Описание"]	= НовыйИнтерес["Описание"] + Символы.ПС  + Строка(ТипЗнч(СтруктураЗвонка.Контакт)) + ": "
					+ сфпСофтФонПроСервер.сфпПолучитьНаименованиеКонтакта(СтруктураЗвонка.Контакт) + НСтр("ru = ', номер: '") 
					+ сфпСофтФонПроСервер.сфпПолучитьПредставлениеНомераТелефона(СтруктураЗвонка.Контакт, СтруктураЗвонка.НомерТелефона);
		КонецЕсли;
	КонецЕсли;	
	Попытка
		НовыйИнтерес.Записать();
	Исключение
		Возврат Документы.CRM_Интерес.ПустаяСсылка();
	КонецПопытки;
	
	НовоеВзаимодействие						   	= Документы["CRM_Взаимодействие"].СоздатьДокумент();
	НовоеВзаимодействие["Автор"] 			   	= сфпСофтФонПроСервер.сфпТекущийПользователь();
	НовоеВзаимодействие["ВидВзаимодействия"]   	= Справочники.CRM_ВидыВзаимодействий.ОбзвонКлиентов;
	НовоеВзаимодействие["Баллы"]               	= НовоеВзаимодействие["ВидВзаимодействия"].Баллы;
	НовоеВзаимодействие["Дата"]                	= CRM_ОбщегоНазначенияСервер.ПолучитьТекущуюДатуСеанса();
	НовоеВзаимодействие["ДокументОснование"]   	= НовыйИнтерес.Ссылка;
	НовоеВзаимодействие["КонтактноеЛицо"]      	= НовыйИнтерес.КонтактноеЛицо;
	НовоеВзаимодействие["ОжидаемаяВыручка"]    	= НовыйИнтерес.ОжидаемаяВыручка;
	НовоеВзаимодействие["Организация"]         	= НовыйИнтерес.Организация;
	НовоеВзаимодействие["Ответственный"]       	= НовоеВзаимодействие["Автор"];
	НовоеВзаимодействие["ПлановаяДата"]        	= НовоеВзаимодействие["Дата"];
	НовоеВзаимодействие["Партнер"]             	= НовыйИнтерес.Партнер;
	НовоеВзаимодействие["Подразделение"]       	= НовыйИнтерес.Подразделение;
	НовоеВзаимодействие["ПотенциальныйКлиент"] 	= НовыйИнтерес.ПотенциальныйКлиент;
	НовоеВзаимодействие["СостояниеИнтереса"]   	= НовыйИнтерес.СостояниеИнтереса;
	НовоеВзаимодействие["Содержание"]          	= НСтр("ru='#Создан автоматически средствами СофтФон';en='# Created automatically with SoftPhone tools'"); 
	НовоеВзаимодействие["СтатусВзаимодействия"] = Справочники.CRM_СостоянияСобытий.Запланировано;
	
	Попытка
		НовоеВзаимодействие.Записать();
	Исключение
	КонецПопытки;
	
	Попытка
		НовыйИнтерес.Записать();
	Исключение
	КонецПопытки;
	Возврат НовыйИнтерес.Ссылка;
КонецФункции

/////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЕЙСТВИЙ

// Процедура добавляет в массив структуру действий
//
// Параметры:
//	МассивДействий	- Массив	- Массив доступных действий
//	Наименование	- Строка	- Наименование действия
//	Действие		- Строка	- Имя процедуры-обработчика действия, процедура должна располагаться в этом модуле
//
Процедура сфпДобавитьДействие(МассивДействий, Наименование, Действие)
	СтруктураДействия = Новый Структура;
	СтруктураДействия.Вставить("Наименование",	Наименование);
	СтруктураДействия.Вставить("Действие",		Действие);
	МассивДействий.Добавить(СтруктураДействия);
КонецПроцедуры // сфпДобавитьДействие()

// Функция возвращает массив структур доступных действий при звонке
//
// Параметры:
//	Нет.
//
// Возвращаемое значение:
//	Массив	- Массив структур доступных действий
//
Функция сфпПолучитьМассивДоступныхДействий() Экспорт
	
	МассивДействий = Новый Массив();
	
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Нет действий';en='No activity'"), "");
	
	УстановитьПривилегированныйРежим(Истина);
	Если Константы.сфпИспользоватьОблачнуюТелефонию.Получить() Тогда
		сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть Панель звонка'"), "сфпОткрытьПанельЗвонка");
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);

	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть Телефонный звонок'"), "сфпОткрытьТелефонныйЗвонок");
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть карточку контакта';en='Open contact card'"), "сфпОткрытьКарточкуКонтакта");
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Регистрация обращения';en='Registration of the appeal'"), "сфпРегистрацияОбращения");
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Краткая форма Телефонного звонка'"), "сфпОткрытьСтикер");
	//сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть интерес';en='Open Lead'"), "сфпОткрытьИнтерес");
		
	Если Метаданные.Документы.Найти("CRM_СчетНаОплатуПокупателю") <> Неопределено Тогда
		сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть счет на оплату';en='Open an account for payment'"), "сфпОткрытьСчетНаОплату");
	
	ИначеЕсли Метаданные.Документы.Найти("ЗаказКлиента") <> Неопределено Тогда
		сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть счет на оплату';en='Open an account for payment'"), "сфпОткрытьЗаказКлиента");
	КонецЕсли;
	
	Если Метаданные.Отчеты.Найти("CRM_Продажи") <> Неопределено Тогда
		сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть продажи';en='Open sales'"), "сфпОткрытьПродажи");
	КонецЕсли;
	
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть список анкет';en='Open a list of profiles'"), "сфпОткрытьСписокАнкет");
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть досье клиента';en='Open customer dossier'"), "сфпОткрытьДосьеКлиента");
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть дебиторскую задолженность';en='Open receivables'"), "сфпОткрытьДебиторскуюЗадолженность");
	сфпДобавитьДействие(МассивДействий,	Нстр("ru='Открыть ведомость взаиморасчетов';en='Open the settlement sheet'"), "сфпОткрытьВедомостьВзаиморасчетов");

	Возврат МассивДействий;
	
КонецФункции // сфпПолучитьМассивДоступныхДействий()

/////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ COMAGIC

// Функция возвращает идентификатор CoMagic
//
// Парамеры:
//	Ссылка	- ДокументСсылка	- Документ
//
// Возвращаемое значение:
//	Строка	- Идентификатор CoMagic
//
Функция сфпПолучитьCoMagicID(Ссылка) Экспорт
	CoMagicID = "";
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.ТелефонныйЗвонок") Тогда
		Если ТипЗнч(Ссылка.АбонентКонтакт) = Тип("СправочникСсылка.Партнеры") Тогда
			Если ПустаяСтрока(Ссылка.АбонентКонтакт.сфпCoMagicID) Тогда
				CoMagicID	= Ссылка.сфпCoMagicID;
		    Иначе
				CoMagicID	= Ссылка.АбонентКонтакт.сфпCoMagicID;
			КонецЕсли;
		ИначеЕсли ТипЗнч(Ссылка.АбонентКонтакт) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда
			Если ПустаяСтрока(Ссылка.АбонентКонтакт.сфпCoMagicID) Тогда
				Если ПустаяСтрока(Ссылка.АбонентКонтакт.Владелец.сфпCoMagicID) Тогда
					CoMagicID	= Ссылка.сфпCoMagicID;
				Иначе	
					CoMagicID	= Ссылка.АбонентКонтакт.Владелец.сфпCoMagicID;
				КонецЕсли;
		    Иначе
				CoMagicID	= Ссылка.АбонентКонтакт.сфпCoMagicID;
			КонецЕсли;
		Иначе
			CoMagicID	= Ссылка.сфпCoMagicID;
		КонецЕсли;
	Иначе
		CoMagicID	= Ссылка.сфпCoMagicID;
	КонецЕсли;	
	Возврат CoMagicID;
КонецФункции // сфпПолучитьCoMagicID(()

// Формирует структуру полей контактной информации типа Телефон или МобильныйТелефон по представлению телефона
//
// Параметры
//  Представление  - Строка - строковая информация с номером телефона
//
// Возвращаемое значение:
//   Структура   - сформированная структура
//
Функция ПреобразоватьНомерДляКонтактнойИнформации(знач Номер) Экспорт
	
	// Очистка пользовательских разделителей
	ЗаменяемыеСимволы = "()- ";
	Для НомерСимвола = 1 По СтрДлина(ЗаменяемыеСимволы) Цикл
		Номер = СтрЗаменить(Номер, Сред(ЗаменяемыеСимволы, НомерСимвола, 1), "");
	КонецЦикла;
	
	// Телефонный код России 7 (вызов внутри страны начинается на 8), коды сотовых операторов начинаются на 9.
	Если Лев(Номер, 2) = "89" Тогда
		Номер = "7"+Сред(Номер, 2);
	ИначеЕсли Лев(Номер, 3) = "+79" Тогда
		Номер = Сред(Номер, 2);
	КонецЕсли;
	
	Возврат Номер;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область MangoOffice

Функция КодировкаURL(Строка) Экспорт
	
	Возврат КодироватьСтроку(Строка, СпособКодированияСтроки.КодировкаURL);
	
КонецФункции

Функция ПолучитьSign(Параметр1, Параметр2, Параметр3, Параметр4 = Неопределено) Экспорт
	
	ХешированиеДанных = Новый ХешированиеДанных(ХешФункция.SHA256);
	ХешированиеДанных.Добавить(Параметр1);
	ХешированиеДанных.Добавить(Параметр2);
	ХешированиеДанных.Добавить(Параметр3);
	
	Если Параметр4 <> Неопределено Тогда
		ХешированиеДанных.Добавить(Параметр4);
	КонецЕсли;	
	
	Возврат НРег(СтрЗаменить(Строка(ХешированиеДанных.ХешСумма), " ", ""));
	
КонецФункции

Функция РасшифровкаОшибкиMango(Знач Код)
	
	Код = Формат(Код, "ЧГ=0");
	
	Если сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "21") Тогда // 2100
		Возврат НСтр("ru='Доступ к счету невозможен'");
	ИначеЕсли Код = "2210" Тогда
		Возврат НСтр("ru='Доступ ограничен периодом использования'");
	ИначеЕсли Код = "2211" Тогда
		Возврат НСтр("ru='Достигнут дневной лимит использования услуги'");
	ИначеЕсли Код = "2212" Тогда
		Возврат НСтр("ru='Достигнут месячный лимит использования услуги'");
	ИначеЕсли Код = "2220" Тогда
		Возврат НСтр("ru='Количество одновременных вызовов/действий ограничено'");
	ИначеЕсли Код = "2230" Тогда
		Возврат НСтр("ru='Услуга недоступна'");
	ИначеЕсли Код = "2240" Тогда
		Возврат НСтр("ru='Недостаточно средств на счете'");
	ИначеЕсли Код = "2250" Тогда
		Возврат НСтр("ru='Ограничение на количество использований услуги в биллинге'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "22") Тогда // 2200
		Возврат НСтр("ru='Доступ к счету ограничен'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "23") Тогда // 2300
		Возврат НСтр("ru='Направление заблокировано'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "24") Тогда // 2400
		Возврат НСтр("ru='Ошибка биллинга'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "2") Тогда // 2000
		Возврат НСтр("ru='Ограничение биллинговой системы'");
	ИначеЕсли Код = "3100" Тогда
		Возврат НСтр("ru='Переданы неверные параметры команды'");
	ИначеЕсли Код = "3101" Тогда
		Возврат НСтр("ru='Запрос выполнен по методу, отличному от POST'");
	ИначеЕсли Код = "3102" Тогда
		Возврат НСтр("ru='Значение ключа не соответствуют рассчитанному'");
	ИначеЕсли Код = "3103" Тогда
		Возврат НСтр("ru='В запросе отсутствует обязательный параметр'");
	ИначеЕсли Код = "3104" Тогда
		Возврат НСтр("ru='Параметр передан в неправильном формате'");
	ИначеЕсли Код = "3105" Тогда
		Возврат НСтр("ru='Неверный ключ доступа'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "32") Тогда // 3200
		Возврат НСтр("ru='Неверно указан номер абонента'");
	ИначеЕсли Код = "3310" Тогда
		Возврат НСтр("ru='Вызов не найден'");
	ИначеЕсли Код = "3320" Тогда
		Возврат НСтр("ru='Запись разговора не найдена'");
	ИначеЕсли Код = "3330" Тогда
		Возврат НСтр("ru='Номер не найден у ВАТС или сотрудника'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "33") Тогда // 3300
		Возврат НСтр("ru='Объект не существует'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "3") Тогда // 3000
		Возврат НСтр("ru='Неверный запрос'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "4") Тогда // 4000
		Возврат НСтр("ru='Действие не может быть выполнено'");
	ИначеЕсли сфпОбщегоНазначения.сфпСтрНачинаетсяС(Код, "5") Тогда // 5000
		Возврат НСтр("ru='Ошибка сервера'");
	Иначе
		Возврат НСтр("ru='Неизвестная ошибка';en='Unknown error'");
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область Itoolabs

Функция РасшифровкаОшибкиItoolabs(Код)
	
	Если Код = 400 Тогда
		Возврат НСтр("ru='Переданы некорректные параметры'");
	ИначеЕсли Код = 401 Тогда
		Возврат НСтр("ru='Передан неверный ключ (token)'");
	Иначе
		Возврат НСтр("ru='Неизвестная ошибка';en='Unknown error'")
	КонецЕсли;
	
КонецФункции

Функция ЭтоПлатформаITooLabs(АТС) Экспорт
	
	АТСНаПлатформеItoolabs = Новый Массив();
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.УниверсальныйItoolabs);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.ДомRu);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.ВестКоллСПб);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.ДеловаяСетьИркутск);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.Энфорта);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.Мегафон);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.ТТК);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.ВестКоллМосква);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.VirginConnect);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.ГарсТелеком);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.НаукаСвязь);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.RiNet);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.СибирскиеСети);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.Авантел);
	АТСНаПлатформеItoolabs.Добавить(Перечисления.сфпДоступныеАТС.Гравител);
	
	Возврат АТСНаПлатформеItoolabs.Найти(АТС) <> Неопределено;
	
КонецФункции

#КонецОбласти

#Область ЯндексТелефония

Функция ТокенДоступаAPI(ВнутреннийНомер, Ошибка)
	
	Токен = АктуальныйТокенДоступаAPI(ВнутреннийНомер);
	
	Если Токен = Неопределено Тогда
		Токен = НовыйТокенДоступаAPI(ВнутреннийНомер, Ошибка);
	КонецЕсли;
	
	Возврат Токен;
	
КонецФункции

Функция АктуальныйТокенДоступаAPI(ВнутреннийНомер)
	
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерЗаписи = РегистрыСведений.сфпТокеныДоступаAPIТелефонии.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.ВнутреннийНомер = ВнутреннийНомер;
	МенеджерЗаписи.Прочитать();
	
	Если НЕ ЗначениеЗаполнено(МенеджерЗаписи.Токен) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если МенеджерЗаписи.СрокДействия < ТекущаяДатаСеанса() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат МенеджерЗаписи.Токен;
	
КонецФункции

Функция НовыйТокенДоступаAPI(ВнутреннийНомер, Ошибка)
	
	ДанныеАвторизации = ЗапроситьТокенДоступа(ВнутреннийНомер, Ошибка);
	
	Если ЗначениеЗаполнено(Ошибка) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ДанныеАвторизации = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ЗаписатьТокенДоступа(ВнутреннийНомер, ДанныеАвторизации.access_token, ТекущаяДатаСеанса() + ДанныеАвторизации.expires_in);
	
	Возврат ДанныеАвторизации.access_token;
	
КонецФункции

Функция ЗапроситьТокенДоступа(ВнутреннийНомер, Ошибка)
	
	api_key = сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии().КлючДляАвторизацииАТСЯндекс;
	
	URL = сфпСофтФонПроСервер.КорневойАдресАТС() + "api/v2/auth/token";
	СтруктураURI = сфпОбщегоНазначенияКлиентСервер.СтруктураURI(URL);
	
	ПараметрыЗапроса = Новый Массив;
	ПараметрыЗапроса.Добавить("grant_type=client_credentials");
	ПараметрыЗапроса.Добавить("client_id=" + api_key);
	ПараметрыЗапроса.Добавить("client_secret=" + ВнутреннийНомер);
	
	HTTPЗапрос = Новый HTTPЗапрос();
	HTTPЗапрос.АдресРесурса = СтруктураURI.ПутьНаСервере;
	HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/x-www-form-urlencoded");
	HTTPЗапрос.Заголовки.Вставить("x-api-key", api_key);
	HTTPЗапрос.УстановитьТелоИзСтроки(сфпОбщегоНазначения.сфпСтрСоединить(ПараметрыЗапроса, "&"),
		КодировкаТекста.UTF8,
		ИспользованиеByteOrderMark.НеИспользовать);
	
	HTTPСоединение = Новый HTTPСоединение(СтруктураURI.Хост, СтруктураURI.Порт,,,,, Новый ЗащищенноеСоединениеOpenSSL);
	
	HTTPОтвет = HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
	
	Если HTTPОтвет.КодСостояния <> 200 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТелоЗапроса = РаскодироватьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку(), СпособКодированияСтроки.КодировкаURL);
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
	ПараметрыЗапроса = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();
	
	Если ПараметрыЗапроса.Свойство("error") И ПараметрыЗапроса.error = "invalid_client" Тогда
		Ошибка = "НекорректныйВнутреннийНомерПользователя";
	КонецЕсли;
	
	Возврат ПараметрыЗапроса;
	
КонецФункции

Функция ЗаписатьТокенДоступа(ВнутреннийНомер, Токен, СрокДействия)
	
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерЗаписи = РегистрыСведений.сфпТокеныДоступаAPIТелефонии.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.ВнутреннийНомер = ВнутреннийНомер;
	МенеджерЗаписи.Токен = Токен;
	МенеджерЗаписи.СрокДействия = СрокДействия;
	МенеджерЗаписи.Записать();
	
КонецФункции

Функция ДанныеЗвонка(ИдентификаторЗвонка, ВнутреннийНомер, Ошибка)
	
	Токен = ТокенДоступаAPI(ВнутреннийНомер, Ошибка);
	
	Если ЗначениеЗаполнено(Ошибка) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если Токен = Неопределено Тогда
		ВызватьИсключение НСтр("ru='Не удалось авторизоваться.'");
	КонецЕсли;
	
	URL = сфпСофтФонПроСервер.КорневойАдресАТС() + "api/v2/calls/" + ИдентификаторЗвонка;
	СтруктураURI = сфпОбщегоНазначенияКлиентСервер.СтруктураURI(URL);
	
	HTTPЗапрос = Новый HTTPЗапрос();
	HTTPЗапрос.АдресРесурса = СтруктураURI.ПутьНаСервере;
	HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
	HTTPЗапрос.Заголовки.Вставить("Authorization", "bearer " + Токен);
	HTTPЗапрос.Заголовки.Вставить("x-api-key", сфпСофтФонПроСервер.ПолучитьНастройкиТелефонии().КлючДляАвторизацииАТСЯндекс);
	
	HTTPСоединение = Новый HTTPСоединение(СтруктураURI.Хост, СтруктураURI.Порт,,,,, Новый ЗащищенноеСоединениеOpenSSL);
	
	HTTPОтвет = HTTPСоединение.ВызватьHTTPМетод("GET", HTTPЗапрос);
		
	Если HTTPОтвет.КодСостояния <> 200 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТелоЗапроса = РаскодироватьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку(), СпособКодированияСтроки.КодировкаURL);
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
	ПараметрыЗапроса = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();
	
	Если ПараметрыЗапроса.Свойство("data") Тогда
		Если ПараметрыЗапроса.data.Свойство("callRecord") Тогда
			ДанныеЗаписи = ПараметрыЗапроса.data.callRecord;
			Возврат ДанныеЗаписи.Uri;
		КонецЕсли;	
	КонецЕсли;	
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

Функция СобытиеЖурналаРегистрации() Экспорт
	
	Возврат НСтр("ru='Телефония'");
	
КонецФункции

Процедура ЗаписатьЗапросВЖурналРегистрации(ВложенноеИмяСобытия, Текст, УровеньЖР = Неопределено) Экспорт
	
	Если УровеньЖР = Неопределено Тогда
		УровеньЖР = УровеньЖурналаРегистрации.Примечание;
	КонецЕсли;
	
	ЗаписьЖурналаРегистрации(
		СобытиеЖурналаРегистрации() + "." + ВложенноеИмяСобытия,
		УровеньЖР,,,
		Текст);
	
КонецПроцедуры

Функция НастройкиИнтеграцииЗаполнены(АТС, НастройкиТелефонии)
	
	Если АТС = Перечисления.сфпДоступныеАТС.СофтФонWebModule Тогда
		Возврат ЗначениеЗаполнено(НастройкиТелефонии.АдресОблачнойАТС)
			И ЗначениеЗаполнено(НастройкиТелефонии.vpbx_api_key)
			И ЗначениеЗаполнено(НастройкиТелефонии.vpbx_api_salt);
			
	ИначеЕсли АТС = Перечисления.сфпДоступныеАТС.MangoOffice Тогда
		Возврат ЗначениеЗаполнено(НастройкиТелефонии.vpbx_api_key)
			И ЗначениеЗаполнено(НастройкиТелефонии.vpbx_api_salt);
		
	ИначеЕсли АТС = Перечисления.сфпДоступныеАТС.Яндекс Тогда
		Возврат ЗначениеЗаполнено(НастройкиТелефонии.КлючДляАвторизацииАТСЯндекс);
		
	ИначеЕсли АТС = Перечисления.сфпДоступныеАТС.Билайн Тогда
		Возврат ЗначениеЗаполнено(НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС);
		
	Иначе
		Возврат ЗначениеЗаполнено(НастройкиТелефонии.АдресОблачнойАТС)
			И ЗначениеЗаполнено(НастройкиТелефонии.КлючДляАвторизацииВОблачнойАТС)
			И ЗначениеЗаполнено(НастройкиТелефонии.КлючДляАвторизацииВИБ);	
	КонецЕсли;
	
КонецФункции

#КонецОбласти

