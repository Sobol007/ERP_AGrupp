
////////////////////////////////////////////////////////////////////////////////
// CRM работа АРМ Сервер
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Первоначальное заполнение АРМ
//
// Параметры:
//  Параметры	 - Структура - Дополнительные параметры.
//
Процедура ПервоначальноеЗаполнениеАРМ(Параметры) Экспорт
	Набор = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьНаборЗаписей();
	Набор.Записывать = Истина;
	Набор.Записать(Истина);
	
	// Мои дела
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТелефонныйЗвонок.Ссылка,
	|	ЛОЖЬ КАК НаКонтроле,
	|	ТелефонныйЗвонок.Тема КАК Тема,
	|	ТелефонныйЗвонок.Дата КАК ДатаПолучения,
	|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК КрайнийСрок,
	|	ТелефонныйЗвонок.АбонентКонтакт КАК Контакт,
	|	ТелефонныйЗвонок.АбонентКакСвязаться КАК КонтактАдрес
	|ИЗ
	|	Документ.ТелефонныйЗвонок КАК ТелефонныйЗвонок
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЭлектронноеПисьмоВходящее.Ссылка,
	|	ЛОЖЬ,
	|	ЭлектронноеПисьмоВходящее.Тема,
	|	ЭлектронноеПисьмоВходящее.ДатаПолучения,
	|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0),
	|	ЭлектронноеПисьмоВходящее.ОтправительКонтакт,
	|	ЭлектронноеПисьмоВходящее.ОтправительАдрес
	|ИЗ
	|	Документ.ЭлектронноеПисьмоВходящее КАК ЭлектронноеПисьмоВходящее";
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Выборка.ссылка.Пустая() Тогда Продолжить конецЕсли;
		Об = Выборка.ссылка.получитьОбъект();
		CRM_ЗаполнениеАРММоиДела(Об, Ложь);
		CRM_ЗаполнениеАРММоиПродажи(Об, Ложь)
	КонецЦикла;
	
	Запрос.Текст = "ВЫБРАТЬ
	|	CRM_Взаимодействие.Ссылка
	|ИЗ
	|	Документ.CRM_Взаимодействие КАК CRM_Взаимодействие
	|ГДЕ
	|	НЕ CRM_Взаимодействие.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗадачаИсполнителя.Ссылка
	|ИЗ
	|	Задача.ЗадачаИсполнителя КАК ЗадачаИсполнителя
	|ГДЕ
	|	НЕ ЗадачаИсполнителя.ПометкаУдаления";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Об = Выборка.Ссылка.ПолучитьОбъект();
		CRM_ЗаполнениеАРМПриЗаписи(Об, Ложь);
	КонецЦикла;
	
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	CRM_ЗадачиПользователей.Объект КАК Ссылка,
	|	ВЫБОР
	|		КОГДА CRM_ЗадачиПользователей.Объект.Ссылка ССЫЛКА Задача.ЗадачаИсполнителя
	|			ТОГДА ВЫБОР
	|					КОГДА CRM_ЗадачиПользователей.Объект.Выполнена
	|						ТОГДА ЗНАЧЕНИЕ(Справочник.CRM_СостоянияСобытий.Завершено)
	|					ИНАЧЕ CRM_ЗадачиПользователей.Статус
	|				КОНЕЦ
	|		ИНАЧЕ CRM_ЗадачиПользователей.Статус
	|	КОНЕЦ КАК Статус,
	|	CRM_ЗадачиПользователей.Пользователь
	|ИЗ
	|	РегистрСведений.CRM_ЗадачиПользователей КАК CRM_ЗадачиПользователей
	|ГДЕ
	|	CRM_ЗадачиПользователей.Статус <> ЗНАЧЕНИЕ(Справочник.CRM_СостоянияСобытий.Отменено)";
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Выборка.Статус = Справочники.CRM_СостоянияСобытий.Завершено Тогда
			Попытка
				Об = Выборка.Ссылка.ПолучитьОбъект();
				CRM_ЗаполнениеАРМПриЗаписи(Об, Ложь);
			Исключение
			КонецПопытки;	
		КонецЕсли;	
	КонецЦикла;
	
	// Мои продажи
	Запрос.Текст = "ВЫБРАТЬ
	|	CRM_Интерес.Ссылка
	|ИЗ
	|	Документ.CRM_Интерес КАК CRM_Интерес
	|ГДЕ
	|	НЕ CRM_Интерес.ПометкаУдаления";
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Выборка.ссылка.Пустая() Тогда Продолжить конецЕсли;
		Об = Выборка.ссылка.получитьОбъект();
		CRM_ЗаполнениеАРММоиПродажи(Об, Ложь)
	КонецЦикла;
КонецПроцедуры	

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура CRM_ЗаполнениеАРММоиДела(Источник, Отказ) Экспорт
	
	Ссылка = Источник.ссылка;
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	CRM_ОбъектыАРМ.Объект,
	|	CRM_ОбъектыАРМ.НаименованиеАРМ,
	|	CRM_ОбъектыАРМ.ИзмерениеАРМ,
	|	CRM_ОбъектыАРМ.Пользователь
	|ИЗ
	|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
	|ГДЕ
	|	CRM_ОбъектыАРМ.Объект = &Объект
	|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ";
	Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
	Запрос.УстановитьПараметр("Объект", Ссылка);
	Выборка = Запрос.Выполнить().Выбрать();
	ТекущееИзмерение = "";
	Пока Выборка.Следующий() Цикл
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.Объект = Ссылка;
		Запись.НаименованиеАРМ = "МоиДела";
		Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
		Запись.Пользователь = Выборка.Пользователь;
		Запись.Прочитать();
		Если Запись.Объект <> Неопределено Тогда
			ТекущееИзмерение = Выборка.ИзмерениеАРМ;
			Если ТипЗнч(Ссылка) = Тип("ЗадачаСсылка.ЗадачаИсполнителя") Тогда
				БизнесПроцесс = Источник.БизнесПроцесс;
				Если Источник.Выполнена Тогда
					СтатусЗадачи = Справочники.CRM_СостоянияСобытий.Завершено;
				ИначеЕсли ЗначениеЗаполнено(БизнесПроцесс) И БизнесПроцесс.Завершен И НЕ Источник.Выполнена Тогда
					СтатусЗадачи = Справочники.CRM_СостоянияСобытий.Отменено;
				ИначеЕсли ЗначениеЗаполнено(БизнесПроцесс) И БизнесПроцесс.Стартован И НЕ БизнесПроцесс.Завершен И НЕ Источник.ПринятаКИсполнению Тогда
					СтатусЗадачи = Справочники.CRM_СостоянияСобытий.Запланировано;
				ИначеЕсли ЗначениеЗаполнено(БизнесПроцесс) И БизнесПроцесс.Стартован И НЕ БизнесПроцесс.Завершен И Источник.ПринятаКИсполнению Тогда
					СтатусЗадачи = Справочники.CRM_СостоянияСобытий.ВРаботе;
				КонецЕсли;
				Если СтатусЗадачи <> Справочники.CRM_СостоянияСобытий.Завершено И СтатусЗадачи <> Справочники.CRM_СостоянияСобытий.Запланировано Тогда
					// Возврат;
				КонецЕсли;
				
			ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_Взаимодействие") Тогда
				Если Источник.СтатусВзаимодействия <> Справочники.CRM_СостоянияСобытий.Завершено И Источник.СтатусВзаимодействия <> Справочники.CRM_СостоянияСобытий.Отменено Тогда
					// Возврат;
				КонецЕсли;	
			Иначе	
				Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЭлектронноеПисьмоВходящее") или ТипЗнч(Ссылка) = Тип("ДокументСсылка.ТелефонныйЗвонок") ИЛИ ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_СообщениеМессенджера") Тогда
					Если Ссылка.CRM_СкрытьВАРМ Тогда 
						Запись.Удалить();
					КонецЕсли;
				КонецЕсли;	
				// Возврат;
			КонецЕсли;	
		КонецЕсли;
		Если ТипЗнч(Ссылка) <> Тип("ДокументСсылка.удалитьCRM_Мероприятие") Тогда
			Запись.Удалить();
		КонецЕсли;	
	КонецЦикла;
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_Интерес") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	CRM_Взаимодействие.Ссылка
		|ИЗ
		|	Документ.CRM_Взаимодействие КАК CRM_Взаимодействие
		|ГДЕ
		|	CRM_Взаимодействие.ДокументОснование = &ДокументОснование";
		Запрос.УстановитьПараметр("ДокументОснование", Ссылка);
		ВыборкаВзаимодействия = Запрос.Выполнить().Выбрать();
		Пока ВыборкаВзаимодействия.Следующий() Цикл
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	CRM_ОбъектыАРМ.Объект,
			|	CRM_ОбъектыАРМ.НаименованиеАРМ,
			|	CRM_ОбъектыАРМ.ИзмерениеАРМ,
			|	CRM_ОбъектыАРМ.Пользователь
			|ИЗ
			|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
			|ГДЕ
			|	CRM_ОбъектыАРМ.Объект = &Объект
			|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ";
			Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
			Запрос.УстановитьПараметр("Объект", ВыборкаВзаимодействия.Ссылка);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
				Запись.Объект = Ссылка;
				Запись.НаименованиеАРМ = "МоиДела";
				Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
				Запись.Пользователь = Выборка.Пользователь;
				Запись.Прочитать();
				Запись.Удалить();
				Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
				Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
			Иначе	
				Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
				Если ВыборкаВзаимодействия.Ссылка.Ответственный = ВыборкаВзаимодействия.Ссылка.Автор Тогда
					Запись.ИзмерениеАРМ = "Текущие";
				Иначе
					Запись.ИзмерениеАРМ = "Входящие";
				КонецЕсли;
			КонецЕсли;
			
			Если ВыборкаВзаимодействия.Ссылка.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Отменено Или Источник.ПометкаУдаления Тогда
				Продолжить;
			КонецЕсли;
			
			Запись.ДатаДляСортировки = ВыборкаВзаимодействия.Ссылка.ПлановаяДата;
			Запись.Объект = ВыборкаВзаимодействия.Ссылка;
			Контакт = "";
			Если ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.Партнер) Тогда
				Контакт = ВыборкаВзаимодействия.Ссылка.Партнер.Наименование;
				Запись.Клиент = ВыборкаВзаимодействия.Ссылка.Партнер;
			ИначеЕсли ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо) Тогда
				Контакт = ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо.Наименование;
				Запись.Контакт = ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо;
			ИначеЕсли ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.ПотенциальныйКлиент) Тогда
				Контакт = ВыборкаВзаимодействия.Ссылка.ПотенциальныйКлиент.Наименование;
				Запись.Клиент = ВыборкаВзаимодействия.Ссылка.ПотенциальныйКлиент;
			КонецЕсли;
			Если ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо) Тогда
				Запись.Контакт = ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо;
			КонецЕсли;	
			Запись.КрайнийСрок = ВыборкаВзаимодействия.Ссылка.ПлановаяДата;
			тТема 			= ВыборкаВзаимодействия.Ссылка.Тема;
			ТекстОписания = Строка(ВыборкаВзаимодействия.Ссылка.СостояниеИнтереса);
			НаКонтроле = Ложь;
			ДатаПолучения = Дата('00010101');
			// Контакт = "";
			КонтактАдрес = "";
			Запись.Пользователь = ВыборкаВзаимодействия.Ссылка.Ответственный;
			Срок = ВыборкаВзаимодействия.Ссылка.ПлановаяДата;
			Запись.День = Формат(Срок, "ДЛФ=DD");
			Запись.Избранный = Источник.Избранный;
			Запись.ВидКартинки = 9;
			
			
			Запись.Время = Формат(Срок, "ДФ=HH:mm") + " - " + Формат(ВыборкаВзаимодействия.Ссылка.ПлановаяДатаЗавершение, "ДФ='HH:mm'");
			
			Если ВыборкаВзаимодействия.Ссылка.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Завершено Тогда
				Запись.ИзмерениеАРМ = "Завершенные";
				Запись.ДатаДляСортировки =  ВыборкаВзаимодействия.Ссылка.ДатаЗавершенияВзаимодействия;
			КонецЕсли;
			Запись.НаименованиеАРМ = "МоиДела";
			
			Запись.Заголовок = Строка(тТема);
			
			ТекстОписания = ?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "") + ?(ЗначениеЗаполнено(КонтактАдрес),?(ЗначениеЗаполнено(Контакт)," | ", "")+" <" + КонтактАдрес + ">", "")+?(ЗначениеЗаполнено(Контакт) или ЗначениеЗаполнено(КонтактАдрес)," | ", "")+ТекстОписания;
			
			Запись.ТекстОснования = ТекстОписания;
			
			Запись.Записать(Истина);
			
		КонецЦикла;	
		Возврат;
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЭлектронноеПисьмоВходящее") Тогда
		Если Ссылка.ПометкаУдаления ИЛИ Ссылка.CRM_СкрытьВАРМ Тогда Возврат КонецЕсли;
		Если ЗначениеЗаполнено(Источник.CRM_РольОтветственного) Тогда
			Пользователь = Источник.CRM_РольОтветственного;
		ИначеЕсли ЗначениеЗаполнено(Источник.Ответственный) Тогда
			Пользователь = Источник.Ответственный;
		Иначе
			Возврат;
		КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = Источник.Дата;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.Дата;
		тТема 			= Источник.Тема;
		НаКонтроле = Ложь;
		ДатаПолучения = Источник.Дата;
		Контакт = Источник.ОтправительКонтакт;
		Если ТипЗнч(Контакт) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда
			Запись.Клиент = Контакт.Владелец;
			Контакт = Контакт.Владелец;
		КонецЕсли;	
		Запись.Контакт = Источник.ОтправительКонтакт;
		КонтактАдрес = Источник.ОтправительАдрес;
		ТекстОписания = "";	
		Запись.Пользователь = Пользователь;
		Запись.ИзмерениеАРМ = "Входящие";
		Срок = Источник.ДатаПолучения;
		Запись.День =  Формат(Срок, "ДЛФ=DD");
		Запись.ВидКартинки = 12;
		Если Источник.Важность = Перечисления.ВариантыВажностиВзаимодействия.Высокая Тогда
			Запись.Избранный = Истина;
		Иначе	
			Запись.Избранный = Ложь;
		КонецЕсли;	
		Запись.Время = Формат(Источник.ДатаПолучения, "ДФ='HH:mm'") + " - " + Формат(Источник.ДатаПолучения, "ДФ='HH:mm'");
		Запись.НаименованиеАРМ = "МоиДела";
		
		Запись.Заголовок = Строка(тТема);
		
		ТекстОписания = ?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "") + ?(ЗначениеЗаполнено(КонтактАдрес),?(ЗначениеЗаполнено(Контакт)," | ", "")+" <" + КонтактАдрес + ">", "")+?(ЗначениеЗаполнено(Контакт) или ЗначениеЗаполнено(КонтактАдрес)," | ", "")+ТекстОписания;
		
		Запись.ТекстОснования = ТекстОписания;
		
		Запись.Записать(Истина);
		
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ТелефонныйЗвонок") Тогда
		Если Ссылка.CRM_СкрытьВАРМ Тогда Возврат КонецЕсли;
		Если НЕ Источник.Входящий Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = Источник.Дата;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.Дата;
		тТема 			= Источник.Тема;
		НаКонтроле = Ложь;
		ТекстОписания = "";
		ДатаПолучения = Источник.Дата;
		Контакт = Источник.АбонентКонтакт;
		Если ТипЗнч(Контакт) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда
			Запись.Клиент = Контакт.Владелец;
			Контакт = Контакт.Владелец;
			
		КонецЕсли;	
		Запись.Контакт = Источник.АбонентКонтакт;
		КонтактАдрес = Источник.АбонентКакСвязаться;
		Запись.Пользователь = Источник.Ответственный;
		Запись.ИзмерениеАРМ = "Входящие";
		Срок = Источник.Дата;
		Запись.День = Формат(Срок, "ДЛФ=DD");
		Запись.ВидКартинки = 13;
		Если Источник.Важность = Перечисления.ВариантыВажностиВзаимодействия.Высокая Тогда
			Запись.Избранный = Истина;
		Иначе	
			Запись.Избранный = Ложь;
		КонецЕсли;
		Запись.Время = Формат(Срок, "ДФ='HH:mm'") + " - " + Формат(Срок, "ДФ='HH:mm'");
		Запись.НаименованиеАРМ = "МоиДела";
		
		Запись.Заголовок = Строка(тТема);
		
		ТекстОписания = ?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "") + ?(ЗначениеЗаполнено(КонтактАдрес),?(ЗначениеЗаполнено(Контакт)," | ", "")+" <" + КонтактАдрес + ">", "")+?(ЗначениеЗаполнено(Контакт) или ЗначениеЗаполнено(КонтактАдрес)," | ", "")+ТекстОписания;
		
		Запись.ТекстОснования = ТекстОписания;
		
		Запись.Записать(Истина);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.удалитьCRM_Мероприятие") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	CRM_ОбъектыАРМ.Объект,
		|	CRM_ОбъектыАРМ.НаименованиеАРМ,
		|	CRM_ОбъектыАРМ.ИзмерениеАРМ,
		|	CRM_ОбъектыАРМ.Пользователь
		|ИЗ
		|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
		|ГДЕ
		|	CRM_ОбъектыАРМ.Объект = &Объект
		|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ";
		Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
		Запрос.УстановитьПараметр("Объект", Ссылка);
		// Запрос.УстановитьПараметр("Пользователь", Источник.Ответственный);
		Выборка = Запрос.Выполнить().Выбрать();

		// Если НЕ Источник.Входящий Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Пока Выборка.Следующий() Цикл
			Стр = Источник.СвоиЛица.Найти(Выборка.Пользователь, "Лицо");
			Если Стр  = Неопределено И Выборка.Пользователь<>Источник.Ответственный Тогда
				Запись.Объект = Ссылка;
				Запись.НаименованиеАРМ = "МоиДела";
				Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
				Запись.Пользователь = Выборка.Пользователь;
				Запись.Прочитать();
				Запись.Удалить();
			КонецЕсли;
		КонецЦикла;
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	CRM_ОбъектыАРМ.Объект КАК Объект,
		|	CRM_ОбъектыАРМ.НаименованиеАРМ КАК НаименованиеАРМ,
		|	CRM_ОбъектыАРМ.ИзмерениеАРМ КАК ИзмерениеАРМ,
		|	CRM_ОбъектыАРМ.Пользователь КАК Пользователь
		|ИЗ
		|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
		|ГДЕ
		|	CRM_ОбъектыАРМ.Объект = &Объект
		|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ
		|	И CRM_ОбъектыАРМ.Пользователь = &Пользователь";
		Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
		Запрос.УстановитьПараметр("Объект", Ссылка);
		Запрос.УстановитьПараметр("Пользователь", Источник.Ответственный);
		Выборка = Запрос.Выполнить().Выбрать();

		// Если НЕ Источник.Входящий Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Если Выборка.Следующий() Тогда
			Запись.Объект = Ссылка;
			Запись.НаименованиеАРМ = "МоиДела";
			Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
			Запись.Пользователь = Выборка.Пользователь;
			Запись.Прочитать();
			Запись.Удалить();
		КонецЕсли;
		
		Возврат; // убираем записи по мероприятиям, т.к. конвертируем во взаимодействия.
		
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_Взаимодействие") И Ссылка.ВидВзаимодействия.ВидСобытия = Перечисления.CRM_ВидыСобытий.ЛичнаяВстреча Тогда	
		Если Ссылка.ПометкаУдаления Тогда Возврат КонецЕсли;
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	CRM_ОбъектыАРМ.Объект,
		|	CRM_ОбъектыАРМ.НаименованиеАРМ,
		|	CRM_ОбъектыАРМ.ИзмерениеАРМ,
		|	CRM_ОбъектыАРМ.Пользователь
		|ИЗ
		|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
		|ГДЕ
		|	CRM_ОбъектыАРМ.Объект = &Объект
		|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ";
		Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
		Запрос.УстановитьПараметр("Объект", Ссылка);
		// Запрос.УстановитьПараметр("Пользователь", Источник.Ответственный);
		Выборка = Запрос.Выполнить().Выбрать();

		// Если НЕ Источник.Входящий Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Пока Выборка.Следующий() Цикл
			Стр = Источник.СвоиЛица.Найти(Выборка.Пользователь, "Лицо");
			Если Стр  = Неопределено И Выборка.Пользователь<>Источник.Ответственный Тогда
				Запись.Объект = Ссылка;
				Запись.НаименованиеАРМ = "МоиДела";
				Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
				Запись.Пользователь = Выборка.Пользователь;
				Запись.Прочитать();
				Запись.Удалить();
			КонецЕсли;
		КонецЦикла;
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	CRM_ОбъектыАРМ.Объект КАК Объект,
		|	CRM_ОбъектыАРМ.НаименованиеАРМ КАК НаименованиеАРМ,
		|	CRM_ОбъектыАРМ.ИзмерениеАРМ КАК ИзмерениеАРМ,
		|	CRM_ОбъектыАРМ.Пользователь КАК Пользователь
		|ИЗ
		|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
		|ГДЕ
		|	CRM_ОбъектыАРМ.Объект = &Объект
		|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ
		|	И CRM_ОбъектыАРМ.Пользователь = &Пользователь";
		Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
		Запрос.УстановитьПараметр("Объект", Ссылка);
		Запрос.УстановитьПараметр("Пользователь", Источник.Ответственный);
		Выборка = Запрос.Выполнить().Выбрать();

		// Если НЕ Источник.Входящий Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Если Выборка.Следующий() Тогда
			Запись.Объект = Ссылка;
			Запись.НаименованиеАРМ = "МоиДела";
			Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
			Запись.Пользователь = Выборка.Пользователь;
			Запись.Прочитать();
			Запись.Удалить();
		КонецЕсли;
		
		Запись.ДатаДляСортировки = Источник.ПлановаяДата;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.ПлановаяДата;
		тТема 			= Источник.Тема;
		НаКонтроле = Ложь;
		ТекстОписания = "";
		ДатаПолучения = Источник.Дата;
		Запись.Контакт = Источник.СписокУчастников;
		Запись.Пользователь = Источник.Ответственный;
		Если Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Завершено или  Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Отменено Тогда
			Запись.ИзмерениеАРМ = "Завершенные";
		Иначе
			Попытка
				Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
			Исключение	
				Запись.ИзмерениеАРМ = "Текущие";
			КонецПопытки;
		КонецЕсли;
		Если Запись.ИзмерениеАРМ = "" Тогда
			Запись.ИзмерениеАРМ = "Текущие";
		КонецЕсли;	
		Срок = Источник.ПлановаяДата;
		Запись.День = Формат(Срок, "ДЛФ=DD");
		Запись.ВидКартинки = 15;
		Запись.Избранный = Ложь;
		Запись.Время = Формат(Срок, "ДФ='HH:mm'") + " - " + Формат(Срок, "ДФ='HH:mm'");
		Запись.НаименованиеАРМ = "МоиДела";
		
		Запись.Заголовок = Строка(тТема);
		
		
		Запись.ТекстОснования = Источник.Содержание;
		
		Запись.Записать(Истина);	
		Для Каждого СтрокаУчастники Из Источник.СвоиЛица Цикл
			Если СтрокаУчастники.Лицо <> Источник.Ответственный И ТипЗнч(СтрокаУчастники.Лицо) = Тип("СправочникСсылка.Пользователи") Тогда
				
				
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ
				|	CRM_ОбъектыАРМ.Объект,
				|	CRM_ОбъектыАРМ.НаименованиеАРМ,
				|	CRM_ОбъектыАРМ.ИзмерениеАРМ,
				|	CRM_ОбъектыАРМ.Пользователь
				|ИЗ
				|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
				|ГДЕ
				|	CRM_ОбъектыАРМ.Объект = &Объект
				|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ
				|	И CRM_ОбъектыАРМ.Пользователь = &Пользователь";
				Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
				Запрос.УстановитьПараметр("Объект", Ссылка);
				Запрос.УстановитьПараметр("Пользователь", СтрокаУчастники.Лицо);
				Выборка = Запрос.Выполнить().Выбрать();
				Если Выборка.Следующий() Тогда
					Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
					Запись.Объект = Ссылка;
					Запись.НаименованиеАРМ = "МоиДела";
					Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
					Запись.Пользователь = Выборка.Пользователь;
					Запись.Прочитать();
					Запись.Удалить();
					Запись.ДатаДляСортировки = Источник.ПлановаяДата;
					Запись.Объект = Ссылка;
					Запись.КрайнийСрок = Источник.ПлановаяДата;
					тТема 			= Источник.Тема;
					НаКонтроле = Ложь;
					ТекстОписания = "";
					ДатаПолучения = Источник.Дата;
					Запись.Контакт = Источник.СписокУчастников;
					Запись.Пользователь = СтрокаУчастники.Лицо;
					Если Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Завершено или  Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Отменено Тогда
						Запись.ИзмерениеАРМ = "Завершенные";
					Иначе
						Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
					КонецЕсли;
					
					Срок = Источник.ПлановаяДата;
					Запись.День = Формат(Срок, "ДЛФ=DD");
					Запись.ВидКартинки = 3;
					Запись.Избранный = Ложь;
					Запись.Время = Формат(Срок, "ДФ='HH:mm'") + " - " + Формат(Срок, "ДФ='HH:mm'");
					Запись.НаименованиеАРМ = "МоиДела";
					
					Запись.Заголовок = Строка(тТема);
					
					
					Запись.ТекстОснования = Источник.Содержание;
					
					Запись.Записать(Истина);
				Иначе	
					Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
					
					Запись.ДатаДляСортировки = Источник.ПлановаяДата;;
					Запись.Объект = Ссылка;
					Запись.КрайнийСрок = Источник.ПлановаяДата;;
					тТема 			= Источник.Тема;
					НаКонтроле = Ложь;
					ТекстОписания = "";
					ДатаПолучения = Источник.Дата;
					Запись.Контакт = Источник.СписокУчастников;
					Запись.Пользователь = СтрокаУчастники.Лицо;
					Если Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Завершено или  Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Отменено Тогда
						Запись.ИзмерениеАРМ = "Завершенные";
					Иначе
						Запись.ИзмерениеАРМ = "Входящие";
					КонецЕсли;
					
					Срок = Источник.ПлановаяДата;
					Запись.День = Формат(Срок, "ДЛФ=DD");
					Запись.ВидКартинки = 15;
					Запись.Избранный = Ложь;
					Запись.Время = Формат(Срок, "ДФ='HH:mm'") + " - " + Формат(Срок, "ДФ='HH:mm'");
					Запись.НаименованиеАРМ = "МоиДела";
					
					Запись.Заголовок = Строка(тТема);
					
					
					Запись.ТекстОснования = Источник.Содержание;
					
					Запись.Записать(Истина);
				КонецЕсли;
				
				
			КонецЕсли;	
		КонецЦикла;
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_Взаимодействие") И Ссылка.ВидВзаимодействия.ВидСобытия <> Перечисления.CRM_ВидыСобытий.ЛичнаяВстреча Тогда
		Если Ссылка.ПометкаУдаления Тогда Возврат КонецЕсли;
		
		Если Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Отменено Или Источник.ПометкаУдаления Тогда
			
		Иначе
			Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
			Запись.ДатаДляСортировки = Источник.ПлановаяДата;
			Запись.Объект = Ссылка;
			Контакт = "";
			Если ЗначениеЗаполнено(Источник.Партнер) Тогда
				Контакт = Источник.Партнер.Наименование;
				Запись.Клиент = Источник.Партнер;
			ИначеЕсли ЗначениеЗаполнено(Источник.КонтактноеЛицо) Тогда
				Контакт = Источник.КонтактноеЛицо.Наименование;
				Запись.Контакт = Источник.КонтактноеЛицо;
			ИначеЕсли ЗначениеЗаполнено(Источник.ПотенциальныйКлиент) Тогда
				Контакт = Источник.ПотенциальныйКлиент.Наименование;
				Запись.Клиент = Источник.ПотенциальныйКлиент;
			КонецЕсли;
			Если ЗначениеЗаполнено(Источник.КонтактноеЛицо) Тогда
				Запись.Контакт = Источник.КонтактноеЛицо;
			КонецЕсли;	
			Запись.КрайнийСрок = Источник.ПлановаяДата;
			тТема 			= Источник.Тема;
			ТекстОписания = Строка(Источник.СостояниеИнтереса);
			НаКонтроле = Ложь;
			ДатаПолучения = Дата('00010101');
			// Контакт = "";
			КонтактАдрес = "";
			Запись.Пользователь = Источник.Ответственный;
			Срок = Источник.ПлановаяДата;
			Запись.День = Формат(Срок, "ДЛФ=DD");
			Если ТипЗнч(Источник.ДокументОснование) = Тип("ЗадачаСсылка.ЗадачаИсполнителя") Тогда
				Если Источник.ДокументОснование.CRM_Личная Тогда
					Запись.ВидКартинки = 3;
				Иначе	
					Запись.ВидКартинки = 6;
				КонецЕсли;	
				Если Источник.ДокументОснование.Важность = Перечисления.ВариантыВажностиЗадачи.Высокая Тогда
					Запись.Избранный = Истина;
				Иначе	
					Запись.Избранный = Ложь;
				КонецЕсли;
			Иначе
				Если ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.CRM_Интерес") Тогда
					Запись.Избранный = Источник.ДокументОснование.Избранный;
				КонецЕсли;
				Запись.ВидКартинки = 9;
			КонецЕсли;
			
			Запись.Время = Формат(Срок, "ДФ=HH:mm") + " - " + Формат(Источник.ПлановаяДатаЗавершение, "ДФ='HH:mm'");
			Если Источник.Ответственный = Источник.Автор Тогда
				Запись.ИзмерениеАРМ = "Текущие";
			Иначе
				Запись.ИзмерениеАРМ = "Входящие";
			КонецЕсли;	
			Если Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Завершено Тогда
				Запись.ИзмерениеАРМ = "Завершенные";
				Запись.ДатаДляСортировки =  Источник.ДатаЗавершенияВзаимодействия;
			КонецЕсли;	
			Запись.НаименованиеАРМ = "МоиДела";
			
			Запись.Заголовок = Строка(тТема);
			
			ТекстОписания = ?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "") + ?(ЗначениеЗаполнено(КонтактАдрес),?(ЗначениеЗаполнено(Контакт)," | ", "")+" <" + КонтактАдрес + ">", "")+?(ЗначениеЗаполнено(Контакт) или ЗначениеЗаполнено(КонтактАдрес)," | ", "")+ТекстОписания;
			
			Запись.ТекстОснования = ТекстОписания;
			
			Запись.Записать(Истина);
		КонецЕсли;
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ЗадачаСсылка.ЗадачаИсполнителя") Тогда
		Если Ссылка.ПометкаУдаления Тогда
			Возврат;
		КонецЕсли;
		Если ТипЗнч(Источник.БизнесПроцесс) = Тип("БизнесПроцессСсылка.CRM_БизнесПроцесс") Тогда
			Если ЗначениеЗаполнено(Источник.БизнесПроцесс.Интерес) И (ТипЗнч(Источник.БизнесПроцесс.Интерес) = Тип("ДокументСсылка.CRM_Интерес"))
				И ЗначениеЗаполнено(Источник.CRM_СостояниеИнтереса) И Источник.Исполнитель = Источник.БизнесПроцесс.Интерес.Ответственный Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		Если ТипЗнч(Источник.БизнесПроцесс) = Тип("БизнесПроцессСсылка.Задание") Тогда
			Проверящющий = Источник.БизнесПроцесс.Проверяющий;
		Иначе
			Проверящющий = Неопределено;
		КонецЕсли;
		
		
		Если СтатусЗадачи = Справочники.CRM_СостоянияСобытий.Отменено Тогда
			Возврат;
		КонецЕсли;
		
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = Источник.СрокИсполнения;
		Если Источник.CRM_Личная И НЕ ЗначениеЗаполнено(Источник.СрокИсполнения) Тогда
			Запись.ДатаДляСортировки = Источник.Дата;
		КонецЕсли;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.СрокИсполнения;
		тТема 			= Источник.Наименование;
		НаКонтроле = (Проверящющий = Источник.Автор);
		ДатаПолучения = Дата('00010101');
		Контакт = "";
		Если ЗначениеЗаполнено(Источник.CRM_Партнер) Тогда
			Контакт = Источник.CRM_Партнер.Наименование;
			Запись.Клиент = Источник.CRM_Партнер;
			
		ИначеЕсли ЗначениеЗаполнено(Источник.CRM_КонтактноеЛицо) Тогда
			Контакт = Источник.CRM_КонтактноеЛицо.Наименование;
			Запись.Контакт = Источник.CRM_КонтактноеЛицо;
		КонецЕсли;
		Если ЗначениеЗаполнено(Источник.CRM_КонтактноеЛицо) Тогда
			Запись.Контакт = Источник.CRM_КонтактноеЛицо;
		КонецЕсли;
		КонтактАдрес = "";
		ТекстОписания = "";
		Если ЗначениеЗаполнено(Источник.Исполнитель) Тогда
			Запись.Пользователь = Источник.Исполнитель;
		ИначеЕсли ЗначениеЗаполнено(Источник.РольИсполнителя) Тогда
			Запись.Пользователь = Источник.РольИсполнителя;
		КонецЕсли;
		Срок = Источник.СрокИсполнения;
		Запись.День = Формат(Срок, "ДЛФ=DD");
		Если Источник.CRM_Личная Тогда
			Запись.ВидКартинки = 3;
			ТекстОписания = Источник.Описание;
		Иначе	
			ТекстОписания = Строка(Источник.CRM_ТочкаМаршрута);
			Запись.ВидКартинки = 6;
		КонецЕсли;
		Если Источник.Важность = Перечисления.ВариантыВажностиЗадачи.Высокая Тогда
			Запись.Избранный = Истина;
		Иначе	
			Запись.Избранный = Ложь;
		КонецЕсли;
		Запись.Время = Формат(Источник.СрокИсполнения, "ДФ='HH:mm'") + " - " + Формат(Источник.СрокИсполнения, "ДФ='HH:mm'");
		Если Источник.Выполнена  Тогда
			Запись.ИзмерениеАРМ = "Завершенные";
			Запись.ДатаДляСортировки =  Источник.ДатаИсполнения;
		ИначеЕсли ТипЗнч(Источник) = Тип("ЗадачаОбъект.ЗадачаИсполнителя") 
			И (Источник.ДополнительныеСвойства.Свойство("ПринятаКИсполнениюПередЗаписью") 
			И НЕ Источник.ДополнительныеСвойства.ПринятаКИсполнениюПередЗаписью И Источник.ПринятаКИсполнению) 
			И НЕ Источник.CRM_Личная Тогда
			Запись.ИзмерениеАРМ = "Текущие";
		ИначеЕсли Источник.ПринятаКИсполнению И НЕ Источник.CRM_Личная Тогда
			Запись.ИзмерениеАРМ = "Текущие";
		ИначеЕсли ЗначениеЗаполнено(ТекущееИзмерение) Тогда 
			Запись.ИзмерениеАРМ = ТекущееИзмерение;
		ИначеЕсли Источник.Исполнитель = Источник.Автор Тогда
			Запись.ИзмерениеАРМ = "Текущие";
		Иначе
			Запись.ИзмерениеАРМ = "Входящие";
		КонецЕсли;
		Запись.НаименованиеАРМ = "МоиДела";
		
		Запись.Заголовок = Строка(тТема);
		
		ТекстОписания = ?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "") + ?(ЗначениеЗаполнено(КонтактАдрес),?(ЗначениеЗаполнено(Контакт)," | ", "")+" <" + КонтактАдрес + ">", "")+?(ЗначениеЗаполнено(Контакт) или ЗначениеЗаполнено(КонтактАдрес)," | ", "")+ТекстОписания;
		
		Запись.ТекстОснования = ТекстОписания;
		
		Запись.Записать(Истина);
		
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	CRM_Взаимодействие.Ссылка
		|ИЗ
		|	Документ.CRM_Взаимодействие КАК CRM_Взаимодействие
		|ГДЕ
		|	CRM_Взаимодействие.ДокументОснование = &ДокументОснование";
		Запрос.УстановитьПараметр("ДокументОснование", Ссылка);
		ВыборкаВзаимодействия = Запрос.Выполнить().Выбрать();
		// ЭтоПервыйПроход = Истина;
		Пока ВыборкаВзаимодействия.Следующий() Цикл
			Если ВыборкаВзаимодействия.Ссылка.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Отменено ИЛИ ВыборкаВзаимодействия.Ссылка.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Завершено Тогда
				Продолжить;
			КонецЕсли;	
		//	Если ЭтоПервыйПроход Тогда
		//		ЭтоПервыйПроход = Ложь;
		//		Запись.Удалить();
		//	КонецЕсли;	
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	CRM_ОбъектыАРМ.Объект,
			|	CRM_ОбъектыАРМ.НаименованиеАРМ,
			|	CRM_ОбъектыАРМ.ИзмерениеАРМ,
			|	CRM_ОбъектыАРМ.Пользователь
			|ИЗ
			|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
			|ГДЕ
			|	CRM_ОбъектыАРМ.Объект = &Объект
			|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ";
			Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиДела");
			Запрос.УстановитьПараметр("Объект", ВыборкаВзаимодействия.Ссылка);
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
				Запись.Объект = ВыборкаВзаимодействия.Ссылка;
				Запись.НаименованиеАРМ = "МоиДела";
				Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
				Запись.Пользователь = Выборка.Пользователь;
				Запись.Прочитать();
				Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
			Иначе	
				Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
				Если ВыборкаВзаимодействия.Ссылка.Ответственный = ВыборкаВзаимодействия.Ссылка.Автор Тогда
					Запись.ИзмерениеАРМ = "Текущие";
				Иначе
					Запись.ИзмерениеАРМ = "Входящие";
				КонецЕсли;
			КонецЕсли;
			
			Если ВыборкаВзаимодействия.Ссылка.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Отменено Или Источник.ПометкаУдаления Тогда
				Продолжить;
			КонецЕсли;
			
			Запись.ДатаДляСортировки = ВыборкаВзаимодействия.Ссылка.ПлановаяДата;
			Запись.Объект = ВыборкаВзаимодействия.Ссылка;
			Контакт = "";
			Если ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.Партнер) Тогда
				Контакт = ВыборкаВзаимодействия.Ссылка.Партнер.Наименование;
				Запись.Клиент = ВыборкаВзаимодействия.Ссылка.Партнер;
			ИначеЕсли ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо) Тогда
				Контакт = ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо.Наименование;
				Запись.Контакт = ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо;
			ИначеЕсли ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.ПотенциальныйКлиент) Тогда
				Контакт = ВыборкаВзаимодействия.Ссылка.ПотенциальныйКлиент.Наименование;
				Запись.Клиент = ВыборкаВзаимодействия.Ссылка.ПотенциальныйКлиент;
			КонецЕсли;
			Если ЗначениеЗаполнено(ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо) Тогда
				Запись.Контакт = ВыборкаВзаимодействия.Ссылка.КонтактноеЛицо;
			КонецЕсли;	
			Запись.КрайнийСрок = ВыборкаВзаимодействия.Ссылка.ПлановаяДата;
			тТема 			= ВыборкаВзаимодействия.Ссылка.Тема;
			ТекстОписания = Строка(ВыборкаВзаимодействия.Ссылка.СостояниеИнтереса);
			НаКонтроле = Ложь;
			ДатаПолучения = Дата('00010101');
			// Контакт = "";
			КонтактАдрес = "";
			Запись.Пользователь = ВыборкаВзаимодействия.Ссылка.Ответственный;
			Срок = ВыборкаВзаимодействия.Ссылка.ПлановаяДата;
			Запись.День = Формат(Срок, "ДЛФ=DD");
			Если Источник.CRM_Личная Тогда
				Запись.ВидКартинки = 3;
				ТекстОписания = Источник.Описание;
			Иначе	
				ТекстОписания = Строка(Источник.CRM_ТочкаМаршрута);
				Запись.ВидКартинки = 6;
			КонецЕсли;
			Если Источник.Важность = Перечисления.ВариантыВажностиЗадачи.Высокая Тогда
				Запись.Избранный = Истина;
			Иначе	
				Запись.Избранный = Ложь;
			КонецЕсли;
			
			
			
			Запись.Время = Формат(Срок, "ДФ=HH:mm") + " - " + Формат(ВыборкаВзаимодействия.Ссылка.ПлановаяДатаЗавершение, "ДФ='HH:mm'");
			
			Если ВыборкаВзаимодействия.Ссылка.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Завершено Тогда
				Запись.ИзмерениеАРМ = "Завершенные";
				Запись.ДатаДляСортировки =  ВыборкаВзаимодействия.Ссылка.ДатаЗавершенияВзаимодействия;
			КонецЕсли;
			Запись.НаименованиеАРМ = "МоиДела";
			
			Запись.Заголовок = Строка(тТема);
			
			ТекстОписания = ?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "") + ?(ЗначениеЗаполнено(КонтактАдрес),?(ЗначениеЗаполнено(Контакт)," | ", "")+" <" + КонтактАдрес + ">", "")+?(ЗначениеЗаполнено(Контакт) или ЗначениеЗаполнено(КонтактАдрес)," | ", "")+ТекстОписания;
			
			Запись.ТекстОснования = ТекстОписания;
			
			Запись.Записать(Истина);
			
		КонецЦикла;
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_СообщениеМессенджера") И Источник.ВидСообщения = Перечисления.CRM_ВидыСообщенияМессенджера.Входящее Тогда
		Если Ссылка.CRM_СкрытьВАРМ Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = Источник.Дата;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.Дата;
		тТема 			= ?(ЗначениеЗаполнено(Источник.Тема), Источник.Тема, Источник.ТекстСообщения);
		НаКонтроле = Ложь;
		ДатаПолучения = Источник.Дата;
		Контакт = Источник.Контакт;
		Если ТипЗнч(Контакт) = Тип("СправочникСсылка.КонтактныеЛицаПартнеров") Тогда
			Запись.Клиент = Контакт.Владелец;
			Контакт = Контакт.Владелец;
		КонецЕсли;	
		Запись.Контакт = Источник.Контакт;
		КонтактАдрес = Источник.КонтактПредставление;
		ТекстОписания = "";	
		Если ЗначениеЗаполнено(Источник.CRM_РольОтветственного) Тогда
			Запись.Пользователь = Источник.CRM_РольОтветственного;
		Иначе
			Запись.Пользователь = Источник.Ответственный;
		КонецЕсли;
		Запись.ИзмерениеАРМ = "Входящие";
		Срок = Источник.Дата;
		Запись.День =  Формат(Срок, "ДЛФ=DD");
		Запись.ВидКартинки = 14;
		Запись.Время = Формат(Источник.Дата, "ДФ='HH:mm'") + " - " + Формат(Источник.Дата, "ДФ='HH:mm'");
		Запись.НаименованиеАРМ = "МоиДела";
		
		Запись.Заголовок = Строка(тТема);
		
		ТекстОписания = ?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "") + ?(ЗначениеЗаполнено(КонтактАдрес),?(ЗначениеЗаполнено(Контакт)," | ", "")+" <" + КонтактАдрес + ">", "")+?(ЗначениеЗаполнено(Контакт) или ЗначениеЗаполнено(КонтактАдрес)," | ", "")+ТекстОписания;
		
		Запись.ТекстОснования = ТекстОписания;
		
		Запись.Записать(Истина);
		
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_ЭтапКалендарногоПлана") Тогда
		Если Источник.ПометкаУдаления Тогда Возврат КонецЕсли;
		Если Источник.Статус = Перечисления.CRM_СтатусыЭтаповКалендарногоПлана.Отменена Тогда Возврат КонецЕсли;
		Для каждого Участник из Источник.Участники Цикл
			Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
			Если Источник.Статус = Перечисления.CRM_СтатусыЭтаповКалендарногоПлана.Проверена Тогда
				Запись.ИзмерениеАРМ = "Завершенные";
				Запись.ДатаДляСортировки =  Источник.ФактическаяДатаОкончания;
			ИначеЕсли Источник.Статус = Перечисления.CRM_СтатусыЭтаповКалендарногоПлана.ВРаботе Тогда
				Запись.ИзмерениеАРМ = "Текущие";
				Запись.ДатаДляСортировки = Источник.ФактическаяДатаНачала;
			ИначеЕсли Источник.Статус = Перечисления.CRM_СтатусыЭтаповКалендарногоПлана.Запланирована Тогда
				Запись.ИзмерениеАРМ = "Входящие";
				Запись.ДатаДляСортировки = Источник.ПлановаяДатаНачала;
			КонецЕсли;
			Запись.Объект = Ссылка;
			Запись.КрайнийСрок = Источник.ПлановаяДатаОкончания;
			тТема = Источник.Тема;
			НаКонтроле = Ложь;
			ДатаПолучения = Источник.Дата;
			ТекстОписания = "";	
			Запись.Пользователь = Участник.Пользователь;
			Срок = Источник.ПлановаяДатаОкончания;
			Запись.День =  Формат(Срок, "ДЛФ=DD");
			Если Источник.ТипЭтапа = Перечисления.CRM_ТипыЭтапов.Этап Тогда
				Запись.ВидКартинки = 2;
			Иначе
				Запись.ВидКартинки = 1;
			КонецЕсли;
			Запись.Время = Формат(Запись.ДатаДляСортировки, "ДФ='HH:mm'") + " - " + Формат(Запись.ДатаДляСортировки, "ДФ='HH:mm'");
			Запись.НаименованиеАРМ = "МоиДела";
			
			Запись.Заголовок = Строка(тТема);
			
			Запись.Записать(Истина);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура CRM_ЗаполнениеАРМПриЗаписи(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка И Источник.ДополнительныеСвойства.Свойство("ОтключитьБизнесЛогику") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(Источник) <> Тип("ДокументОбъект.CRM_Заявка") Тогда
		CRM_ЗаполнениеАРММоиДела(Источник, Отказ);
	КонецЕсли;	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_Интерес") ИЛИ ТипЗнч(Источник) = Тип("ДокументОбъект.ЭлектронноеПисьмоВходящее") 
		ИЛИ ТипЗнч(Источник) = Тип("ДокументОбъект.ТелефонныйЗвонок") ИЛИ ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_СообщениеМессенджера") 
		ИЛИ ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_Заявка") Тогда
		CRM_ЗаполнениеАРММоиПродажи(Источник, Отказ);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОчиститьЗаписиБезПользователя(Параметры) Экспорт
	
	НаборЗаписей = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Пользователь.Установить(Справочники.Пользователи.ПустаяСсылка());
	НаборЗаписей.Прочитать();
	НаборЗаписей.Очистить();
	НаборЗаписей.Записать();
	
	НаборЗаписей = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Пользователь.Установить(Неопределено);
	НаборЗаписей.Прочитать();
	НаборЗаписей.Очистить();
	НаборЗаписей.Записать();
	
КонецПроцедуры

Процедура CRM_ЗаполнениеАРММоиПродажи(Источник, Отказ) Экспорт
	
	Ссылка = Источник.ссылка;
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	CRM_ОбъектыАРМ.Объект,
	|	CRM_ОбъектыАРМ.НаименованиеАРМ,
	|	CRM_ОбъектыАРМ.ИзмерениеАРМ,
	|	CRM_ОбъектыАРМ.Пользователь,
	|	CRM_ОбъектыАРМ.СостояниеИнтереса
	|ИЗ
	|	РегистрСведений.CRM_ОбъектыАРМ КАК CRM_ОбъектыАРМ
	|ГДЕ
	|	CRM_ОбъектыАРМ.Объект = &Объект
	|	И CRM_ОбъектыАРМ.НаименованиеАРМ = &НаименованиеАРМ
	|	И CRM_ОбъектыАРМ.ИзмерениеАРМ <> ""Потерян""
	|	И CRM_ОбъектыАРМ.ИзмерениеАРМ <> ""Закрыт""";
	Запрос.УстановитьПараметр("НаименованиеАРМ", "МоиПродажи");
	Запрос.УстановитьПараметр("Объект", Ссылка);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.Объект = Ссылка;
		Запись.НаименованиеАРМ = "МоиПродажи";
		Запись.ИзмерениеАРМ = Выборка.ИзмерениеАРМ;
		Запись.СостояниеИнтереса = Выборка.СостояниеИнтереса;
		Запись.Пользователь = Выборка.Пользователь;
		Запись.Прочитать();
		Если Запись.Объект <> Неопределено Тогда
			Запись.Удалить();
		КонецЕсли;
	КонецЦикла;
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЭлектронноеПисьмоВходящее") Тогда
		Если Ссылка.ПометкаУдаления ИЛИ НЕ РегистрыСведений.CRM_СостоянияЛидов.СсылкаЯвляетсяЛидом(Ссылка) Тогда
			Возврат;
		КонецЕсли;
		Если НЕ РегистрыСведений.CRM_СостоянияЛидов.ЭтоТекущийЛид(Ссылка) И Ссылка.CRM_СкрытьВАРМ Тогда Возврат КонецЕсли;
		МассивПользователей = Новый Массив;
		Если ЗначениеЗаполнено(Источник.CRM_РольОтветственного) Тогда
			МассивПользователей.Добавить(Источник.CRM_РольОтветственного);
		ИначеЕсли ЗначениеЗаполнено(Источник.Ответственный) Тогда
			МассивПользователей.Добавить(Источник.Ответственный);
		ИначеЕсли НЕ Источник.УчетнаяЗапись.CRM_ЭтоОбщаяУчетнаяЗапись Тогда
			Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
			                      |	CRM_УчетныеЗаписиЭлектроннойПочты.Пользователь КАК Пользователь
			                      |ИЗ
			                      |	РегистрСведений.CRM_УчетныеЗаписиЭлектроннойПочты КАК CRM_УчетныеЗаписиЭлектроннойПочты
			                      |ГДЕ
			                      |	CRM_УчетныеЗаписиЭлектроннойПочты.УчетнаяЗапись = &УчетнаяЗапись");
			Запрос.УстановитьПараметр("УчетнаяЗапись", Источник.УчетнаяЗапись);
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				МассивПользователей.Добавить(Выборка.Пользователь);
			КонецЦикла;
		Иначе
			МассивПользователей.Добавить(Справочники.Пользователи.ПустаяСсылка());
		КонецЕсли;
		Для каждого Пользователь из МассивПользователей Цикл
			Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
			Запись.ДатаДляСортировки = Источник.Дата;
			Запись.Объект = Ссылка;
			Запись.КрайнийСрок = Источник.Дата;
			Запись.Пользователь = Пользователь;
			НаКонтроле = Ложь;
			ДатаПолучения = Источник.Дата;
			Контакт = Источник.ОтправительКонтакт;
			КонтактАдрес = Источник.ОтправительАдрес;
			Запись.ИзмерениеАРМ = "НеРазобрано";
			Запись.НаименованиеАРМ = "МоиПродажи";
			Срок = Источник.ДатаПолучения;
			Запись.День =  Формат(Срок, "ДЛФ=DD");
			Запись.Время = Формат(Источник.ДатаПолучения, "ДФ='HH:mm'") + " - " + Формат(Источник.ДатаПолучения, "ДФ='HH:mm'");
			тКрайнийСрок 	= Формат(Запись.КрайнийСрок, "ДФ='d MMM'");
			Текст			= тКрайнийСрок + " | " + Строка(?(ЗначениеЗаполнено(Контакт), Строка(Контакт) + " <" + КонтактАдрес + ">", КонтактАдрес));
			Запись.ТекстОснования = Текст;
			Запись.ВидКартинки = 12;
			Если Источник.Важность = Перечисления.ВариантыВажностиВзаимодействия.Высокая Тогда
				Запись.Избранный = Истина;
			Иначе	
				Запись.Избранный = Ложь;
			КонецЕсли;
			Запись.Заголовок = Источник.Тема;
			Запись.Записать(Истина);
		КонецЦикла;
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_Заявка") Тогда
		ЭтоТекущийЛид = РегистрыСведений.CRM_СостоянияЛидов.ЭтоТекущийЛид(Ссылка);
		Если НЕ ЭтоТекущийЛид И Ссылка.CRM_СкрытьВАРМ Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = Источник.Дата;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.Дата;
		НаКонтроле = Ложь;
		ДатаПолучения = Источник.Дата;
		Контакт = Источник.Наименование;
		КонтактАдрес = Источник.ЭлектроннаяПочта;
		КонтактТелефон = Источник.Телефон;
		Если ЗначениеЗаполнено(Источник.CRM_РольОтветственного) Тогда
			Запись.Пользователь = Источник.CRM_РольОтветственного;
		Иначе
			Запись.Пользователь = Источник.Ответственный;
		КонецЕсли;
		Запись.ИзмерениеАРМ = "НеРазобрано";
		Запись.НаименованиеАРМ = "МоиПродажи";
		Срок = Источник.Дата;
		Запись.День =  Формат(Срок, "ДЛФ=DD");
		Запись.Время = Формат(Источник.Дата, "ДФ='HH:mm'") + " - " + Формат(Источник.Дата, "ДФ='HH:mm'");
		тКрайнийСрок 	= Формат(Запись.КрайнийСрок, "ДФ='d MMM'");
		Текст			= тКрайнийСрок + " | " + Строка(?(ЗначениеЗаполнено(Контакт), Строка(Контакт), "")) + ?(ЗначениеЗаполнено(КонтактТелефон), " <" + КонтактТелефон + ">", "") + ?(ЗначениеЗаполнено(КонтактАдрес), " <" + КонтактАдрес + ">", "");
		Запись.ТекстОснования = Текст;
		Запись.ВидКартинки = 12;
		Запись.Избранный = Ложь;
		Запись.Заголовок = Источник.Тема;
		Запись.Записать(Истина);	
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ТелефонныйЗвонок") Тогда
		Если НЕ Источник.Входящий Тогда Возврат КонецЕсли;
		ЭтоТекущийЛид = РегистрыСведений.CRM_СостоянияЛидов.ЭтоТекущийЛид(Ссылка);
		Если НЕ ЭтоТекущийЛид И Ссылка.CRM_СкрытьВАРМ Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = Источник.Дата;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.Дата;
		НаКонтроле = Ложь;
		ДатаПолучения = Источник.Дата;
		Контакт = Источник.АбонентКонтакт;
		КонтактАдрес = Источник.АбонентКакСвязаться;
		Запись.Пользователь = Источник.Ответственный;
		Запись.ИзмерениеАРМ = "НеРазобрано";
		Запись.НаименованиеАРМ = "МоиПродажи";
		Срок = Источник.Дата;
		Запись.День = Формат(Срок, "ДЛФ=DD");
		Запись.Время = Формат(Срок, "ДФ='HH:mm'") + " - " + Формат(Срок, "ДФ='HH:mm'");
		тКрайнийСрок 	= Формат(Запись.КрайнийСрок, "ДФ='d MMM'");
		Текст			= тКрайнийСрок + " | " + Строка(?(ЗначениеЗаполнено(Контакт), Строка(Контакт) + " <" + КонтактАдрес + ">", КонтактАдрес));
		Запись.ТекстОснования = Текст;
		Запись.Заголовок = Источник.Тема;
		Запись.ВидКартинки = 13;
		Если Источник.Важность = Перечисления.ВариантыВажностиВзаимодействия.Высокая Тогда
			Запись.Избранный = Истина;
		Иначе	
			Запись.Избранный = Ложь;
		КонецЕсли;
		Запись.Записать(Истина);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_Интерес") Тогда
		
		Если Источник.ПометкаУдаления Тогда
			Возврат;
		КонецЕсли;
		ВалютаУправленческогоУчета = Константы.ВалютаУправленческогоУчета.Получить();
		Если ЗначениеЗаполнено(ВалютаУправленческогоУчета) Тогда
			Если ВалютаУправленческогоУчета.Код = "643" Тогда
				// Рубль
				ВалютаПредставление = Символ("8381");
			ИначеЕсли ВалютаУправленческогоУчета.Код = "978" Тогда
				// Евро
				ВалютаПредставление = Символ("8364");
			ИначеЕсли ВалютаУправленческогоУчета.Код = "840" Тогда
				// Доллар
				ВалютаПредставление = Символ("36");
			Иначе
				ВалютаПредставление = ВалютаУправленческогоУчета.Наименование;
			КонецЕсли;
		Иначе
			ВалютаПредставление = "";
		КонецЕсли;
		СтруктураСледующегоДействия	= РегистрыСведений.CRM_ЗапланированныеАктивности.СледующаяЗапланированнаяАктивность(Источник.Ссылка);
		Если СтруктураСледующегоДействия <> Неопределено Тогда
			ДатаСледующегоДействия = СтруктураСледующегоДействия.ПланируемаяДата;
		Иначе
			ДатаСледующегоДействия = Источник.Дата;
		КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = ?(Источник.СостояниеИнтереса.Завершено, Источник.ДатаЗакрытия, ДатаСледующегоДействия);
		Запись.Объект = Ссылка;
		Запись.НаименованиеАРМ = "МоиПродажи";
		Запись.КрайнийСрок = ДатаСледующегоДействия;
		НаКонтроле = Ложь;
		ДатаПолучения = Дата('00010101');
		Запись.СостояниеИнтереса = Источник.СостояниеИнтереса;
		// Запись.ИзмерениеАРМ = ?(Источник.СостояниеИнтереса <> Справочники.CRM_СостоянияИнтересов.ИнтересЗакрыт, ВыборкаВоронка.Этап.Наименование, "Закрыт");;
		Запись.Пользователь = Источник.Ответственный;
		Запись.День = Формат(ДатаСледующегоДействия, "ДЛФ=DD");
		Запись.Время = Формат(ДатаСледующегоДействия, "ДФ=HH:mm") + " - " + Формат(ДатаСледующегоДействия, "ДФ='HH:mm'");
		Запись.ТекстОснования = Источник.Тема;
		Запись.Заголовок = Источник.Тема;
		Запись.ВидКартинки = 9;
		Запись.Избранный = Источник.Избранный;
		КоличествоТегов = Источник.CRM_Теги.Количество();
		Запись.ОписаниеИнтереса	= ?(ЗначениеЗаполнено(ДатаСледующегоДействия), Формат(ДатаСледующегоДействия, "ДФ=dd.MM.yyyy"), "");
		Запись.ОписаниеИнтереса = Запись.ОписаниеИнтереса + ?(ЗначениеЗаполнено(Источник.ОжидаемаяВыручка), ", ", "") + ?(ЗначениеЗаполнено(Источник.ОжидаемаяВыручка), Строка(Источник.ОжидаемаяВыручка) + " " + ВалютаПредставление, "") + ?(КоличествоТегов > 0, ", ", "");
		Для Каждого тТег Из Источник.CRM_Теги Цикл
			Запись.ОписаниеИнтереса 	= Запись.ОписаниеИнтереса + Строка(тТег.Тег) + " | ";
		КонецЦикла;
		Если КоличествоТегов > 0 Тогда
			Запись.ОписаниеИнтереса	= Лев(Запись.ОписаниеИнтереса, СтрДлина(Запись.ОписаниеИнтереса)-3);
		КонецЕсли;
		
		Запись.Записать(Истина);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.CRM_СообщениеМессенджера") И Источник.ВидСообщения = Перечисления.CRM_ВидыСообщенияМессенджера.Входящее Тогда
		Если НЕ РегистрыСведений.CRM_СостоянияЛидов.СсылкаЯвляетсяЛидом(Ссылка) Тогда
			Возврат;
		КонецЕсли;
		Если НЕ РегистрыСведений.CRM_СостоянияЛидов.ЭтоТекущийЛид(Ссылка) И Ссылка.CRM_СкрытьВАРМ Тогда Возврат КонецЕсли;
		Запись = РегистрыСведений.CRM_ОбъектыАРМ.СоздатьМенеджерЗаписи();
		Запись.ДатаДляСортировки = Источник.Дата;
		Запись.Объект = Ссылка;
		Запись.КрайнийСрок = Источник.Дата;
		НаКонтроле = Ложь;
		ДатаПолучения = Источник.Дата;
		Контакт = Источник.Контакт;
		КонтактАдрес = Источник.КонтактПредставление;
		Если ЗначениеЗаполнено(Источник.CRM_РольОтветственного) Тогда
			Запись.Пользователь = Источник.CRM_РольОтветственного;
		Иначе
			Запись.Пользователь = Источник.Ответственный;
		КонецЕсли;
		Запись.ИзмерениеАРМ = "НеРазобрано";
		Запись.НаименованиеАРМ = "МоиПродажи";
		Срок = Источник.Дата;
		Запись.День =  Формат(Срок, "ДЛФ=DD");
		Запись.Время = Формат(Источник.Дата, "ДФ='HH:mm'") + " - " + Формат(Источник.Дата, "ДФ='HH:mm'");
		тКрайнийСрок 	= Формат(Запись.КрайнийСрок, "ДФ='d MMM'");
		Текст			= тКрайнийСрок + " | " + Строка(?(ЗначениеЗаполнено(Контакт), Строка(Контакт) + " <" + КонтактАдрес + ">", КонтактАдрес));
		Запись.ТекстОснования = Текст;
		Запись.ВидКартинки = 14;
		Запись.Заголовок = ?(ЗначениеЗаполнено(Источник.Тема), Источник.Тема, Источник.ТекстСообщения);
		Запись.Записать(Истина);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти