////////////////////////////////////////////////////////////////////////////////
// <Заголовок модуля: краткое описание и условия применения модуля.>
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

//////////////////////////////////////////////////////////////////////////////////////////////////////
// ПОДПИСКИ НА СОБЫТИЯ

// Процедура - обработчик подписки на событие "ПриЗаписи" для объектов, отображаемых в календаре.
//
// Параметры:
//	Источник	- Ссылка	- Источник события.
//	Отказ		- Булево	- Флаг отмены.
//
Процедура ПриЗаписиОбъектаКалендаря(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	// Создадим запись в региср сведений CRM_СостоянияИнтересов, если требуется
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_Взаимодействие") Тогда
		
		//Если Источник.ПометкаУдаления Тогда
		//	НаборЗаписей = РегистрыСведений.CRM_СобытияКалендаря.СоздатьНаборЗаписей();
		//	НаборЗаписей.Отбор.Объект.Установить(Источник.Ссылка);
		//	НаборЗаписей.Записать(Истина);
		//	Возврат;
		//КонецЕсли;
		
		// Обработка создания/перезаполнения напоминаний
		
		Если ЗначениеЗаполнено(Источник.ДокументОснование) И ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.CRM_Интерес") Тогда
			
			// Если взаимодествие новое и по интересу еще нет записей, то просто добавляем
			// новую запись
			Если Источник.ДополнительныеСвойства.Свойство("ЭтоНовый") И Источник.ДополнительныеСвойства.ЭтоНовый Тогда
				
				НаборЗаписей = РегистрыСведений.CRM_СостоянияИнтересов.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.Интерес.Установить(Источник.ДокументОснование);
				НаборЗаписей.Прочитать();
				Если НаборЗаписей.Количество() = 0 Тогда
					
					НаборЗаписей.Отбор.Сбросить();
					
					НоваяЗапись = РегистрыСведений.CRM_СостоянияИнтересов.СоздатьМенеджерЗаписи();
					НоваяЗапись.Интерес			= Источник.ДокументОснование;
					НоваяЗапись.Взаимодействие	= Источник.Ссылка;
					НоваяЗапись.Состояние		= Источник.СостояниеИнтереса;
					НоваяЗапись.Записать();
				КонецЕсли;
			КонецЕсли;
			
			Если Источник.ДополнительныеСвойства.Свойство("ИзмененоСостояниеИнтереса") И Источник.ДополнительныеСвойства.ИзмененоСостояниеИнтереса Тогда
				
				НаборЗаписей = РегистрыСведений.CRM_СостоянияИнтересов.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.Интерес.Установить(Источник.ДокументОснование);
				НаборЗаписей.Прочитать();
				НаборЗаписей.Очистить();
				
				НоваяЗапись = НаборЗаписей.Добавить();
				НоваяЗапись.Интерес			= Источник.ДокументОснование;
				НоваяЗапись.Взаимодействие	= Источник.Ссылка;
				НоваяЗапись.Состояние		= Источник.СостояниеИнтереса;
				
				НаборЗаписей.Записать();
				
			КонецЕсли;
			
			Если Источник.ДополнительныеСвойства.Свойство("ИнтересЗавершен") И Источник.ДополнительныеСвойства.ИнтересЗавершен Тогда
				
				НаборЗаписей = РегистрыСведений.CRM_СостоянияИнтересов.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.Интерес.Установить(Источник.ДокументОснование);
				НаборЗаписей.Прочитать();
				
				Если НаборЗаписей.Количество() > 0 Тогда
					ВзаимодействиеПредыдущегоСостояния	= НаборЗаписей[0].Взаимодействие;
					ПредыдущееСостояние					= НаборЗаписей[0].Состояние;
				Иначе
					ВзаимодействиеПредыдущегоСостояния	= Документы.CRM_Взаимодействие.ПустаяСсылка();
					ПредыдущееСостояние					= Справочники.CRM_СостоянияИнтересов.ПустаяСсылка();
				КонецЕсли;
				
				НаборЗаписей.Очистить();
				
				НоваяЗапись = НаборЗаписей.Добавить();
				НоваяЗапись.Интерес								= Источник.ДокументОснование;
				НоваяЗапись.Взаимодействие						= Источник.Ссылка;
				НоваяЗапись.Состояние							= Источник.СостояниеИнтереса;
				НоваяЗапись.ВзаимодействиеПредыдущегоСостояния	= ВзаимодействиеПредыдущегоСостояния;
				НоваяЗапись.ПредыдущееСостояние					= ПредыдущееСостояние;
				
				НаборЗаписей.Записать();
				
			КонецЕсли;
			
			Если Источник.ДополнительныеСвойства.Свойство("ИнтересОтменаЗавершения") И Источник.ДополнительныеСвойства.ИнтересОтменаЗавершения Тогда
				
				НаборЗаписей = РегистрыСведений.CRM_СостоянияИнтересов.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.Интерес.Установить(Источник.ДокументОснование);
				НаборЗаписей.Прочитать();
				НаборЗаписей.Очистить();
				
				НоваяЗапись = НаборЗаписей.Добавить();
				НоваяЗапись.Интерес			= Источник.ДокументОснование;
				НоваяЗапись.Взаимодействие	= Источник.Ссылка;
				НоваяЗапись.Состояние		= Источник.СостояниеИнтереса;
				
				НаборЗаписей.Записать();
				
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_Взаимодействие") Тогда
		
		Источник.ОтразитьВКалендаре();
		
	ИначеЕсли ТипЗнч(Источник) = Тип("ДокументОбъект.удалитьCRM_Мероприятие") Тогда
		
		НаборЗаписей = РегистрыСведений.CRM_СобытияКалендаря.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Источник.Ссылка);
		
		НаборЗаписей.Записать();
		Возврат;  // убираем записи по мероприятиям, т.к. конвертируем во взаимодействия.
		
	ИначеЕсли ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_ЭтапКалендарногоПлана") Тогда
		НаборЗаписей = РегистрыСведений.CRM_СобытияКалендаря.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Источник.Ссылка);
		
		Если Не Источник.ПометкаУдаления Тогда
			Для Каждого Пользователь Из Источник.Участники Цикл
				НоваяСтрока = НаборЗаписей.Добавить();
				
				НоваяСтрока.ПериодНачало			= НачалоДня(Источник.ПлановаяДатаНачала);
				НоваяСтрока.ПериодОкончание			= КонецДня(Источник.ПлановаяДатаОкончания);
				НоваяСтрока.Пользователь			= Пользователь.Пользователь;
				НоваяСтрока.Объект					= Источник.Ссылка;
				
				НоваяСтрока.Тема					= Источник.Тема;
				НоваяСтрока.НаВесьДень				= Истина;
				НоваяСтрока.СтатусКонтрольнойТочки	= Источник.Статус;
				НоваяСтрока.Важность				= Источник.Важность;
				
				НоваяСтрока.Проект					= Источник.Проект;
				НоваяСтрока.Подразделение			= Источник.Проект.CRM_Подразделение;
				
				НоваяСтрока.Завершено				= (Источник.Статус = Перечисления.CRM_СтатусыЭтаповКалендарногоПлана.Проверена);
			КонецЦикла;
		КонецЕсли;
		
		Если НаборЗаписей.Количество() > 0 Или Источник.ПометкаУдаления Тогда
			НаборЗаписей.Записать();
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_Телемаркетинг") Тогда
		НаборЗаписей = РегистрыСведений.CRM_СобытияКалендаря.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Источник.Ссылка);
		
		бОчиститьЗаписи = Ложь;
		Если Не Источник.ПометкаУдаления И ЗначениеЗаполнено(Источник.Ответственный) Тогда
			Если 	ЗначениеЗаполнено(Источник.ДатаНачала)
				И	ЗначениеЗаполнено(Источник.ДатаОкончания) Тогда
				//
				НачалоПериода	= Источник.ДатаНачала;
				КонецПериода	= Источник.ДатаОкончания;
			ИначеЕсли Источник.НаВесьДень И ЗначениеЗаполнено(Источник.Дата) Тогда
				НачалоПериода	= Источник.Дата;
				КонецПериода	= Источник.Дата;
			Иначе
				бОчиститьЗаписи = Истина;
			КонецЕсли;
			
			Если Не бОчиститьЗаписи Тогда
				НоваяСтрока = НаборЗаписей.Добавить();
				
				НоваяСтрока.ПериодНачало		= НачалоПериода;
				НоваяСтрока.ПериодОкончание		= КонецПериода;
				НоваяСтрока.Пользователь		= Источник.Ответственный;
				НоваяСтрока.Объект				= Источник.Ссылка;
				
				НоваяСтрока.Тема				= Источник.Тема;
				НоваяСтрока.НаВесьДень			= Источник.НаВесьДень;
				
				НоваяСтрока.Важность			= Источник.Важность;
				НоваяСтрока.Подразделение		= Источник.Подразделение;
				НоваяСтрока.Проект				= Источник.Проект;
				
				НоваяСтрока.Завершено			= Источник.Завершен;
				
			КонецЕсли;
			
		Иначе
			бОчиститьЗаписи = Истина;
			
		КонецЕсли;
		
		Если НаборЗаписей.Количество() > 0 Или бОчиститьЗаписи Тогда
			НаборЗаписей.Записать();
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Источник) = Тип("СправочникОбъект.МаркетинговыеМероприятия") Тогда
		НаборЗаписей = РегистрыСведений.CRM_СобытияКалендаря.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Источник.Ссылка);
		
		Если Не Источник.ПометкаУдаления Тогда
			ТаблицаУчастники = Источник.CRM_СвоиУчастники.Выгрузить();
			МассивОбязательныхУчастников = Новый Массив();
			Если ЗначениеЗаполнено(Источник.CRM_Автор) И МассивОбязательныхУчастников.Найти(Источник.CRM_Автор) = Неопределено Тогда
				МассивОбязательныхУчастников.Добавить(Источник.CRM_Автор);
			КонецЕсли;
			Если ЗначениеЗаполнено(Источник.Ответственный) И МассивОбязательныхУчастников.Найти(Источник.Ответственный) = Неопределено Тогда
				МассивОбязательныхУчастников.Добавить(Источник.Ответственный);
			КонецЕсли;
			Для Каждого ОбязательныйУчастник Из МассивОбязательныхУчастников Цикл
				Если ТаблицаУчастники.Найти(ОбязательныйУчастник, "Участник") = Неопределено Тогда
					НовыйУчастник = ТаблицаУчастники.Добавить();
					НовыйУчастник.Участник = ОбязательныйУчастник;
					НовыйУчастник.ДатаНачала = НачалоДня(Источник.ДатаНачала);
					НовыйУчастник.ДатаОкончания = КонецДня(Источник.ДатаОкончания);
					Если Не ЗначениеЗаполнено(НовыйУчастник.ДатаНачала) Тогда
						НовыйУчастник.ДатаНачала = CRM_ОбщегоНазначенияСервер.ПолучитьТекущуюДатуСеанса();
					КонецЕсли;
					Если НовыйУчастник.ДатаОкончания < НовыйУчастник.ДатаНачала Тогда
						НовыйУчастник.ДатаОкончания = НовыйУчастник.ДатаНачала;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
			ТаблицаУчастники.Свернуть("Участник,ДатаНачала,ДатаОкончания");
			Для Каждого СтрокаТаблицы Из ТаблицаУчастники Цикл
				Если Не ЗначениеЗаполнено(СтрокаТаблицы.Участник) Или ТипЗнч(СтрокаТаблицы.Участник) <> Тип("СправочникСсылка.Пользователи") Тогда
					Продолжить;
				КонецЕсли;
				Если Не ЗначениеЗаполнено(СтрокаТаблицы.ДатаНачала) Или Не ЗначениеЗаполнено(СтрокаТаблицы.ДатаОкончания) Тогда
					Продолжить;
				КонецЕсли;
				
				НоваяСтрока = НаборЗаписей.Добавить();
				
				НоваяСтрока.ПериодНачало		= СтрокаТаблицы.ДатаНачала;
				НоваяСтрока.ПериодОкончание		= СтрокаТаблицы.ДатаОкончания;
				НоваяСтрока.Пользователь		= СтрокаТаблицы.Участник;
				НоваяСтрока.Объект				= Источник.Ссылка;
				
				НоваяСтрока.Тема				= Источник.Наименование;
				
				НоваяСтрока.Важность			= Источник.CRM_Важность;
				НоваяСтрока.Подразделение		= Источник.CRM_Подразделение;
				НоваяСтрока.Проект				= Источник.CRM_Проект;
				
				НоваяСтрока.Завершено			= Источник.Завершено;
			КонецЦикла;
		КонецЕсли;
		
		НаборЗаписей.Записать();
		
	КонецЕсли;
	
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБРАБОТКИ ДОКУМЕНТОВ

// Функция - Получить задачу бизнес процесса по интересу
//
// Параметры:
//  Интерес	 - ДокументСсылка - Интерес
// 
// Возвращаемое значение:
//  ЗадачаСсылка - Задача бизнес процесса.
//
Функция ПолучитьЗадачуБПИнтереса(Интерес) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ЗадачаИсполнителя.Ссылка КАК Задача
	                      |ИЗ
	                      |	Задача.ЗадачаИсполнителя КАК ЗадачаИсполнителя
	                      |ГДЕ
	                      |	ЗадачаИсполнителя.БизнесПроцесс.Интерес = &Интерес
	                      |	И НЕ ЗадачаИсполнителя.Выполнена");
	
	Запрос.УстановитьПараметр("Интерес", Интерес);
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Задача;
	Иначе
		Возврат Задачи.ЗадачаИсполнителя.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

// Функция - Получить задачу завершенного интереса
//
// Параметры:
//  Интерес	 - ДокументСсылка - Интерес
// 
// Возвращаемое значение:
//  ЗадачаСсылка - Задача завершенного бизнес процесса.
//
Функция ПолучитьЗадачуЗавершенногоИнтереса(Интерес) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ЗадачаИсполнителя.Ссылка КАК Задача
	                      |ИЗ
	                      |	Задача.ЗадачаИсполнителя КАК ЗадачаИсполнителя
	                      |ГДЕ
	                      |	ЗадачаИсполнителя.БизнесПроцесс.Интерес = &Интерес
	                      |
	                      |УПОРЯДОЧИТЬ ПО
	                      |	ЗадачаИсполнителя.ДатаИсполнения УБЫВ");
	
	Запрос.УстановитьПараметр("Интерес", Интерес);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Задача;
	Иначе
		Возврат Задачи.ЗадачаИсполнителя.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

// Функция возвращает список документов Взаимодействия по переданному в параметре документу Интерес.
//
// Параметры:
//  Документ - ДокументСсылка - Документ интерес.
//  Статус	 - СправочникСсылка	 - Статус взаимодействия.
// 
// Возвращаемое значение:
//  ТаблицаЗначений -  Список документов Взаимодействия.
//
Функция ПолучитьВзаимодействия(Документ, Статус = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	CRM_Взаимодействие.Ссылка,
	|	CRM_Взаимодействие.Дата КАК ДатаСоздания,
	|	CRM_Взаимодействие.Автор,
	|	CRM_Взаимодействие.Партнер,
	|	CRM_Взаимодействие.КонтактноеЛицо,
	|	CRM_Взаимодействие.ПотенциальныйКлиент,
	|	CRM_Взаимодействие.ПлановаяДата,
	|	CRM_Взаимодействие.ВидВзаимодействия,
	|	CRM_Взаимодействие.ОжидаемаяВыручка,
	|	CRM_Взаимодействие.СтатусВзаимодействия,
	|	CRM_Взаимодействие.Тема КАК Содержание,
	|	CRM_Взаимодействие.Результат,
	|	CRM_Взаимодействие.Баллы,
	|	CRM_Взаимодействие.ДатаЗавершенияВзаимодействия,
	|	CRM_Взаимодействие.ЗавершившийПользователь,
	|	CRM_Взаимодействие.СостояниеИнтереса,
	|	CRM_Взаимодействие.НаВесьДень,
	|	CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия КАК ВидСобытия,
	|	CRM_Взаимодействие.ВидВзаимодействия.Направление,
	|	ВЫБОР
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ТелефонныйЗвонок)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Входящее)
	|			ТОГДА 1
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ТелефонныйЗвонок)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Исходящее)
	|			ТОГДА 2
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ЛичнаяВстреча)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Входящее)
	|			ТОГДА 3
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ЛичнаяВстреча)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Исходящее)
	|			ТОГДА 4
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ЭлектронноеПисьмо)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Входящее)
	|			ТОГДА 5
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ЭлектронноеПисьмо)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Исходящее)
	|			ТОГДА 6
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ПочтовоеПисьмо)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Входящее)
	|			ТОГДА 7
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.ПочтовоеПисьмо)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Исходящее)
	|			ТОГДА 8
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.Прочее)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Входящее)
	|			ТОГДА 9
	|		КОГДА CRM_Взаимодействие.ВидВзаимодействия.ВидСобытия = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСобытий.Прочее)
	|				И CRM_Взаимодействие.ВидВзаимодействия.Направление = ЗНАЧЕНИЕ(Перечисление.CRM_ВходящееИсходящееСобытие.Исходящее)
	|			ТОГДА 10
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ВидСобытияКартинка,
	|	CRM_Взаимодействие.Подразделение,
	|	ВЫБОР
	|		КОГДА ДокументыВзаимодействия.КоличествоДокументов ЕСТЬ NULL
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЕстьДокументы,
	|	CRM_Взаимодействие.Задача.Выполнена КАК ЗадачаВыполнена,
	|	CRM_Взаимодействие.Задача,
	|	CRM_Взаимодействие.Задача.CRM_ТочкаМаршрута КАК Этап,
	|	CRM_Взаимодействие.ПлановаяДатаЗавершение,
	|	ВЫБОР
	|		КОГДА CRM_Взаимодействие.Задача.Выполнена
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА CRM_Взаимодействие.Задача.СрокИсполнения < &ТекущаяДата
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ
	|	КОНЕЦ КАК ЗадачаПросрочена
	|ИЗ
	|	Документ.CRM_Взаимодействие КАК CRM_Взаимодействие
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			CRM_ДокументыВзаимодействия.Взаимодействие КАК Взаимодействие,
	|			СУММА(1) КАК КоличествоДокументов
	|		ИЗ
	|			РегистрСведений.CRM_ДокументыВзаимодействия КАК CRM_ДокументыВзаимодействия
	|		
	|		СГРУППИРОВАТЬ ПО
	|			CRM_ДокументыВзаимодействия.Взаимодействие) КАК ДокументыВзаимодействия
	|		ПО CRM_Взаимодействие.Ссылка = ДокументыВзаимодействия.Взаимодействие
	|ГДЕ
	|	CRM_Взаимодействие.ПометкаУдаления = ЛОЖЬ
	|	И CRM_Взаимодействие.ДокументОснование = &ДокументОснование
	|	И CRM_Взаимодействие.СтатусВзаимодействия = &СтатусВзаимодействия
	|
	|УПОРЯДОЧИТЬ ПО
	|	CRM_Взаимодействие.ПлановаяДата УБЫВ";
	Запрос.УстановитьПараметр("ТекущаяДата", НачалоДня(CRM_ОбщегоНазначенияСервер.ПолучитьТекущуюДатуСеанса()));
	Запрос.УстановитьПараметр("Интерес", Документ);
	Запрос.УстановитьПараметр("ДокументОснование", Документ);
	Если Статус = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И CRM_Взаимодействие.СтатусВзаимодействия = &СтатусВзаимодействия", "");
	Иначе
		Если ТипЗнч(Статус) = Тип("Массив") Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "И CRM_Взаимодействие.СтатусВзаимодействия = &СтатусВзаимодействия", "И CRM_Взаимодействие.СтатусВзаимодействия В (&СтатусВзаимодействия)");
		КонецЕсли;	
		Запрос.УстановитьПараметр("СтатусВзаимодействия", Статус);
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	Результат = Запрос.Выполнить().Выгрузить();
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат Результат;
	
КонецФункции

// Процедура удаляет событие из календаря пользователя.
//
// Параметры:
//  Объект		 - ДокументСсылка - Событие, которое необходимо удалить из календаря пользователя.
//  Пользователь - СправочникСсылка.Пользователи - пользователь, из календаря которого удаляется событие.
//
Процедура УдалитьСобытиеИзКалендаря(Объект, Пользователь = Неопределено) Экспорт
	
	НаборРегистра = РегистрыСведений.CRM_СобытияКалендаря.СоздатьНаборЗаписей();
	НаборРегистра.Отбор.Объект.Установить(Объект);
	Если НЕ Пользователь = Неопределено Тогда
		НаборРегистра.Отбор.Пользователь.Установить(Пользователь);
	КонецЕсли;
	НаборРегистра.Прочитать();
	Если НаборРегистра.Количество() > 0 Тогда
		НаборРегистра.Очистить();
		НаборРегистра.Записать();
	КонецЕсли;
	
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ФОРМИРОВАНИЯ СПИСКА ДОКУМЕНТОВ ВЗАИМОДЕЙСТВИЯ

// Процедура добавляет документ в регистр документов взаимодействия.
//
// Параметры:
//	Взаимодействие	- ДокументСсылка	- Взаимодействие.
//	Документ		- ДокументСсылка	- Добавляемый документ.
//
Процедура ДобавитьДокументВРегистр(Взаимодействие, Документ) Экспорт
	Если НЕ ЗначениеЗаполнено(Взаимодействие) Тогда
		Возврат;
	ИначеЕсли НЕ ЗначениеЗаполнено(Документ) Тогда
		Возврат;
	КонецЕсли;		
	НаборЗаписей	= РегистрыСведений.CRM_ДокументыВзаимодействия.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Взаимодействие.Установить(Взаимодействие);
	НаборЗаписей.Отбор.Документ.Установить(Документ);
	НаборЗаписей.Прочитать();
	НаборЗаписей.Очистить();
	НоваяЗапись					= НаборЗаписей.Добавить();
	НоваяЗапись.Взаимодействие	= Взаимодействие;
	НоваяЗапись.Документ	= Документ;
	Попытка
		НаборЗаписей.Записать(Истина);	
	Исключение	
	КонецПопытки;	
КонецПроцедуры // ДобавитьДокументВРегистр()

// Функция возвращает записи звонка.
//
// Параметры:
//	Звонок	- ДокументСсылка	- Звонок.
//
// Возвращаемое значение:
//	Массив	- Массив записей звонка.
//
Функция ПолучитьМассивЗаписейЗвонка(Звонок) Экспорт
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Звонок", Звонок);
	Запрос.Текст = "ВЫБРАТЬ
	               |	РегистрСведенийсфпИсторияЗвонков.ИдентификаторЗаписи
	               |ИЗ
	               |	РегистрСведений.сфпИсторияЗвонков КАК РегистрСведенийсфпИсторияЗвонков
	               |ГДЕ
	               |	РегистрСведенийсфпИсторияЗвонков.Звонок = &Звонок";
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ИдентификаторЗаписи");
КонецФункции // ПолучитьМассивЗаписейЗвонка()

// Функция возвращает вложения письма.
//
// Параметры:
//	Письмо	- ДокументСсылка	- Письмо.
//
// Возвращаемое значение:
//	Массив	- Массив вложений письма.
//
Функция ПолучитьМассивВложенийПисьма(Письмо) Экспорт
	ТаблицаВложений	= CRM_УправлениеЭлектроннойПочтой.ПолучитьВложенияЭлектронногоПисьма(Письмо, Истина);
	МассивВложений	= Новый Массив;
	Для Каждого СтрокаТаблицы Из ТаблицаВложений Цикл
		Если ПустаяСтрока(СтрокаТаблицы.ИДФайлаЭлектронногоПисьма) Тогда
			МассивВложений.Добавить(СтрокаТаблицы.Ссылка);
		КонецЕсли;	
	КонецЦикла;	
	Возврат МассивВложений;
КонецФункции // ПолучитьМассивВложенийПисьма()

// Функция возвращает ссылку на документ по строке навигационной ссылки.
//
// Параметры:
//  СтрокаСсылки - Строка - Строка навигационной ссылки.
// 
// Возвращаемое значение:
//  ДокументСсылка - Ссылка на документ.
//
Функция ПолучитьСсылкуНаДокумент(СтрокаСсылки) Экспорт
	ПозицияСсылки		= Найти(СтрокаСсылки, "?ref=");
	ПредставлениеТипа	= Сред(СтрокаСсылки, 21, ПозицияСсылки - 21);
	СтрокаGUID			= Сред(СтрокаСсылки, ПозицияСсылки + 5);
	НовыйGUID			= Новый УникальныйИдентификатор(Сред(СтрокаGUID, 25) + "-" + Сред(СтрокаGUID, 21, 4) + "-" 
		+ Сред(СтрокаGUID, 17, 4) + "-" + Лев(СтрокаGUID, 4) + "-" + Сред(СтрокаGUID, 5, 12));
	Возврат Документы[ПредставлениеТипа].ПолучитьСсылку(НовыйGUID);
КонецФункции // ПолучитьСсылкуНаДокумент()

// Функция возвращает HTML-текст списка документов взаимодействия.
//
// Параметры:
//	Взаимодействие	- ДокументСсылка	- Взаимодействие.
//
// Возвращаемое значение:
//	Строка	- Текст HTML-документа.
//
Функция СписокДокументовВзаимодействия(Взаимодействие) Экспорт
	АдресЖурналРегистрации	= ПоместитьВоВременноеХранилище(БиблиотекаКартинок.ЖурналРегистрации.ПолучитьДвоичныеДанные());
	АдресТелефонныйЗвонок	= ПоместитьВоВременноеХранилище(БиблиотекаКартинок.CRM_ТелефонныйЗвонок.ПолучитьДвоичныеДанные());
	АдресЭлектронноеПисьмо	= ПоместитьВоВременноеХранилище(БиблиотекаКартинок.CRM_ОтветитьНаЭлектронноеПисьмо.ПолучитьДвоичныеДанные());
	АдресВложенияВПисьмо	= ПоместитьВоВременноеХранилище(БиблиотекаКартинок.CRM_ВложенияВПисьмо.ПолучитьДвоичныеДанные());
	ИспользоватьСофтФон		= сфпСофтФонПроСервер.сфпИспользоватьСофтФон() И сфпСофтФонПроСервер.сфпПолучитьЗначениеНастройкиПользователя("сфпИспользоватьСофтФон");
	ИспользоватьЗапись		= сфпСофтФонПроСервер.сфпИспользоватьЗаписьПереговоров();
	ИспользоватьПочту		= ПолучитьИспользованиеПочты();
	Описание =
		"<html>
		|<head>
		|<meta http-equiv=Content-Type content=""text/html; charset=utf-8"">
		|<title></title>
		|<style>
		|a img {border: none;}
		|h6 { 
		| color: #FF0000;
		|}
		|</style>
		|</head>
		|<body>
		|<p style=""font-family: arial; font-size: 14px; color: #FF0000"">%ТекстПоЗадаче%</p>
		|<table width=""100%"" cellspacing=""9"">";
	ТекстПоЗадаче = "";
	Если ТипЗнч(Взаимодействие) = Тип("ДокументСсылка.CRM_Взаимодействие") И ЗначениеЗаполнено(Взаимодействие.Задача) И НЕ Взаимодействие.Задача.Выполнена Тогда
		ТекстПоЗадаче = ПолучитьТекстОПросрочке(Взаимодействие.Задача, Взаимодействие.СостояниеИнтереса);
	КонецЕсли;
	Описание = СтрЗаменить(Описание,"%ТекстПоЗадаче%",ТекстПоЗадаче);
	
	ДатаВывода	= Дата('00010101');
	МассивДокументовВзаимодействия	= ПолучитьМассивДокументовВзаимодействия(Взаимодействие);
	Для Каждого ДокументМассива Из МассивДокументовВзаимодействия Цикл
		НавигационнаяСсылка	= ПолучитьНавигационнуюСсылку(ДокументМассива);
		Если НЕ (ДатаВывода = НачалоДня(ДокументМассива.Дата)) Тогда
			ДатаВывода	= НачалоДня(ДокументМассива.Дата);
			Описание = Описание + "
				|<tr>
				|<td colspan=""4"" width=""100%""><span style=""font-family: arial; font-size: 14px"">"
				+ Формат(ДатаВывода, "ДФ='d MMMM'; ДЛФ=DD") + ", " + ПолучитьПредставлениеДняНедели(ДатаВывода) + ":</span></td>
				|</tr>";
			КонецЕсли;
		Если  ТипЗнч(ДокументМассива) = Тип("ДокументСсылка.СообщениеSMS") Тогда	
			Описание = Описание + "
				|<tr>
				|<td width=18pt></td>
				|<td width=""90%""><span style=""font-family: arial; font-size: 14px; color: #0000ff"">"
				+ "<a href=" + НавигационнаяСсылка +  ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ=H:mm; ДЛФ=T")
				+ " SMS (" + Строка(ДокументМассива.Состояние) + ") " + ДокументМассива.ТекстСообщения + "</a></span></td>
				|</tr>";
		ИначеЕсли  ТипЗнч(ДокументМассива) = Тип("ДокументСсылка.CRM_СообщениеМессенджера") Тогда	
			Описание = Описание + "
				|<tr>
				|<td width=18pt></td>
				|<td width=""90%""><span style=""font-family: arial; font-size: 14px; color: #0000ff"">"
				+ "<a href=" + НавигационнаяСсылка +  ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ=H:mm; ДЛФ=T")
				+ " Диалоги (" + ДокументМассива.КонтактПредставление + ") " + ДокументМассива.ТекстСообщения + "</a></span></td>
				|</tr>";
		ИначеЕсли  ТипЗнч(ДокументМассива) = Тип("ДокументСсылка.удалитьCRM_Мероприятие") Тогда	
			Описание = Описание + "
				|<tr>
				|<td width=18pt></td>
				|<td width=""90%""><span style=""font-family: arial; font-size: 14px; color: #0000ff"">";
			Если НачалоДня(ДокументМассива.Дата) = НачалоДня(ДокументМассива.ОкончаниеМероприятия) Тогда
				Описание = Описание + "<a href=" + НавигационнаяСсылка + ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ=H:mm; ДЛФ=T");
			Иначе
				Описание = Описание + "<a href=" + НавигационнаяСсылка + ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ='dd.MM H:mm'; ДЛФ=DT")
					+ " - " + Формат(ДокументМассива.ОкончаниеМероприятия, "ДФ='dd.MM H:mm'; ДЛФ=DT");
			КонецЕсли;	
			Описание = Описание + " Мероприятие " + ДокументМассива.Тема;
			Если НЕ ПустаяСтрока(ДокументМассива.Место) Тогда
				Описание = Описание + " [" + ДокументМассива.Место + "]";
			КонецЕсли;	
			Описание = Описание + "</a></span></td>
				|</tr>";
		ИначеЕсли ТипЗнч(ДокументМассива) = Тип("ДокументСсылка.ТелефонныйЗвонок") Тогда
			Если ИспользоватьЗапись Тогда
				КоличествоЗаписей	= ПолучитьМассивЗаписейЗвонка(ДокументМассива).Количество();
			Иначе
				КоличествоЗаписей	= 0;
			КонецЕсли;	
			Описание = Описание + "
				|<tr>
				|<td width=18pt></td>
				|<td width=""90%""><span style=""font-family: arial; font-size: 14px; color: #0000ff"">"
				+ "<a href=" + НавигационнаяСсылка + ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ=H:mm; ДЛФ=T");
			Если ДокументМассива.Входящий Тогда
				Описание = Описание + " Звонок (вх) [";
			Иначе	
				Описание = Описание + " Звонок (исх) [";
			КонецЕсли;
			Описание = Описание + Строка(ДокументМассива.сфпДлительностьЗвонка) + " сек] - " + Строка(ДокументМассива.Автор) + "</a></span></td>";
			Если ИспользоватьСофтФон Тогда
				Описание = Описание + "
					|<td width=6pt><a href=" + НавигационнаяСсылка + ":ПозвонитьНаНомер><img src=""" + АдресТелефонныйЗвонок + """ width=""24"" height=""24""></a></td>";
				Если КоличествоЗаписей = 1 Тогда
					Описание = Описание + "
						|<td width=6pt><a href=" + НавигационнаяСсылка + ":ПрослушатьЗапись><img src=""" + АдресЖурналРегистрации + """ width=""24"" height=""24""></a></td>";
				ИначеЕсли КоличествоЗаписей > 1 Тогда
					Описание = Описание + "
						|<td width=6pt><a href=" + НавигационнаяСсылка + ":ПрослушатьЗаписи><img src=""" + АдресЖурналРегистрации + """ width=""24"" height=""24""></a></td>";
				Иначе
					Описание = Описание + "
						|<td width=6pt></td>";
				КонецЕсли;
			Иначе
				Описание = Описание + "
					|<td width=6pt></td>
					|<td width=6pt></td>";
			КонецЕсли;
			Описание = Описание + "
				|</tr>";
		ИначеЕсли ТипЗнч(ДокументМассива) = Тип("ДокументСсылка.ЭлектронноеПисьмоИсходящее") Тогда
			МассивВложений		= ПолучитьМассивВложенийПисьма(ДокументМассива);
			КоличествоВложений	= МассивВложений.Количество();
			Описание = Описание + "
				|<tr>
				|<td width=18pt></td>
				|<td width=""90%""><span style=""font-family: arial; font-size: 14px; color: #0000ff"">"
				+ "<a href=" + НавигационнаяСсылка + ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ=H:mm; ДЛФ=T")
				+ " Email (исх) ";
			Если ДокументМассива.ПолучателиПисьма.Количество() > 0 Тогда
				Описание = Описание + "[" + ДокументМассива.ПолучателиПисьма[0].Адрес + "]"; 
			КонецЕсли;
			Описание = Описание + "- " + ДокументМассива.Тема + "</a></span></td>";
			Если ИспользоватьПочту Тогда
				// Ответ на исходящее письмо сейчас не используется
				//Описание = Описание + "
				//	|<td width=6pt><a href=" + НавигационнаяСсылка + ":ОтветитьНаПисьмо><img src=""" + АдресЭлектронноеПисьмо + """></a></td>";
				Если КоличествоВложений = 1 Тогда 				
					Описание = Описание + "
						|<td width=6pt><a href=" + НавигационнаяСсылка + ":ОткрытьВложение><img src=""" + АдресВложенияВПисьмо + """></a></td>";
				ИначеЕсли КоличествоВложений > 1 Тогда 				
					Описание = Описание + "
						|<td width=6pt><a href=" + НавигационнаяСсылка + ":ОткрытьВложения><img src=""" + АдресВложенияВПисьмо + """></a></td>";
				Иначе
					Описание = Описание + "
						|<td width=6pt></td>";
				КонецЕсли;				
			Иначе
				Описание = Описание + "
					|<td width=6pt></td>
					|<td width=6pt></td>";
			КонецЕсли;				
			Описание = Описание + "
				|</tr>";
		ИначеЕсли ТипЗнч(ДокументМассива) = Тип("ДокументСсылка.CRM_РассылкаЭлектронныхПисем") Тогда
			Описание = Описание + "
				|<tr>
				|<td width=18pt></td>
				|<td width=""90%""><span style=""font-family: arial; font-size: 14px; color: #0000ff"">";
				
			Описание = Описание + "<a href=" + НавигационнаяСсылка + ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ=H:mm; ДЛФ=T");
			Описание = Описание + " Рассылка электронных писем ";
			Описание = Описание + "</a></span></td>
				|</tr>";
		ИначеЕсли ТипЗнч(ДокументМассива) = Тип("ДокументСсылка.КоммерческоеПредложениеКлиенту") Тогда
			Описание = Описание + "
				|<tr>
				|<td width=18pt></td>
				|<td width=""90%""><span style=""font-family: arial; font-size: 14px; color: #0000ff"">";
				
			Описание = Описание + "<a href=" + НавигационнаяСсылка + ":Открыть>" + Формат(ДокументМассива.Дата, "ДФ=H:mm; ДЛФ=T");
			Описание = Описание + " Коммерческое предложение ";
			Описание = Описание + "</a></span></td>
				|</tr>";
		КонецЕсли;
	КонецЦикла;		
	Описание = Описание + "
		|</table>
		|</body>
		|</html>";
	Возврат Описание;
КонецФункции // СписокДокументовВзаимодействия()

// Проверяет, является ли переданная ссылка предметом взаимодействий.
//
// Параметры:
//  ОбъектСсылка - Ссылка - ссылка, для которой выполняется проверка,
//                          является ли она ссылкой на предмет взаимодействий.
//
// Возвращаемое значение:
//   Булево   - Истина если является, Ложь в обратном случае.
//
Функция ЯвляетсяПредметом(ОбъектСсылка) Экспорт
	
	Возврат Метаданные.ОпределяемыеТипы.ПредметВзаимодействия.Тип.СодержитТип(ТипЗнч(ОбъектСсылка));
	
КонецФункции 

// Функция - Получить основной вид взаимодействия
//
// Параметры:
//  ВернутьВстречу	 - Булево - Вернуть вид взаимодействия "Встреча".
// 
// Возвращаемое значение:
//  СправочникСсылка - Ссылка на вид взаимодействия.
//
Функция ПолучитьОсновнойВидВзаимодействия(ВернутьВстречу = Ложь) Экспорт
	
	Если ВернутьВстречу Тогда
		Возврат Справочники.CRM_ВидыВзаимодействий.Встреча;
	Иначе	
		Возврат Константы.CRM_ВидВзаимодействияПоУмолчанию.Получить();
	КонецЕсли;	
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ПриЗаписиПланируемойАктивности(Источник, Отказ) Экспорт
	
	Если Источник.ОбменДанными.Загрузка И Источник.ДополнительныеСвойства.Свойство("ОтключитьБизнесЛогику") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.CRM_Взаимодействие") Тогда
		Если ЗначениеЗаполнено(Источник.ДокументОснование) И ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.CRM_Интерес") Тогда
			НаборЗаписей = РегистрыСведений.CRM_ЗапланированныеАктивности.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Объект.Установить(Источник.ДокументОснование);
			НаборЗаписей.Отбор.ПланируемаяАктивность.Установить(Источник.Ссылка);
			НаборЗаписей.Прочитать();
			НаборЗаписей.Очистить();
			Если Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.ВРаботе 
				ИЛИ Источник.СтатусВзаимодействия = Справочники.CRM_СостоянияСобытий.Запланировано
				И НЕ Источник.ПометкаУдаления Тогда
				
				Запись = НаборЗаписей.Добавить();
				Запись.Объект = Источник.ДокументОснование;
				Запись.Ответственный = Источник.Ответственный;
				Запись.ПланируемаяАктивность = Источник.Ссылка;
				Запись.ТипАктивности = Перечисления.CRM_ТипыАктивности.Взаимодействие;
				Запись.ПланируемаяДата = Источник.ПлановаяДата;
				Запись.Тема = Источник.Тема;
			КонецЕсли;
			НаборЗаписей.Записать(Истина);
			CRM_РаботаАРМСервер.CRM_ЗаполнениеАРММоиПродажи(Источник.ДокументОснование, Отказ);
			Если ЗначениеЗаполнено(Источник.ДокументОснование) Тогда
				CRM_ВоронкиПродажСервер.ПриЗаписиОбъектаВоронкиПродаж(Источник.ДокументОснование.ПолучитьОбъект(), Отказ);
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ТипЗнч(Источник) = Тип("ЗадачаОбъект.ЗадачаИсполнителя") Тогда
		Если (ЗначениеЗаполнено(Источник.CRM_Личная) И ЗначениеЗаполнено(Источник.Предмет) И ТипЗнч(Источник.Предмет) = Тип("ДокументСсылка.CRM_Интерес"))
			ИЛИ (ЗначениеЗаполнено(Источник.БизнесПроцесс) И ТипЗнч(Источник.БизнесПроцесс.Предмет) = Тип("ДокументСсылка.CRM_Интерес")
				И НЕ ЗначениеЗаполнено(Источник.БизнесПроцесс.Интерес)) Тогда
				
			НаборЗаписей = РегистрыСведений.CRM_ЗапланированныеАктивности.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Объект.Установить(?(Источник.CRM_Личная, Источник.Предмет, Источник.БизнесПроцесс.Предмет));
			НаборЗаписей.Отбор.ПланируемаяАктивность.Установить(Источник.Ссылка);
			НаборЗаписей.Прочитать();
			НаборЗаписей.Очистить();
			Если НЕ Источник.Выполнена И НЕ Источник.ПометкаУдаления Тогда
				Запись = НаборЗаписей.Добавить();
				Запись.Объект = НаборЗаписей.Отбор.Объект.Значение;
				Запись.Ответственный = Источник.Исполнитель;
				Запись.ПланируемаяАктивность = Источник.Ссылка;
				Запись.ТипАктивности = Перечисления.CRM_ТипыАктивности.Задача;
				Запись.ПланируемаяДата = Источник.СрокИсполнения;
				Запись.Тема = Источник.Наименование;
			КонецЕсли;
			НаборЗаписей.Записать(Истина);
			CRM_РаботаАРМСервер.CRM_ЗаполнениеАРММоиПродажи(Источник.Предмет, Отказ);
			CRM_ВоронкиПродажСервер.ПриЗаписиОбъектаВоронкиПродаж(Источник.Предмет.ПолучитьОбъект(), Отказ);
		КонецЕсли;
	КонецЕсли;
		
КонецПроцедуры

// Функция определяет возможность планирования взаимодействия.
//
// Параметры:
//	  Дата         - Дата, дата, для которой проверяется возможность планирования.
//	  Пользователь - СправочникСсылка.Пользователи, пользователь, для которого производится проверка возможности
//	                 планирования.
//	  Клиент       - СправочникСсылка.Партнеры, клиент, по важности которого определяется возможность планирования.
//	  ТипУслуги      - СправочникСсылка.CRM_ТипУслуги, тип услуги, для которой определяется возможность планирования.
//
// Возвращаемое значение:
//    Структура    - МожноПланировать, Булево, результат проверки возможности планирования
//                   ДатаПланирования, Дата, крайняя дата, до которой (включая) можно планировать взаимодействие.
//
Функция ПроверитьВозможностьПланирования(Дата, Пользователь, Клиент, ТипУслуги = Неопределено) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("КомпанияОфис",	Пользователь.Подразделение.CRM_Офис);
	Запрос.УстановитьПараметр("ТипУслуги",		ТипУслуги);
	Если ТипЗнч(Клиент) = Тип("СправочникСсылка.CRM_ПотенциальныеКлиенты") Тогда
		Запрос.УстановитьПараметр("Важность",	Справочники.CRM_ВажностьКлиентов.ПустаяСсылка());
	Иначе
		Запрос.УстановитьПараметр("Важность",	Клиент.CRM_Важность);
	КонецЕсли;	
	Запрос.Текст = "ВЫБРАТЬ
	               |	CRM_ГоризонтПланированияВзаимодействий.КомпанияОфис,
	               |	CRM_ГоризонтПланированияВзаимодействий.Дней,
	               |	1 КАК Сортировка
	               |ИЗ
	               |	РегистрСведений.CRM_ГоризонтПланированияВзаимодействий КАК CRM_ГоризонтПланированияВзаимодействий
	               |ГДЕ
	               |	CRM_ГоризонтПланированияВзаимодействий.КомпанияОфис = &КомпанияОфис
	               |	И CRM_ГоризонтПланированияВзаимодействий.ТипУслуги = &ТипУслуги
	               |	И CRM_ГоризонтПланированияВзаимодействий.Важность = &Важность
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	CRM_ГоризонтПланированияВзаимодействий.КомпанияОфис,
	               |	CRM_ГоризонтПланированияВзаимодействий.Дней,
	               |	2
	               |ИЗ
	               |	РегистрСведений.CRM_ГоризонтПланированияВзаимодействий КАК CRM_ГоризонтПланированияВзаимодействий
	               |ГДЕ
	               |	CRM_ГоризонтПланированияВзаимодействий.Важность = &Важность
	               |	И CRM_ГоризонтПланированияВзаимодействий.ТипУслуги = ЗНАЧЕНИЕ(Справочник.CRM_ТипУслуги.ПустаяСсылка)
	               |	И CRM_ГоризонтПланированияВзаимодействий.КомпанияОфис = &КомпанияОфис
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Сортировка";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	СтруктураРезультата = Новый Структура("МожноПланировать", Истина);
	Если Выборка.Следующий() Тогда
		Дней = Выборка.Дней;
		ДатаПланирования = НачалоДня(ТекущаяДатаСеанса()) + Дней * 86400;
		Если НачалоДня(Дата) > ДатаПланирования Тогда
			СтруктураРезультата.МожноПланировать = Ложь;
			СтруктураРезультата.Вставить("ДатаПланирования", ДатаПланирования);
		КонецЕсли;
	КонецЕсли;
	
	Возврат СтруктураРезультата;
	
КонецФункции

// Функция ищет первое или последнее взаимодействие в Интересе.
Функция ПервоеИлиПоследнееВзаимодействиеВИнтересе(Интерес, Последнее = Ложь) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	CRM_Взаимодействие.Ссылка
	|ИЗ
	|	Документ.CRM_Взаимодействие КАК CRM_Взаимодействие
	|ГДЕ
	|	CRM_Взаимодействие.ДокументОснование = &ДокументОснование
	|	И CRM_Взаимодействие.ПометкаУдаления = ЛОЖЬ
	|
	|УПОРЯДОЧИТЬ ПО
	|	CRM_Взаимодействие.ПлановаяДата,
	|	CRM_Взаимодействие.Дата";
	
	Запрос.УстановитьПараметр("ДокументОснование", Интерес);
	
	Если Последнее Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "CRM_Взаимодействие.Дата", "CRM_Взаимодействие.Дата УБЫВ");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "CRM_Взаимодействие.ПлановаяДата", "CRM_Взаимодействие.ПлановаяДата УБЫВ");		
	КонецЕсли;		
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если  ВыборкаДетальныеЗаписи.Следующий() Тогда
		Возврат ВыборкаДетальныеЗаписи.Ссылка;
	Иначе
		Возврат Документы.CRM_Взаимодействие.ПустаяСсылка();
	КонецЕсли;

КонецФункции 

// Функция возвращает представление дня недели.
//
// Параметры:
//	День	- Дата	- Дата.
//
// Возвращаемое значение:
//	Строка	- Представление дня недели.
//
Функция ПолучитьПредставлениеДняНедели(День)
	НомерДняНедели = ДеньНедели(День);
	Если НомерДняНедели = 1 Тогда
		Результат = "Пн";
	ИначеЕсли НомерДняНедели = 2 Тогда
		Результат = "Вт";
	ИначеЕсли НомерДняНедели = 3 Тогда
		Результат = "Ср";
	ИначеЕсли НомерДняНедели = 4 Тогда
		Результат = "Чт";
	ИначеЕсли НомерДняНедели = 5 Тогда
		Результат = "Пт";
	ИначеЕсли НомерДняНедели = 6 Тогда
		Результат = "Сб";
	ИначеЕсли НомерДняНедели = 7 Тогда
		Результат = "Вс";
	Иначе
		// Непонятно, что это такое. Пусть будет воскресенье.
		Результат = "Вс";
	КонецЕсли;
	Возврат Результат;
КонецФункции // ПолучитьПредставлениеДняНедели()

// Функция возвращает массив документов взаимодействия.
//
// Параметры:
//	Взаимодействие	- ДокументСсылка	- Взаимодействие.
//
// Возвращаемое значение:
//	Массив	- Массив документов.
//
Функция ПолучитьМассивДокументовВзаимодействия(Взаимодействие) Экспорт
	МассивДокументов	= Новый Массив;
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Взаимодействие", Взаимодействие);
	Запрос.Текст = "ВЫБРАТЬ
	               |	CRM_ДокументыВзаимодействия.Документ
	               |ИЗ
	               |	РегистрСведений.CRM_ДокументыВзаимодействия КАК CRM_ДокументыВзаимодействия
	               |ГДЕ
	               |	CRM_ДокументыВзаимодействия.Взаимодействие = &Взаимодействие
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	CRM_ДокументыВзаимодействия.Документ.Дата";
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Документ");
КонецФункции // ПолучитьМассивДокументовВзаимодействия()	

// Функция возвращает наличие доступных учетных записей почты.
//
// Параметры:
//	Нет.
//
// Возвращаемое значение:
//	Булево	- Наличие доступных учетных записей почты.
//
Функция ПолучитьИспользованиеПочты()
	// Получение доступных учетных записей.
	Запрос = Новый Запрос;
	ТекущийПользователь = Пользователи.АвторизованныйПользователь();
	РолиПользователя = CRM_БизнесПроцессыСервер.ПолучитьРолиПоПользователю(ТекущийПользователь);
	РолиПользователя.Добавить(ТекущийПользователь);
	Запрос.УстановитьПараметр("Пользователь", РолиПользователя);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УчетныеЗаписиЭлектроннойПочты.Ссылка КАК УчетнаяЗапись
	|ИЗ
	|	Справочник.УчетныеЗаписиЭлектроннойПочты КАК УчетныеЗаписиЭлектроннойПочты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.CRM_УчетныеЗаписиЭлектроннойПочты КАК CRM_УчетныеЗаписиЭлектроннойПочты
	|		ПО (CRM_УчетныеЗаписиЭлектроннойПочты.УчетнаяЗапись = УчетныеЗаписиЭлектроннойПочты.Ссылка)
	|ГДЕ
	|	CRM_УчетныеЗаписиЭлектроннойПочты.Пользователь В (&Пользователь)
	|	И НЕ УчетныеЗаписиЭлектроннойПочты.ПометкаУдаления";
	Возврат НЕ Запрос.Выполнить().Пустой();
КонецФункции // ПолучитьИспользованиеПочты()

Функция ПолучитьТекстОПросрочке(Задача, Состояние = "")
	
	ВозвращаемыйТекст = "";
	Если Задача.СрокИсполнения < ТекущаяДатаСеанса() Тогда
		
		СекДень	= 60*60*24;
		СекЧас	= 60*60;
		СекМин	= 60;
		
		Разница = ТекущаяДатаСеанса()-Задача.СрокИсполнения;
		
		Дней = ЦЕЛ(Разница/СекДень);
		Если Дней > 0 Тогда
			Разница = Разница-(Дней*СекДень);
		КонецЕсли;
		
		Часов = ЦЕЛ(Разница/СекЧас);
		Если Часов > 0 Тогда
			Разница = Разница-(Часов*СекЧас);
		КонецЕсли;
		
		Минут = ЦЕЛ(Разница/СекМин);
		
		//ВозвращаемыйТекст = "<h6>Выполнение "+Строка(Задача.CRM_ТочкаМаршрута)+"/"+Строка(Состояние)+ " просрочено на"+
		//?(Дней>0," "+Строка(Дней)+" д.","")+?(Часов>0," "+Строка(Часов)+" ч.","")+?(Минут>0," "+Строка(Минут)+" м.","")+"</h6>";
		ВозвращаемыйТекст = "Выполнение "+Строка(Задача.CRM_ТочкаМаршрута)+"/"+Строка(Состояние)+ " просрочено на"+
		?(Дней>0," "+Строка(Дней)+" д.","")+?(Часов>0," "+Строка(Часов)+" ч.","")+?(Минут>0," "+Строка(Минут)+" м.","");
	КонецЕсли;
	
	Возврат ВозвращаемыйТекст;
	
КонецФункции

Функция ЕстьДокументыВзаимодействия(Взаимодействие) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	CRM_ДокументыВзаимодействия.Документ
	                      |ИЗ
	                      |	РегистрСведений.CRM_ДокументыВзаимодействия КАК CRM_ДокументыВзаимодействия
	                      |ГДЕ
	                      |	CRM_ДокументыВзаимодействия.Взаимодействие = &Взаимодействие");
	Запрос.УстановитьПараметр("Взаимодействие", Взаимодействие);
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции

#КонецОбласти

